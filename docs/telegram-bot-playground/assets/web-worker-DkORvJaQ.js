var bi=Object.defineProperty;var sr=g=>{throw TypeError(g)};var Si=(g,l,y)=>l in g?bi(g,l,{enumerable:!0,configurable:!0,writable:!0,value:y}):g[l]=y;var u=(g,l,y)=>Si(g,typeof l!="symbol"?l+"":l,y),or=(g,l,y)=>l.has(g)||sr("Cannot "+y);var ir=(g,l,y)=>(or(g,l,"read from private field"),y?y.call(g):l.get(g)),cr=(g,l,y)=>l.has(g)?sr("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(g):l.set(g,y),ar=(g,l,y,G)=>(or(g,l,"write to private field"),G?G.call(g,y):l.set(g,y),y);(function(){"use strict";var be,Zn,er,tr,nr,z;const g=e=>typeof e=="function",l=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(a){return t(a,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},y=e=>e,G=e=>()=>e,Pt=G(!0),Ft=G(!1),Rt=G(void 0),lr=Rt;function b(e,t,n,r,s,o,i,a,c){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return a(i(o(s(r(n(t(e)))))));case 9:return c(a(i(o(s(r(n(t(e))))))));default:{let f=arguments[0];for(let h=1;h<arguments.length;h++)f=arguments[h](f);return f}}}const fr=e=>(t,n)=>t===n||e(t,n);let hr="3.12.6";const Lt=()=>hr,Se=`effect/GlobalValue/globalStoreId/${Lt()}`;let oe;const Y=(e,t)=>(oe||(globalThis[Se]??(globalThis[Se]=new Map),oe=globalThis[Se]),oe.has(e)||oe.set(e,t()),oe.get(e)),qe=g,dr=e=>typeof e=="object"&&e!==null,Jt=e=>dr(e)||qe(e),v=l(2,(e,t)=>Jt(e)&&t in e),pr=l(2,(e,t)=>v(e,"_tag")&&e._tag===t),ze=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let Bt=class ur{constructor(t){u(this,"self");u(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new ur(this.self)}};const Ge=Symbol.for("effect/Utils/YieldWrap");class ke{constructor(t){cr(this,be);ar(this,be,t)}[Ge](){return ir(this,be)}}be=new WeakMap;function gr(e){if(typeof e=="object"&&e!==null&&Ge in e)return e[Ge]();throw new Error(ze("yieldWrapGet"))}const M=Y("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),Ye=Y(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),m=Symbol.for("effect/Hash"),_=e=>{if(M.enabled===!0)return 0;switch(typeof e){case"number":return Xe(e);case"bigint":return L(e.toString(10));case"boolean":return L(String(e));case"symbol":return L(String(e));case"string":return L(e);case"undefined":return L("undefined");case"function":case"object":return e===null?L("null"):e instanceof Date?_(e.toISOString()):yr(e)?e[m]():Ke(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},Ke=e=>(Ye.has(e)||Ye.set(e,Xe(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),Ye.get(e)),x=e=>t=>t*53^e,ve=e=>e&3221225471|e>>>1&1073741824,yr=e=>v(e,m),Xe=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return ve(t)},L=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return ve(t)},_r=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=b(L(t[r]),x(_(e[t[r]])));return ve(n)},mr=e=>_r(e,Object.keys(e)),br=e=>{let t=6151;for(let n=0;n<e.length;n++)t=b(t,x(_(e[n])));return ve(t)},T=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,m,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,m,{value(){return t},enumerable:!1}),t},S=Symbol.for("effect/Equal");function w(){return arguments.length===1?e=>we(e,arguments[0]):we(arguments[0],arguments[1])}function we(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(Ht(e)&&Ht(t))return _(e)===_(t)&&e[S](t)?!0:M.enabled&&M.tester?M.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString()}if(M.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>we(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&we(e[o],t[o])))return M.tester?M.tester(e,t):!1;return!0}}return M.tester?M.tester(e,t):!1}}return M.enabled&&M.tester?M.tester(e,t):!1}const Ht=e=>v(e,S),I=Symbol.for("nodejs.util.inspect.custom"),C=e=>{try{if(v(e,"toJSON")&&qe(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(C)}catch{return{}}return kr(e)},N=e=>JSON.stringify(e,null,2),Sr=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?Ut(e,t):String(e)}catch{return String(e)}},Ut=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(Ce.fiberRefs!==void 0&&Vt(o)?o[Qe](Ce.fiberRefs):o):o,t);return n=void 0,r},Qe=Symbol.for("effect/Inspectable/Redactable"),Vt=e=>typeof e=="object"&&e!==null&&Qe in e,Ce=Y("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),kr=e=>Vt(e)&&Ce.fiberRefs!==void 0?e[Qe](Ce.fiberRefs):e,P=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},vr="Commit",wr="Failure",Cr="WithRuntime",Or=Symbol.for("effect/Effect"),Ir=Symbol.for("effect/Stream"),Er=Symbol.for("effect/Sink"),Mr=Symbol.for("effect/Channel"),ie={_R:e=>e,_E:e=>e,_A:e=>e,_V:Lt()},Tr={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},Nr={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},ce={[Or]:ie,[Ir]:ie,[Er]:Tr,[Mr]:Nr,[S](e){return this===e},[m](){return T(this,Ke(this))},[Symbol.iterator](){return new Bt(new ke(this))},pipe(){return P(this,arguments)}},$r={[m](){return T(this,mr(this))},[S](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&w(this[r],e[r])))return!1;return!0}},Ar={...{...ce,_op:vr},...$r},Wt=Symbol.for("effect/Option"),Dt={...ce,[Wt]:{_A:e=>e},[I](){return this.toJSON()},toString(){return N(this.toJSON())}},jr=Object.assign(Object.create(Dt),{_tag:"Some",_op:"Some",[S](e){return qt(e)&&Gt(e)&&w(this.value,e.value)},[m](){return T(this,x(_(this._tag))(_(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:C(this.value)}}}),xr=_("None"),Pr=Object.assign(Object.create(Dt),{_tag:"None",_op:"None",[S](e){return qt(e)&&zt(e)},[m](){return xr},toJSON(){return{_id:"Option",_tag:this._tag}}}),qt=e=>v(e,Wt),zt=e=>e._tag==="None",Gt=e=>e._tag==="Some",Fr=Object.create(Pr),Rr=e=>{const t=Object.create(jr);return t.value=e,t},Yt=Symbol.for("effect/Either"),Kt={...ce,[Yt]:{_R:e=>e},[I](){return this.toJSON()},toString(){return N(this.toJSON())}},Lr=Object.assign(Object.create(Kt),{_tag:"Right",_op:"Right",[S](e){return Xt(e)&&Hr(e)&&w(this.right,e.right)},[m](){return x(_(this._tag))(_(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:C(this.right)}}}),Jr=Object.assign(Object.create(Kt),{_tag:"Left",_op:"Left",[S](e){return Xt(e)&&Br(e)&&w(this.left,e.left)},[m](){return x(_(this._tag))(_(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:C(this.left)}}}),Xt=e=>v(e,Yt),Br=e=>e._tag==="Left",Hr=e=>e._tag==="Right",Ur=e=>{const t=Object.create(Jr);return t.left=e,t},Oe=e=>{const t=Object.create(Lr);return t.right=e,t},Qt=Ur,$=()=>Fr,ae=Rr,F=zt,ue=Gt,Vr=l(2,(e,t)=>F(e)?t():e.value)(Rt),Wr=e=>Array.isArray(e)?e:Array.from(e),Zt=e=>Array.from(e).reverse(),Dr=l(3,(e,t,n)=>Wr(e).reduce((r,s,o)=>n(r,s,o),t)),qr=Symbol.for("effect/Context/Tag"),Ze=Symbol.for("effect/Context/Reference"),en={...ce,_op:"Tag",[Symbol.for("effect/STM")]:ie,[qr]:{_Service:e=>e,_Identifier:e=>e},toString(){return N(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[I](){return this.toJSON()},of(e){return e},context(e){return nn(this,e)}},zr={...en,[Ze]:Ze},Gr=e=>()=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;function r(){}return Object.setPrototypeOf(r,en),r.key=e,Object.defineProperty(r,"stack",{get(){return n.stack}}),r},Yr=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,zr),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},tn=Symbol.for("effect/Context"),Kr={[tn]:{_Services:e=>e},[S](e){if(Qr(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!w(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[m](){return T(this,Xe(this.unsafeMap.size))},pipe(){return P(this,arguments)},toString(){return N(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(C)}},[I](){return this.toJSON()}},et=e=>{const t=Object.create(Kr);return t.unsafeMap=e,t},Xr=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},Qr=e=>v(e,tn),nn=(e,t)=>et(new Map([[e.key,t]])),Zr=l(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),et(r)}),tt=Y("effect/Context/defaultValueCache",()=>new Map),rn=e=>{if(tt.has(e.key))return tt.get(e.key);const t=e.defaultValue();return tt.set(e.key,t),t},es=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):rn(t),ts=l(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(Ze in t)return rn(t);throw Xr(t)}return e.unsafeMap.get(t.key)}),ns=l(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return et(n)}),rs=nn,ss=Zr,os=ts,is=ns,le=Gr,sn=Yr,cs=ce,on=Symbol.for("effect/Micro"),Ie=Symbol.for("effect/Micro/MicroExit"),fe=e=>typeof e=="object"&&e!==null&&on in e,cn=Symbol.for("effect/Micro/MicroCause"),as={_E:y};class nt extends globalThis.Error{constructor(n,r,s){const o=`MicroCause.${n}`;let i,a,c;if(r instanceof globalThis.Error){i=`(${o}) ${r.name}`,a=r.message;const f=a.split(`
`).length;c=r.stack?`(${o}) ${r.stack.split(`
`).slice(0,f+3).join(`
`)}`:`${i}: ${a}`}else i=o,a=Sr(r,0),c=`${i}: ${a}`;s.length>0&&(c+=`
    ${s.join(`
    `)}`);super(a);u(this,"_tag");u(this,"traces");u(this,Zn);this._tag=n,this.traces=s,this[cn]=as,this.name=i,this.stack=c}pipe(){return P(this,arguments)}toString(){return this.stack}[(Zn=cn,I)](){return this.stack}}class us extends nt{constructor(n,r=[]){super("Fail",n,r);u(this,"error");this.error=n}}const ls=(e,t=[])=>new us(e,t);class fs extends nt{constructor(n,r=[]){super("Die",n,r);u(this,"defect");this.defect=n}}const hs=(e,t=[])=>new fs(e,t);class ds extends nt{constructor(t=[]){super("Interrupt","interrupted",t)}}const ps=(e=[])=>new ds(e),an=e=>e._tag==="Interrupt",un=Symbol.for("effect/Micro/MicroFiber"),gs={_A:y,_E:y};er=un;class ln{constructor(t,n=!0){u(this,"context");u(this,"interruptible");u(this,er);u(this,"_stack",[]);u(this,"_observers",[]);u(this,"_exit");u(this,"_children");u(this,"currentOpCount",0);u(this,"_interrupted",!1);u(this,"_yielded");this.context=t,this.interruptible=n,this[un]=gs}getRef(t){return es(this.context,t)}addObserver(t){return this._exit?(t(this._exit),lr):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(ot))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===X)return;const r=fn.interruptChildren&&fn.interruptChildren(this);if(r!==void 0)return this.evaluate(j(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(je).shouldYield(this)){n=!0;const s=r;r=j(pn,()=>s)}if(r=r[rt](this),r===X){const s=this._yielded;return Ie in s?(this._yielded=void 0,s):X}}}catch(s){return v(r,rt)?it(s):it(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[Ee]&&n[Ee](this);if(r)return{[t]:r};if(n[t])return n}}yieldWith(t){return this._yielded=t,X}children(){return this._children??(this._children=new Set)}}const fn=Y("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),ys=e=>_n(t=>Te(e.addObserver(n=>t(A(n))))),_s=e=>st(()=>(e.unsafeInterrupt(),Os(ys(e)))),hn=Symbol.for("effect/Micro/identifier"),d=Symbol.for("effect/Micro/args"),rt=Symbol.for("effect/Micro/evaluate"),J=Symbol.for("effect/Micro/successCont"),K=Symbol.for("effect/Micro/failureCont"),Ee=Symbol.for("effect/Micro/ensureCont"),X=Symbol.for("effect/Micro/Yield"),ms={_A:y,_E:y,_R:y},bs={...cs,_op:"Micro",[on]:ms,pipe(){return P(this,arguments)},[Symbol.iterator](){return new Bt(new ke(this))},toJSON(){return{_id:"Micro",op:this[hn],...d in this?{args:this[d]}:void 0}},toString(){return N(this)},[I](){return N(this)}};function Ss(e){return it("Micro.evaluate: Not implemented")}const Me=e=>({...bs,[hn]:e.op,[rt]:e.eval??Ss,[J]:e.contA,[K]:e.contE,[Ee]:e.ensure}),H=e=>{const t=Me(e);return function(){const n=Object.create(t);return n[d]=e.single===!1?arguments:arguments[0],n}},dn=e=>{const t={...Me(e),[Ie]:Ie,_tag:e.op,get[e.prop](){return this[d]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[d]}},[S](n){return Ts(n)&&n._tag===e.op&&w(this[d],n[d])},[m](){return T(this,x(L(e.op))(_(this[d])))}};return function(n){const r=Object.create(t);return r[d]=n,r[J]=void 0,r[K]=void 0,r[Ee]=void 0,r}},A=dn({op:"Success",prop:"value",eval(e){const t=e.getCont(J);return t?t[J](this[d],e):e.yieldWith(this)}}),he=dn({op:"Failure",prop:"cause",eval(e){let t=e.getCont(K);for(;an(this[d])&&t&&e.interruptible;)t=e.getCont(K);return t?t[K](this[d],e):e.yieldWith(this)}}),Q=e=>he(ls(e)),Te=H({op:"Sync",eval(e){const t=this[d](),n=e.getCont(J);return n?n[J](t,e):e.yieldWith($e(t))}}),st=H({op:"Suspend",eval(e){return this[d]()}}),pn=H({op:"Yield",eval(e){let t=!1;return e.getRef(je).scheduleTask(()=>{t||e.evaluate(ct)},this[d]??0),e.yieldWith(()=>{t=!0})}})(0),gn=A(void 0),Ne=e=>yn(function(t,n){try{e.try(n).then(r=>t(A(r)),r=>t(Q(e.catch(r))))}catch(r){t(Q(e.catch(r)))}},e.try.length!==0),de=H({op:"WithMicroFiber",eval(e){return this[d](e)}}),yn=H({op:"Async",single:!1,eval(e){const t=this[d][0];let n=!1,r=!1;const s=this[d][1]?new AbortController:void 0,o=t(i=>{n||(n=!0,r?e.evaluate(i):r=i)},s==null?void 0:s.signal);return r!==!1?r:(r=!0,e._yielded=()=>{n=!0},s===void 0&&o===void 0||e._stack.push(ks(()=>(n=!0,s==null||s.abort(),o??ct))),X)}}),ks=H({op:"AsyncFinalizer",ensure(e){e.interruptible&&(e.interruptible=!1,e._stack.push(ft(!0)))},contE(e,t){return an(e)?j(this[d](),()=>he(e)):he(e)}}),_n=e=>yn(e,e.length>=2),U=(...e)=>st(()=>vs(e.length===1?e[0]():e[1].call(e[0]))),vs=H({op:"Iterator",contA(e,t){const n=this[d].next(e);return n.done?A(n.value):(t._stack.push(this),gr(n.value))},eval(e){return this[J](void 0,e)}}),ws=l(2,(e,t)=>Ms(e,n=>t)),mn=l(2,(e,t)=>j(e,n=>{const r=fe(t)?t:typeof t=="function"?t(n):t;return fe(r)?r:A(r)})),Cs=l(2,(e,t)=>j(e,n=>{const r=fe(t)?t:typeof t=="function"?t(n):t;return fe(r)?ws(r,n):A(n)})),Os=e=>j(e,t=>ct),Is=e=>Ps(e,{onFailure:Ae,onSuccess:$e}),j=l(2,(e,t)=>{const n=Object.create(Es);return n[d]=e,n[J]=t,n}),Es=Me({op:"OnSuccess",eval(e){return e._stack.push(this),this[d]}}),Ms=l(2,(e,t)=>j(e,n=>A(t(n)))),Ts=e=>v(e,Ie),$e=A,Ae=he,ot=Ae(ps()),it=e=>Ae(hs(e)),ct=$e(void 0),Ns="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class bn{constructor(){u(this,"tasks",[]);u(this,"running",!1);u(this,"afterScheduled",()=>{this.running=!1,this.runTasks()})}scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,Ns(this.afterScheduled))}runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef($s)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const at=e=>de(t=>A(os(t.context,e))),Sn=l(2,(e,t)=>de(n=>{const r=n.context;return n.context=t(r),Rs(e,()=>(n.context=r,gn))})),ut=l(2,(e,t)=>Sn(e,is(t))),lt=l(3,(e,t,n)=>Sn(e,ss(t,n)));class $s extends sn()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class je extends sn()("effect/Micro/currentScheduler",{defaultValue:()=>new bn}){}const As=l(2,(e,t)=>st(()=>{const n=t.schedule?Date.now():0;let r=0;const s=j(Is(e),o=>{if(t.while!==void 0&&!t.while(o))return o;if(t.times!==void 0&&r>=t.times)return o;r++;let i=pn;if(t.schedule!==void 0){const a=Date.now()-n,c=t.schedule(r,a);if(F(c))return o;i=vn(c.value)}return j(i,()=>s)});return s})),js=l(e=>fe(e[0]),(e,t)=>As(e,{...t,while:n=>n._tag==="Success"&&((t==null?void 0:t.while)===void 0||t.while(n.value))})),kn=l(2,(e,t)=>{const n=Object.create(xs);return n[d]=e,n[J]=t.onSuccess,n[K]=t.onFailure,n}),xs=Me({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[d]}}),Ps=l(2,(e,t)=>kn(e,{onFailure:n=>Te(()=>t.onFailure(n)),onSuccess:n=>Te(()=>t.onSuccess(n))})),vn=e=>_n(t=>{const n=setTimeout(()=>{t(gn)},e);return Te(()=>{clearTimeout(n)})}),Fs=l(2,(e,t)=>mn(vn(t),e)),Rs=l(2,(e,t)=>Js(n=>kn(n(e),{onFailure:r=>j(t(Ae(r)),()=>he(r)),onSuccess:r=>j(t($e(r)),()=>A(r))}))),ft=H({op:"SetInterruptible",ensure(e){if(e.interruptible=this[d],e._interrupted&&e.interruptible)return()=>ot}}),Ls=e=>de(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(ft(!1)),t._interrupted?ot:e)),Js=e=>de(t=>t.interruptible?(t.interruptible=!1,t._stack.push(ft(!0)),e(Ls)):e(y)),Bs=(e,t,n=!1,r=!1)=>{const s=new ln(e.context,e.interruptible);return r||(e.children().add(s),s.addObserver(()=>e.children().delete(s))),n?s.evaluate(t):e.getRef(je).scheduleTask(()=>s.evaluate(t),0),s},Hs=e=>de(t=>A(Bs(t,e,!1,!0))),Us=(e,t)=>{const n=new ln(je.context((t==null?void 0:t.scheduler)??new bn));if(n.evaluate(e),t!=null&&t.signal)if(t.signal.aborted)n.unsafeInterrupt();else{const r=()=>n.unsafeInterrupt();t.signal.addEventListener("abort",r,{once:!0}),n.addObserver(()=>t.signal.removeEventListener("abort",r))}return n},Vs=(e,t)=>new Promise((n,r)=>{Us(e,t).addObserver(n)}),wn=(e,t)=>Vs(e,t).then(n=>{if(n._tag==="Failure")throw n.cause;return n.value}),Ws=e=>{let t=e[0];for(let n=1;n<e.length;n++)t+=e[n]==="_"?e[++n].toUpperCase():e[n];return t},Cn=Symbol.for("effect/Chunk");function Ds(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const On=[],qs=(e=>fr((t,n)=>t.length===n.length&&ye(t).every((r,s)=>e(r,Z(n,s)))))(w),zs={[Cn]:{_A:e=>e},toString(){return N(this.toJSON())},toJSON(){return{_id:"Chunk",values:ye(this).map(C)}},[I](){return this.toJSON()},[S](e){return Gs(e)&&qs(this,e)},[m](){return T(this,br(ye(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return On[Symbol.iterator]();default:return ye(this)[Symbol.iterator]()}},pipe(){return P(this,arguments)}},k=e=>{const t=Object.create(zs);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=B,t.right=B;break}case"ISingleton":{t.length=1,t.depth=0,t.left=B,t.right=B;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=B,t.right=B;break}}return t},Gs=e=>v(e,Cn),B=k({_tag:"IEmpty"}),pe=()=>B,ht=(...e)=>e.length===1?ge(e[0]):Ys(e),ge=e=>k({_tag:"ISingleton",a:e}),dt=(e,t,n)=>{switch(e.backing._tag){case"IArray":{Ds(e.backing.array,0,t,n,e.length);break}case"IConcat":{dt(e.left,t,n),dt(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=Z(e,r),r+=1,s+=1;break}}},ye=e=>{switch(e.backing._tag){case"IEmpty":return On;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return dt(e,t,0),e.backing={_tag:"IArray",array:t},e.left=B,e.right=B,e.depth=0,t}}},pt=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return k({_tag:"IArray",array:Zt(e.backing.array)});case"IConcat":return k({_tag:"IConcat",left:pt(e.backing.right),right:pt(e.backing.left)});case"ISlice":return In(Zt(ye(e)))}},In=e=>k({_tag:"IArray",array:e}),Ys=e=>In(e),Z=l(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?Z(e.left,t):Z(e.right,t-e.left.length);case"ISlice":return Z(e.backing.chunk,t+e.backing.offset)}}),En=l(2,(e,t)=>V(ge(t),e)),V=l(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return k({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=V(e.right,t);return k({_tag:"IConcat",left:e.left,right:r})}else{const r=V(e.right.right,t);if(r.depth===e.depth-3){const s=k({_tag:"IConcat",left:e.right.left,right:r});return k({_tag:"IConcat",left:e.left,right:s})}else{const s=k({_tag:"IConcat",left:e.left,right:e.right.left});return k({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=V(e,t.left);return k({_tag:"IConcat",left:r,right:t.right})}else{const r=V(e,t.left.left);if(r.depth===t.depth-3){const s=k({_tag:"IConcat",left:r,right:t.left.right});return k({_tag:"IConcat",left:s,right:t.right})}else{const s=k({_tag:"IConcat",left:t.left.right,right:t.right});return k({_tag:"IConcat",left:r,right:s})}}}),Ks=e=>e.length===0,Mn=e=>e.length>0,Tn=e=>Z(e,0),D=5,gt=Math.pow(2,D),Xs=gt-1,Qs=gt/2,Zs=gt/4;function eo(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function ee(e,t){return t>>>e&Xs}function te(e){return 1<<e}function Nn(e,t){return eo(e&t-1)}const to=(e,t)=>({value:e,previous:t});function ne(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function $n(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function no(e,t,n,r){const s=r.length;if(e){let c=s;for(;c>=t;)r[c--]=r[c];return r[t]=n,r}let o=0,i=0;const a=new Array(s+1);for(;o<t;)a[i++]=r[o++];for(a[t]=n;o<s;)a[++i]=r[o++];return a}class W{constructor(){u(this,"_tag","EmptyNode")}modify(t,n,r,s,o,i){const a=r($());return F(a)?new W:(++i.value,new q(t,s,o,a))}}function R(e){return pr(e,"EmptyNode")}function ro(e){return R(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function xe(e,t){return R(e)?!1:t===e.edit}class q{constructor(t,n,r,s){u(this,"edit");u(this,"hash");u(this,"key");u(this,"value");u(this,"_tag","LeafNode");this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(w(o,this.key)){const c=r(this.value);return c===this.value?this:F(c)?(--i.value,new W):xe(this,t)?(this.value=c,this):new q(t,s,o,c)}const a=r($());return F(a)?this:(++i.value,An(t,n,this.hash,this,s,new q(t,s,o,a)))}}class yt{constructor(t,n,r){u(this,"edit");u(this,"hash");u(this,"children");u(this,"_tag","CollisionNode");this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const c=xe(this,t),f=this.updateCollisionList(c,t,this.hash,this.children,r,o,i);return f===this.children?this:f.length>1?new yt(t,this.hash,f):f[0]}const a=r($());return F(a)?this:(++i.value,An(t,n,this.hash,this,s,new q(t,s,o,a)))}updateCollisionList(t,n,r,s,o,i,a){const c=s.length;for(let h=0;h<c;++h){const p=s[h];if("key"in p&&w(i,p.key)){const E=p.value,O=o(E);return O===E?s:F(O)?(--a.value,$n(t,h,s)):ne(t,h,new q(n,r,i,O),s)}}const f=o($());return F(f)?s:(++a.value,ne(t,c,new q(n,r,i,f),s))}}class re{constructor(t,n,r){u(this,"edit");u(this,"mask");u(this,"children");u(this,"_tag","IndexedNode");this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const a=this.mask,c=this.children,f=ee(n,s),h=te(f),p=Nn(a,h),E=a&h,O=xe(this,t);if(!E){const xt=new W().modify(t,n+D,r,s,o,i);return xt?c.length>=Qs?oo(t,f,xt,a,c):new re(t,a|h,no(O,p,xt,c)):this}const rr=c[p],jt=rr.modify(t,n+D,r,s,o,i);if(rr===jt)return this;let We=a,De;if(R(jt)){if(We&=~h,!We)return new W;if(c.length<=2&&ro(c[p^1]))return c[p^1];De=$n(O,p,c)}else De=ne(O,p,jt,c);return O?(this.mask=We,this.children=De,this):new re(t,We,De)}}class _t{constructor(t,n,r){u(this,"edit");u(this,"size");u(this,"children");u(this,"_tag","ArrayNode");this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let a=this.size;const c=this.children,f=ee(n,s),h=c[f],p=(h||new W).modify(t,n+D,r,s,o,i);if(h===p)return this;const E=xe(this,t);let O;if(R(h)&&!R(p))++a,O=ne(E,f,p,c);else if(!R(h)&&R(p)){if(--a,a<=Zs)return so(t,a,f,c);O=ne(E,f,new W,c)}else O=ne(E,f,p,c);return E?(this.size=a,this.children=O,this):new _t(t,a,O)}}function so(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let a=0,c=r.length;a<c;++a)if(a!==n){const f=r[a];f&&!R(f)&&(s[o++]=f,i|=1<<a)}return new re(e,i,s)}function oo(e,t,n,r,s){const o=[];let i=r,a=0;for(let c=0;i;++c)i&1&&(o[c]=s[a++]),i>>>=1;return o[t]=n,new _t(e,a+1,o)}function io(e,t,n,r,s,o){if(n===s)return new yt(e,n,[o,r]);const i=ee(t,n),a=ee(t,s);if(i===a)return c=>new re(e,te(i)|te(a),[c]);{const c=i<a?[r,o]:[o,r];return new re(e,te(i)|te(a),c)}}function An(e,t,n,r,s,o){let i,a=t;for(;;){const c=io(e,a,n,r,s,o);if(typeof c=="function")i=to(c,i),a=a+D;else{let f=c;for(;i!=null;)f=i.value(f),i=i.previous;return f}}}const jn="effect/HashMap",mt=Symbol.for(jn),co={[mt]:mt,[Symbol.iterator](){return new Pe(this,(e,t)=>[e,t])},[m](){let e=_(jn);for(const t of this)e^=b(_(t[0]),x(_(t[1])));return T(this,e)},[S](e){if(lo(e)){if(e._size!==this._size)return!1;for(const t of this){const n=b(e,fo(t[0],_(t[0])));if(F(n))return!1;if(!w(t[1],n.value))return!1}return!0}return!1},toString(){return N(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(C)}},[I](){return this.toJSON()},pipe(){return P(this,arguments)}},bt=(e,t,n,r)=>{const s=Object.create(co);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Pe{constructor(t,n){u(this,"map");u(this,"f");u(this,"v");this.map=t,this.f=n,this.v=xn(this.map._root,this.f,void 0)}next(){if(F(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=Fe(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Pe(this.map,this.f)}}const Fe=e=>e?Pn(e[0],e[1],e[2],e[3],e[4]):$(),xn=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return ue(e.value)?ae({value:t(e.key,e.value.value),cont:n}):Fe(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return Pn(r.length,r,0,t,n)}default:return Fe(n)}},Pn=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!R(o))return xn(o,r,[e,t,n,r,s])}return Fe(s)},ao=bt(!1,0,new W,0),uo=()=>ao,lo=e=>v(e,mt),fo=l(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return w(t,r.key)?r.value:$();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,a=o.length;i<a;++i){const c=o[i];if("key"in c&&w(t,c.key))return c.value}}return $()}case"IndexedNode":{const o=ee(s,n),i=te(o);if(r.mask&i){r=r.children[Nn(r.mask,i)],s+=D;break}return $()}case"ArrayNode":{if(r=r.children[ee(s,n)],r){s+=D;break}return $()}default:return $()}}),Fn=l(3,(e,t,n)=>yo(e,t,()=>ae(n))),ho=l(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:bt(e._editable,e._edit,t,n)),po=e=>new Pe(e,t=>t),St=e=>e._size,go=e=>bt(!0,e._edit+1,e._root,e._size),yo=l(3,(e,t,n)=>_o(e,t,_(t),n)),_o=l(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return b(e,ho(o,s.value))}),mo=l(2,(e,t)=>bo(e,void 0,(n,r,s)=>t(r,s))),bo=l(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return ue(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,a=o.length;i<a;){const c=o[i++];c&&!R(c)&&(c._tag==="LeafNode"?ue(c.value)&&(t=n(t,c.value.value,c.key)):s.push(c.children))}return t}),Rn="effect/HashSet",kt=Symbol.for(Rn),So={[kt]:kt,[Symbol.iterator](){return po(this._keyMap)},[m](){return T(this,x(_(this._keyMap))(_(Rn)))},[S](e){return ko(e)?St(this._keyMap)===St(e._keyMap)&&w(this._keyMap,e._keyMap):!1},toString(){return N(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(C)}},[I](){return this.toJSON()},pipe(){return P(this,arguments)}},vt=e=>{const t=Object.create(So);return t._keyMap=e,t},ko=e=>v(e,kt),vo=vt(uo()),Ln=()=>vo,wo=e=>St(e._keyMap),Co=e=>vt(go(e._keyMap)),Oo=e=>(e._keyMap._editable=!1,e),Io=l(2,(e,t)=>{const n=Co(e);return t(n),Oo(n)}),wt=l(2,(e,t)=>e._keyMap._editable?(Fn(t,!0)(e._keyMap),e):vt(Fn(t,!0)(e._keyMap))),Eo=l(2,(e,t)=>Io(Ln(),n=>{Mo(e,r=>wt(n,r));for(const r of t)wt(n,r)})),Mo=l(2,(e,t)=>mo(e._keyMap,(n,r)=>t(r))),Re=Ln,To=wo,Ct=wt,Ot=Eo,Jn="Die",It="Empty",Et="Fail",Bn="Interrupt",_e="Parallel",me="Sequential",Hn="effect/Cause",Un=Symbol.for(Hn),No={_E:e=>e},Mt={[Un]:No,[m](){return b(_(Hn),x(_(Po(this))),T(this))},[S](e){return Ao(e)&&xo(this,e)},pipe(){return P(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:C(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:C(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:C(this.left),right:C(this.right)}}},toString(){return zn(this)},[I](){return this.toJSON()}},Tt=e=>{const t=Object.create(Mt);return t._tag=Et,t.error=e,t},$o=(e,t)=>{const n=Object.create(Mt);return n._tag=_e,n.left=e,n.right=t,n},Le=(e,t)=>{const n=Object.create(Mt);return n._tag=me,n.left=e,n.right=t,n},Ao=e=>v(e,Un),jo=e=>qn(void 0,Ro)(e),xo=(e,t)=>{let n=ge(e),r=ge(t);for(;Mn(n)&&Mn(r);){const[s,o]=b(Tn(n),Dn([Re(),pe()],([c,f],h)=>{const[p,E]=Nt(h);return ae([b(c,Ot(p)),b(f,V(E))])})),[i,a]=b(Tn(r),Dn([Re(),pe()],([c,f],h)=>{const[p,E]=Nt(h);return ae([b(c,Ot(p)),b(f,V(E))])}));if(!w(s,i))return!1;n=o,r=a}return!0},Po=e=>Fo(ge(e),pe()),Fo=(e,t)=>{for(;;){const[n,r]=b(e,Dr([Re(),pe()],([o,i],a)=>{const[c,f]=Nt(a);return[b(o,Ot(c)),b(i,V(f))]})),s=To(n)>0?b(t,En(n)):t;if(Ks(r))return pt(s);e=r,t=s}throw new Error(ze("Cause.flattenCauseLoop"))},Nt=e=>{let t=e;const n=[];let r=Re(),s=pe();for(;t!==void 0;)switch(t._tag){case It:{if(n.length===0)return[r,s];t=n.pop();break}case Et:{if(r=Ct(r,ht(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case Jn:{if(r=Ct(r,ht(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Bn:{if(r=Ct(r,ht(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case me:{switch(t.left._tag){case It:{t=t.right;break}case me:{t=Le(t.left.left,Le(t.left.right,t.right));break}case _e:{t=$o(Le(t.left.left,t.right),Le(t.left.right,t.right));break}default:{s=En(s,t.right),t=t.left;break}}break}case _e:{n.push(t.right),t=t.left;break}}throw new Error(ze("Cause.evaluateCauseLoop"))},Ro={emptyCase:Pt,failCase:Ft,dieCase:Ft,interruptCase:Pt,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},Vn="SequentialCase",Wn="ParallelCase",Dn=l(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=ue(i)?i.value:r,s._tag){case me:{o.push(s.right),s=s.left;break}case _e:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),qn=l(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case It:{s.push(Oe(n.emptyCase(t)));break}case Et:{s.push(Oe(n.failCase(t,i.error)));break}case Jn:{s.push(Oe(n.dieCase(t,i.defect)));break}case Bn:{s.push(Oe(n.interruptCase(t,i.fiberId)));break}case me:{r.push(i.right),r.push(i.left),s.push(Qt({_tag:Vn}));break}case _e:{r.push(i.right),r.push(i.left),s.push(Qt({_tag:Wn}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case Vn:{const a=o.pop(),c=o.pop(),f=n.sequentialCase(t,a,c);o.push(f);break}case Wn:{const a=o.pop(),c=o.pop(),f=n.parallelCase(t,a,c);o.push(f);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),zn=(e,t)=>jo(e)?"All fibers interrupted without errors.":Uo(e).map(function(n){return(t==null?void 0:t.renderErrorCause)!==!0||n.cause===void 0?n.stack:`${n.stack} {
${Gn(n.cause,"  ")}
}`}).join(`
`),Gn=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${Gn(e.cause,`${t}  `)}
${t}}`),r};class Je extends globalThis.Error{constructor(n){const r=typeof n=="object"&&n!==null,s=Error.stackTraceLimit;Error.stackTraceLimit=1;super(Lo(n),r&&"cause"in n&&typeof n.cause<"u"?{cause:new Je(n.cause)}:void 0);u(this,"span");this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=s,this.name=n instanceof Error?n.name:"Error",r&&(Yn in n&&(this.span=n[Yn]),Object.keys(n).forEach(o=>{o in this||(this[o]=n[o])})),this.stack=Ho(`${this.name}: ${this.message}`,n instanceof Error&&n.stack?n.stack:"",this.span)}}const Lo=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(v(e,"toString")&&qe(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return Ut(e)},Jo=/\((.*)\)/g,Bo=Y("effect/Tracer/spanToTrace",()=>new WeakMap),Ho=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length&&!s[o].includes("Generator.next");o++){if(s[o].includes("effect_internal_function")){r.pop();break}r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const a=Bo.get(o);if(typeof a=="function"){const c=a();if(typeof c=="string"){const f=c.matchAll(Jo);let h=!1;for(const[,p]of f)h=!0,r.push(`    at ${o.name} (${p})`);h||r.push(`    at ${o.name} (${c.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=Vr(o.parent),i++}}return r.join(`
`)},Yn=Symbol.for("effect/SpanAnnotation"),Uo=e=>qn(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new Je(n)],failCase:(t,n)=>[new Je(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]});class Be{constructor(t){u(this,"self");u(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Be(this.self)}}const $t=Symbol.for("effect/Effect");class Vo{constructor(t){u(this,"_op");u(this,"effect_instruction_i0");u(this,"effect_instruction_i1");u(this,"effect_instruction_i2");u(this,"trace");u(this,tr,ie);this._op=t}[(tr=$t,S)](t){return this===t}[m](){return T(this,Ke(this))}pipe(){return P(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:C(this.effect_instruction_i0),effect_instruction_i1:C(this.effect_instruction_i1),effect_instruction_i2:C(this.effect_instruction_i2)}}toString(){return N(this.toJSON())}[I](){return this.toJSON()}[Symbol.iterator](){return new Be(new ke(this))}}class Wo{constructor(t){u(this,"_op");u(this,"effect_instruction_i0");u(this,"effect_instruction_i1");u(this,"effect_instruction_i2");u(this,"trace");u(this,nr,ie);this._op=t,this._tag=t}[(nr=$t,S)](t){return Ko(t)&&t._op==="Failure"&&w(this.effect_instruction_i0,t.effect_instruction_i0)}[m](){return b(L(this._tag),x(_(this.effect_instruction_i0)),T(this))}get cause(){return this.effect_instruction_i0}pipe(){return P(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return N(this.toJSON())}[I](){return this.toJSON()}[Symbol.iterator](){return new Be(new ke(this))}}const Do=e=>v(e,$t),qo=e=>{const t=new Vo(Cr);return t.effect_instruction_i0=e,t},At=Symbol.for("effect/SpanAnnotation"),Kn=Symbol.for("effect/OriginalAnnotation"),zo=(e,t)=>ue(t)?new Proxy(e,{has(n,r){return r===At||r===Kn||r in n},get(n,r){return r===At?t.value:r===Kn?e:n[r]}}):e,Go=e=>Jt(e)&&!(At in e)?qo(t=>Xn(Tt(zo(e,Xo(t))))):Xn(Tt(e)),Xn=e=>{const t=new Wo(wr);return t.effect_instruction_i0=e,t},Yo=function(){class e extends globalThis.Error{commit(){return Go(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[I](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?zn(Tt(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,Ar),e}(),Ko=e=>Do(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),Xo=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?ae(t):$()},Qo=function(){const e=Symbol.for("effect/Data/Error/plainArgs");return class extends Yo{constructor(n){super(n==null?void 0:n.message,n!=null&&n.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}(),Zo=e=>{class t extends Qo{constructor(){super(...arguments);u(this,"_tag",e)}}return t.prototype.name=e,t};var He=class extends le("BotMessageHandler")(){},ei=e=>{let t=e.batch_size??10,n=e.timeout??10,r=e.max_empty_responses,s=e.update_types,o=e.log_level;return(t<10||t>100)&&(console.warn("Wrong limit, must be in [10..100], using 10 instead"),t=10),(n<2||n>10)&&(console.warn("Wrong timeout, must be in [2..10], using 2 instead"),t=10),r&&r<2&&(console.warn("Wrong max_empty_responses, must be in [2..infinity], using infinity"),r=void 0),r&&r<2&&(console.warn("Wrong max_empty_responses, must be in [2..infinity], using infinity"),r=void 0),s||(console.info("Handling only messages, ignoring others"),s=["message"]),o||(o="info"),{limit:t,timeout:n,max_empty_responses:r,update_types:s,log_level:o}},ti=e=>{for(const[t,n]of Object.entries(e))if(t!="update_id")return{type:t,...n}},se=(z=class extends Zo("TgBotClientError"){},u(z,"missingSuccess",new z({reason:{type:"ClientInternalError",cause:"Expected 'success' to be defined"}})),z),ni="https://api.telegram.org",Qn=e=>Ue.of({...e,base_url:e.base_url??ni}),Ue=class extends le("TgBotClientConfig")(){},ri=e=>typeof e=="object"&&e!=null&&"file_content"in e&&e.file_content instanceof Uint8Array&&"file_name"in e&&typeof e.file_name=="string",si=e=>typeof e=="object"&&e!=null&&"ok"in e&&typeof e.ok=="boolean",oi=e=>typeof e=="object"&&e!=null&&"bot_token"in e&&typeof e.bot_token=="string",ii=e=>{const t=Object.entries(e);if(t.length==0)return;const n=new FormData;for(const[r,s]of t)s&&(typeof s!="object"?n.append(r,`${s}`):ri(s)?n.append(r,new Blob([s.file_content]),s.file_name):n.append(r,JSON.stringify(s)));return n},Ve=(e,t)=>U(function*(){const n=yield*at(Ue),r=yield*Ne({try:()=>fetch(`${n.base_url}/bot${n.bot_token}/${Ws(e)}`,{body:ii(t)??null,method:"POST"}),catch:o=>new se({reason:{type:"ClientInternalError",cause:o}})}),s=yield*Ne({try:()=>r.json(),catch:()=>new se({reason:{type:"UnexpectedResponse",response:r}})});return si(s)?r.ok?s.result:yield*Q(new se({reason:{type:"NotOkResponse",...s.error_code?{errorCode:s.error_code}:void 0,...s.description?{details:s.description}:void 0}})):yield*Q(new se({reason:{type:"UnexpectedResponse",response:s}}))}),ci=({state:e,settings:t,handlers:n})=>U(function*(){const r=e.lastUpdateId;t.log_level=="debug"&&console.debug("getting updates",e);const s=yield*Ve("get_updates",{...t,...r?{offset:r}:void 0}).pipe(mn(a=>a.sort(c=>c.update_id)));let o,i=!1;for(const a of s){const c=ti(a);if(!c){console.warn("Unknown update",c),i=!0;break}const f=n[`on_${c.type}`];if(!f)if(t.update_types.includes(c.type)){console.error("Handler for update not defined",c),i=!0;break}else{t.log_level=="debug"&&console.debug("Ignored update",c),o=a.update_id;continue}c.type=="message"&&"text"in c&&console.info("Got new message",{chatId:c.chat.id,chatType:c.chat.type,message:`${c.text.slice(0,5)}...`});const h=f(c);if("chat"in c&&h){const p=yield*Ve(`send_${h.type}`,{...h,chat_id:c.chat.id});t.log_level=="debug"&&console.debug("bot response",p)}!h&&t.log_level=="debug"&&console.debug("handler returned no response for update",{update:c}),o=a.update_id}return i&&o&&(yield*Ve("get_updates",{offset:o,limit:0}),t.log_level=="debug"&&console.debug("committed offset",o)),{updates:s,lastSuccessId:o,hasError:i}}),ai=e=>{const t={lastUpdateId:void 0,emptyResponses:0},n=ei(e.settings);return Fs(1e3)(ci({state:t,settings:n,handlers:e.settings})).pipe(js({while:({updates:r,lastSuccessId:s,hasError:o})=>{if(o)return console.info("error in handler, quitting"),!1;if(r.length==0){if(t.emptyResponses+=1,n.max_empty_responses&&t.emptyResponses>n.max_empty_responses)return console.info("too many empty responses, quitting"),!1}else t.emptyResponses=0;return s&&(t.lastUpdateId=s+1),!0}}))};(class extends le("BotUpdatePollerService")(){});var ui=U(function*(){console.log("Initiating BotUpdatesPollerServiceDefault");const e={fiber:void 0};return{runBot:U(function*(){console.log("run bot");const n=yield*at(He),r=ai({settings:n}).pipe(Hs,Cs(s=>s.addObserver(o=>{console.log("bot's fiber has been closed",o)})));e.fiber&&(console.log("killing previous bot's fiber"),yield*_s(e.fiber)),e.fiber=yield*r,console.log("Fetching bot updates via long polling...")}),getFiber:()=>e.fiber}}),li=e=>U(function*(){if(e.type=="config")return Qn(e);const t=yield*Ne({try:async()=>{const{readFileSync:n}=await Promise.resolve().then(function(){return mi});return JSON.parse(await n("config.json","utf-8"))},catch:n=>(console.warn("invalid tg bot config",n),"ReadingConfigError")});return oi(t)?Qn(t):yield*Q("InvalidConfig")});(class extends le("BotFactoryService")(){});var fi={runBot:e=>U(function*(){const t=rs(Ue,yield*li(e)),n=yield*ui.pipe(ut(t));return yield*n.runBot.pipe(lt(He,e),ut(t)),{reload:s=>n.runBot.pipe(lt(He,s),ut(t),wn),fiber:n.getFiber}})},hi=e=>fi.runBot(e).pipe(lt(He,e),wn),di=e=>U(function*(){const t=yield*Ve("get_file",{file_id:e}),n=yield*at(Ue),r=t.file_path;if(!r||r.length==0)return yield*Q(new se({reason:{type:"UnableToGetFile",cause:"File path not defined"}}));const s=r.replaceAll("/","-"),o=`${n.base_url}/file/bot${n.bot_token}/${r}`,i=yield*Ne({try:()=>fetch(o).then(c=>c.arrayBuffer()),catch:c=>new se({reason:{type:"UnableToGetFile",cause:c}})});return new File([new Uint8Array(i)],s)});(class extends le("ClientFileService")(){}),U(function*(){return{getFile:e=>di(e.file_id)}});const pi=e=>typeof e=="object"&&e!=null&&"command"in e&&"token"in e&&"code"in e,gi=e=>{try{return{parsed:JSON.parse(e)}}catch{return}},yi=e=>{const t=[],n=gi(e);if(typeof(n==null?void 0:n.parsed)=="object"){for(const[r,s]of Object.entries(n.parsed))try{const o=new Function(`return ${s}`)();t.push([r,o])}catch(o){console.warn("deserialize field error",{k:r,v:s,e:o})}return Object.fromEntries(t)}},_i=(e=>{let t=0,n;const r=s=>e({...s,messageId:t++});return async s=>{var o;if(!pi(s)){r({error:"not a run bot command",command:s});return}if(s.command=="run-bot"){const i=yi(s.code);if(console.log("worker got run-bot command",i),n){console.log("reloading..."),await n.reload({...i}),r({botState:{status:"reloaded"}});return}n=await hi({type:"config",bot_token:s.token,...i}),(o=n.fiber())==null||o.addObserver(a=>{r({success:"Bot's fiber has been shutdown",exit:a,botState:{status:"stopped"}})}),r({success:"Bot's fiber has been created",botState:{status:"active"}});return}r({error:"Unknown command"})}})(e=>self.postMessage(e));self.onmessage=e=>_i(e.data);var mi=Object.freeze({__proto__:null})})();
