var ko=Object.defineProperty;var Mn=g=>{throw TypeError(g)};var wo=(g,u,v)=>u in g?ko(g,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):g[u]=v;var c=(g,u,v)=>wo(g,typeof u!="symbol"?u+"":u,v),An=(g,u,v)=>u.has(g)||Mn("Cannot "+v);var Tn=(g,u,v)=>(An(g,u,"read from private field"),v?v.call(g):u.get(g)),$n=(g,u,v)=>u.has(g)?Mn("Cannot add the same private member more than once"):u instanceof WeakSet?u.add(g):u.set(g,v),Jn=(g,u,v,re)=>(An(g,u,"write to private field"),re?re.call(g,v):u.set(g,v),v);(function(){"use strict";var xe,Cn,In,xn,Nn,jn,q,X;var g=e=>typeof e=="function",u=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):r=>t(r,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(r,n){return arguments.length>=2?t(r,n):function(i){return t(i,r)}};case 3:return function(r,n,i){return arguments.length>=3?t(r,n,i):function(a){return t(a,r,n)}};case 4:return function(r,n,i,a){return arguments.length>=4?t(r,n,i,a):function(s){return t(s,r,n,i)}};case 5:return function(r,n,i,a,s){return arguments.length>=5?t(r,n,i,a,s):function(o){return t(o,r,n,i,a)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);let r=arguments;return function(n){return t(n,...r)}}}},v=e=>e,re=e=>()=>e,Vt=re(!0),qt=re(!1),Gt=re(void 0),Dn=Gt;function k(e,t,r,n,i,a,s,o,l){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return r(t(e));case 4:return n(r(t(e)));case 5:return i(n(r(t(e))));case 6:return a(i(n(r(t(e)))));case 7:return s(a(i(n(r(t(e))))));case 8:return o(s(a(i(n(r(t(e)))))));case 9:return l(o(s(a(i(n(r(t(e))))))));default:{let f=arguments[0];for(let d=1;d<arguments.length;d++)f=arguments[d](f);return f}}}var Hn=e=>(t,r)=>t===r||e(t,r),Vn="3.12.0",Yt=()=>Vn,tt=Symbol.for(`effect/GlobalValue/globalStoreId/${Yt()}`);tt in globalThis||(globalThis[tt]=new Map);var rt=globalThis[tt],ne=(e,t)=>(rt.has(e)||rt.set(e,t()),rt.get(e)),nt=g,qn=e=>typeof e=="object"&&e!==null,Kt=e=>qn(e)||nt(e),C=u(2,(e,t)=>Kt(e)&&t in e),Gn=u(2,(e,t)=>C(e,"_tag")&&e._tag===t),it=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`,Xt=class Fn{constructor(t){c(this,"self");c(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Fn(this.self)}},at=Symbol.for("effect/Utils/YieldWrap"),Ae=(Cn=class{constructor(e){$n(this,xe);Jn(this,xe,e)}[at](){return Tn(this,xe)}},xe=new WeakMap,Cn);function Yn(e){if(typeof e=="object"&&e!==null&&at in e)return e[at]();throw new Error(it("yieldWrapGet"))}var N=ne("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),st=ne(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),b=Symbol.for("effect/Hash"),y=e=>{if(N.enabled===!0)return 0;switch(typeof e){case"number":return lt(e);case"bigint":return U(e.toString(10));case"boolean":return U(String(e));case"symbol":return U(String(e));case"string":return U(e);case"undefined":return U("undefined");case"function":case"object":return e===null?U("null"):e instanceof Date?y(e.toISOString()):Kn(e)?e[b]():ot(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},ot=e=>(st.has(e)||st.set(e,lt(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),st.get(e)),J=e=>t=>t*53^e,Te=e=>e&3221225471|e>>>1&1073741824,Kn=e=>C(e,b),lt=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Te(t)},U=e=>{let t=5381,r=e.length;for(;r;)t=t*33^e.charCodeAt(--r);return Te(t)},Xn=(e,t)=>{let r=12289;for(let n=0;n<t.length;n++)r^=k(U(t[n]),J(y(e[t[n]])));return Te(r)},Zn=e=>Xn(e,Object.keys(e)),Zt=e=>{let t=6151;for(let r=0;r<e.length;r++)t=k(t,J(y(e[r])));return Te(t)},j=function(){if(arguments.length===1){let r=arguments[0];return function(n){return Object.defineProperty(r,b,{value(){return n},enumerable:!1}),n}}let e=arguments[0],t=arguments[1];return Object.defineProperty(e,b,{value(){return t},enumerable:!1}),t},w=Symbol.for("effect/Equal");function O(){return arguments.length===1?e=>$e(e,arguments[0]):$e(arguments[0],arguments[1])}function $e(e,t){if(e===t)return!0;let r=typeof e;if(r!==typeof t)return!1;if(r==="object"||r==="function"){if(e!==null&&t!==null){if(Qt(e)&&Qt(t))return y(e)===y(t)&&e[w](t)?!0:N.enabled&&N.tester?N.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString()}if(N.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((n,i)=>$e(n,t[i]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){let n=Object.keys(e),i=Object.keys(t);if(n.length===i.length){for(let a of n)if(!(a in t&&$e(e[a],t[a])))return N.tester?N.tester(e,t):!1;return!0}}return N.tester?N.tester(e,t):!1}}return N.enabled&&N.tester?N.tester(e,t):!1}var Qt=e=>C(e,w),x=Symbol.for("nodejs.util.inspect.custom"),I=e=>{try{if(C(e,"toJSON")&&nt(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(I)}catch{return{}}return ei(e)},A=e=>JSON.stringify(e,null,2),Qn=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?er(e,t):String(e)}catch{return String(e)}},er=(e,t)=>{let r=[],n=JSON.stringify(e,(i,a)=>typeof a=="object"&&a!==null?r.includes(a)?void 0:r.push(a)&&(Je.fiberRefs!==void 0&&tr(a)?a[ut](Je.fiberRefs):a):a,t);return r=void 0,n},ut=Symbol.for("effect/Inspectable/Redactable"),tr=e=>typeof e=="object"&&e!==null&&ut in e,Je=ne("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),ei=e=>tr(e)&&Je.fiberRefs!==void 0?e[ut](Je.fiberRefs):e,F=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let r=e;for(let n=0,i=t.length;n<i;n++)r=t[n](r);return r}}},ti="Commit",ri="Failure",ni="WithRuntime",ii=Symbol.for("effect/Effect"),ai=Symbol.for("effect/Stream"),si=Symbol.for("effect/Sink"),oi=Symbol.for("effect/Channel"),ge={_R:e=>e,_E:e=>e,_A:e=>e,_V:Yt()},li={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},ui={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},ve={[ii]:ge,[ai]:ge,[si]:li,[oi]:ui,[w](e){return this===e},[b](){return j(this,ot(this))},[Symbol.iterator](){return new Xt(new Ae(this))},pipe(){return F(this,arguments)}},rr={[b](){return j(this,Zn(this))},[w](e){let t=Object.keys(this),r=Object.keys(e);if(t.length!==r.length)return!1;for(let n of t)if(!(n in e&&O(this[n],e[n])))return!1;return!0}},ci={...ve,_op:ti},fi={...ci,...rr},nr=Symbol.for("effect/Option"),ir={...ve,[nr]:{_A:e=>e},[x](){return this.toJSON()},toString(){return A(this.toJSON())}},hi=Object.assign(Object.create(ir),{_tag:"Some",_op:"Some",[w](e){return ar(e)&&or(e)&&O(this.value,e.value)},[b](){return j(this,J(y(this._tag))(y(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:I(this.value)}}}),di=y("None"),pi=Object.assign(Object.create(ir),{_tag:"None",_op:"None",[w](e){return ar(e)&&sr(e)},[b](){return di},toJSON(){return{_id:"Option",_tag:this._tag}}}),ar=e=>C(e,nr),sr=e=>e._tag==="None",or=e=>e._tag==="Some",gi=Object.create(pi),vi=e=>{let t=Object.create(hi);return t.value=e,t},lr=Symbol.for("effect/Either"),ur={...ve,[lr]:{_R:e=>e},[x](){return this.toJSON()},toString(){return A(this.toJSON())}},yi=Object.assign(Object.create(ur),{_tag:"Right",_op:"Right",[w](e){return cr(e)&&mi(e)&&O(this.right,e.right)},[b](){return J(y(this._tag))(y(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:I(this.right)}}}),bi=Object.assign(Object.create(ur),{_tag:"Left",_op:"Left",[w](e){return cr(e)&&_i(e)&&O(this.left,e.left)},[b](){return J(y(this._tag))(y(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:I(this.left)}}}),cr=e=>C(e,lr),_i=e=>e._tag==="Left",mi=e=>e._tag==="Right",Si=e=>{let t=Object.create(bi);return t.left=e,t},ki=e=>{let t=Object.create(yi);return t.right=e,t},Fe=ki,fr=Si,T=()=>gi,ye=vi,R=sr,be=or,wi=u(2,(e,t)=>R(e)?t():e.value),Oi=wi(Gt),hr=e=>Array.isArray(e)?e:Array.from(e),dr=e=>Array.from(e).reverse(),Ei=u(3,(e,t,r)=>hr(e).reduce((n,i,a)=>r(n,i,a),t)),Ci=Symbol.for("effect/Context/Tag"),ct=Symbol.for("effect/Context/Reference"),Ii="effect/STM",xi=Symbol.for(Ii),pr={...ve,_op:"Tag",[xi]:ge,[Ci]:{_Service:e=>e,_Identifier:e=>e},toString(){return A(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[x](){return this.toJSON()},of(e){return e},context(e){return vr(this,e)}},Ni={...pr,[ct]:ct},ji=e=>()=>{let t=Error.stackTraceLimit;Error.stackTraceLimit=2;let r=new Error;Error.stackTraceLimit=t;function n(){}return Object.setPrototypeOf(n,pr),n.key=e,Object.defineProperty(n,"stack",{get(){return r.stack}}),n},Mi=()=>(e,t)=>{let r=Error.stackTraceLimit;Error.stackTraceLimit=2;let n=new Error;Error.stackTraceLimit=r;function i(){}return Object.setPrototypeOf(i,Ni),i.key=e,i.defaultValue=t.defaultValue,Object.defineProperty(i,"stack",{get(){return n.stack}}),i},gr=Symbol.for("effect/Context"),Ai={[gr]:{_Services:e=>e},[w](e){if($i(e)&&this.unsafeMap.size===e.unsafeMap.size){for(let t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!O(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[b](){return j(this,lt(this.unsafeMap.size))},pipe(){return F(this,arguments)},toString(){return A(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(I)}},[x](){return this.toJSON()}},ft=e=>{let t=Object.create(Ai);return t.unsafeMap=e,t},Ti=e=>{let t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){let r=e.stack.split(`
`);if(r.length>2){let n=r[2].match(/at (.*)/);n&&(t.message=t.message+` (defined at ${n[1]})`)}}if(t.stack){let r=t.stack.split(`
`);r.splice(1,3),t.stack=r.join(`
`)}return t},$i=e=>C(e,gr),vr=(e,t)=>ft(new Map([[e.key,t]])),Ji=u(3,(e,t,r)=>{let n=new Map(e.unsafeMap);return n.set(t.key,r),ft(n)}),ht=ne("effect/Context/defaultValueCache",()=>new Map),yr=e=>{if(ht.has(e.key))return ht.get(e.key);let t=e.defaultValue();return ht.set(e.key,t),t},Fi=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):yr(t),Ri=u(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(ct in t)return yr(t);throw Ti(t)}return e.unsafeMap.get(t.key)}),Li=u(2,(e,t)=>{let r=new Map(e.unsafeMap);for(let[n,i]of t.unsafeMap)r.set(n,i);return ft(r)}),Bi=vr,Ui=Ji,Pi=Ri,zi=Li,dt=ji,ie=Mi,Wi=ve,br=Symbol.for("effect/Micro"),Re=Symbol.for("effect/Micro/MicroExit"),_e=e=>typeof e=="object"&&e!==null&&br in e,_r=Symbol.for("effect/Micro/MicroCause"),Di={_E:v},pt=class extends globalThis.Error{constructor(t,r,n){let i=`MicroCause.${t}`,a,s,o;if(r instanceof globalThis.Error){a=`(${i}) ${r.name}`,s=r.message;let l=s.split(`
`).length;o=r.stack?`(${i}) ${r.stack.split(`
`).slice(0,l+3).join(`
`)}`:`${a}: ${s}`}else a=i,s=Qn(r,0),o=`${a}: ${s}`;n.length>0&&(o+=`
    ${n.join(`
    `)}`);super(s);c(this,"_tag");c(this,"traces");c(this,In);this._tag=t,this.traces=n,this[_r]=Di,this.name=a,this.stack=o}pipe(){return F(this,arguments)}toString(){return this.stack}[(In=_r,x)](){return this.stack}},Hi=class extends pt{constructor(t,r=[]){super("Fail",t,r);c(this,"error");this.error=t}},Vi=(e,t=[])=>new Hi(e,t),qi=class extends pt{constructor(t,r=[]){super("Die",t,r);c(this,"defect");this.defect=t}},Gi=(e,t=[])=>new qi(e,t),Yi=class extends pt{constructor(e=[]){super("Interrupt","interrupted",e)}},Ki=(e=[])=>new Yi(e),Xi=e=>e._tag==="Fail",mr=e=>e._tag==="Interrupt",Sr=Symbol.for("effect/Micro/MicroFiber"),Zi={_A:v,_E:v},kr=(xn=Sr,class{constructor(e,t=!0){c(this,"context");c(this,"interruptible");c(this,xn);c(this,"_stack",[]);c(this,"_observers",[]);c(this,"_exit");c(this,"_children");c(this,"currentOpCount",0);c(this,"_interrupted",!1);c(this,"_yielded");this.context=e,this.interruptible=t,this[Sr]=Zi}getRef(e){return Fi(this.context,e)}addObserver(e){return this._exit?(e(this._exit),Dn):(this._observers.push(e),()=>{let t=this._observers.indexOf(e);t>=0&&this._observers.splice(t,1)})}unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(yt))}unsafePoll(){return this._exit}evaluate(e){if(this._exit)return;if(this._yielded!==void 0){let n=this._yielded;this._yielded=void 0,n()}let t=this.runLoop(e);if(t===me)return;let r=wr.interruptChildren&&wr.interruptChildren(this);if(r!==void 0)return this.evaluate(M(r,()=>t));this._exit=t;for(let n=0;n<this._observers.length;n++)this._observers[n](t);this._observers.length=0}runLoop(e){let t=!1,r=e;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!t&&this.getRef(Ve).shouldYield(this)){t=!0;let n=r;r=M(Cr,()=>n)}if(r=r[gt](this),r===me){let n=this._yielded;return Re in n?(this._yielded=void 0,n):me}}}catch(n){return C(r,gt)?De(n):De(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(e){for(;;){let t=this._stack.pop();if(!t)return;let r=t[Le]&&t[Le](this);if(r)return{[e]:r};if(t[e])return t}}yieldWith(e){return this._yielded=e,me}children(){return this._children??(this._children=new Set)}}),wr=ne("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),Qi=e=>Pe(t=>Be(e.addObserver(r=>t(_(r))))),ea=e=>Y(()=>(e.unsafeInterrupt(),la(Qi(e)))),ta=e=>Y(()=>{for(let n of e)n.unsafeInterrupt();let t=e[Symbol.iterator](),r=Y(()=>{let n=t.next();for(;!n.done;){if(n.value.unsafePoll()){n=t.next();continue}let i=n.value;return Pe(a=>{i.addObserver(s=>{a(r)})})}return le});return r}),Or=Symbol.for("effect/Micro/identifier"),h=Symbol.for("effect/Micro/args"),gt=Symbol.for("effect/Micro/evaluate"),P=Symbol.for("effect/Micro/successCont"),G=Symbol.for("effect/Micro/failureCont"),Le=Symbol.for("effect/Micro/ensureCont"),me=Symbol.for("effect/Micro/Yield"),ra={_A:v,_E:v,_R:v},na={...Wi,_op:"Micro",[br]:ra,pipe(){return F(this,arguments)},[Symbol.iterator](){return new Xt(new Ae(this))},toJSON(){return{_id:"Micro",op:this[Or],...h in this?{args:this[h]}:void 0}},toString(){return A(this)},[x](){return A(this)}};function ia(e){return De("Micro.evaluate: Not implemented")}var Se=e=>({...na,[Or]:e.op,[gt]:e.eval??ia,[P]:e.contA,[G]:e.contE,[Le]:e.ensure}),z=e=>{let t=Se(e);return function(){let r=Object.create(t);return r[h]=e.single===!1?arguments:arguments[0],r}},Er=e=>{let t={...Se(e),[Re]:Re,_tag:e.op,get[e.prop](){return this[h]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[h]}},[w](r){return ha(r)&&r._tag===e.op&&O(this[h],r[h])},[b](){return j(this,J(U(e.op))(y(this[h])))}};return function(r){let n=Object.create(t);return n[h]=r,n[P]=void 0,n[G]=void 0,n[Le]=void 0,n}},_=Er({op:"Success",prop:"value",eval(e){let t=e.getCont(P);return t?t[P](this[h],e):e.yieldWith(this)}}),ae=Er({op:"Failure",prop:"cause",eval(e){let t=e.getCont(G);for(;mr(this[h])&&t&&e.interruptible;)t=e.getCont(G);return t?t[G](this[h],e):e.yieldWith(this)}}),$=e=>ae(Vi(e)),Be=z({op:"Sync",eval(e){let t=this[h](),r=e.getCont(P);return r?r[P](t,e):e.yieldWith(ze(t))}}),Y=z({op:"Suspend",eval(e){return this[h]()}}),aa=z({op:"Yield",eval(e){let t=!1;return e.getRef(Ve).scheduleTask(()=>{t||e.evaluate(le)},this[h]??0),e.yieldWith(()=>{t=!0})}}),Cr=aa(0),Ue=_(void 0),Ir=e=>Y(()=>{try{return _(e.try())}catch(t){return $(e.catch(t))}}),se=e=>xr(function(t,r){try{e.try(r).then(n=>t(_(n)),n=>t($(e.catch(n))))}catch(n){t($(e.catch(n)))}},e.try.length!==0),oe=z({op:"WithMicroFiber",eval(e){return this[h](e)}}),xr=z({op:"Async",single:!1,eval(e){let t=this[h][0],r=!1,n=!1,i=this[h][1]?new AbortController:void 0,a=t(s=>{r||(r=!0,n?e.evaluate(s):n=s)},i==null?void 0:i.signal);return n!==!1?n:(n=!0,e._yielded=()=>{r=!0},i===void 0&&a===void 0||e._stack.push(sa(()=>(r=!0,i==null||i.abort(),a??le))),me)}}),sa=z({op:"AsyncFinalizer",ensure(e){e.interruptible&&(e.interruptible=!1,e._stack.push(_t(!0)))},contE(e,t){return mr(e)?M(this[h](),()=>ae(e)):ae(e)}}),Pe=e=>xr(e,e.length>=2),L=(...e)=>Y(()=>oa(e.length===1?e[0]():e[1].call(e[0]))),oa=z({op:"Iterator",contA(e,t){let r=this[h].next(e);return r.done?_(r.value):(t._stack.push(this),Yn(r.value))},eval(e){return this[P](void 0,e)}}),Nr=u(2,(e,t)=>fa(e,r=>t)),W=u(2,(e,t)=>M(e,r=>{let n=_e(t)?t:typeof t=="function"?t(r):t;return _e(n)?n:_(n)})),vt=u(2,(e,t)=>M(e,r=>{let n=_e(t)?t:typeof t=="function"?t(r):t;return _e(n)?Nr(n,r):_(r)})),la=e=>M(e,t=>le),ua=e=>Sa(e,{onFailure:We,onSuccess:ze}),M=u(2,(e,t)=>{let r=Object.create(ca);return r[h]=e,r[P]=t,r}),ca=Se({op:"OnSuccess",eval(e){return e._stack.push(this),this[h]}}),fa=u(2,(e,t)=>M(e,r=>_(t(r)))),ha=e=>C(e,Re),ze=_,We=ae,yt=We(Ki()),De=e=>We(Gi(e)),le=ze(void 0),da="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0),jr=class{constructor(){c(this,"tasks",[]);c(this,"running",!1);c(this,"afterScheduled",()=>{this.running=!1,this.runTasks()})}scheduleTask(e,t){this.tasks.push(e),this.running||(this.running=!0,da(this.afterScheduled))}runTasks(){let e=this.tasks;this.tasks=[];for(let t=0,r=e.length;t<r;t++)e[t]()}shouldYield(e){return e.currentOpCount>=e.getRef(pa)}flush(){for(;this.tasks.length>0;)this.runTasks()}},D=e=>oe(t=>_(Pi(t.context,e))),Mr=u(2,(e,t)=>oe(r=>{let n=r.context;return r.context=t(n),wa(e,()=>(r.context=n,Ue))})),Ar=u(2,(e,t)=>Mr(e,zi(t))),He=u(3,(e,t,r)=>Mr(e,Ui(t,r)));u(3,(e,t,r)=>M(r,n=>He(e,t,n)));var pa=class extends ie()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){};(class extends ie()("effect/Micro/currentConcurrency",{defaultValue:()=>"unbounded"}){});var Ve=class extends ie()("effect/Micro/currentScheduler",{defaultValue:()=>new jr}){},ga=u(2,(e,t)=>Y(()=>{let r=t.schedule?Date.now():0,n=0,i=M(ua(e),a=>{if(t.while!==void 0&&!t.while(a)||t.times!==void 0&&n>=t.times)return a;n++;let s=Cr;if(t.schedule!==void 0){let o=Date.now()-r,l=t.schedule(n,o);if(R(l))return a;s=$r(l.value)}return M(s,()=>i)});return i})),va=u(e=>_e(e[0]),(e,t)=>ga(e,{...t,while:r=>r._tag==="Success"&&((t==null?void 0:t.while)===void 0||t.while(r.value))})),ya=u(2,(e,t)=>{let r=Object.create(ba);return r[h]=e,r[G]=t,r}),ba=Se({op:"OnFailure",eval(e){return e._stack.push(this),this[h]}}),_a=u(3,(e,t,r)=>ya(e,n=>t(n)?r(n):ae(n))),bt=u(2,(e,t)=>_a(e,Xi,r=>t(r.error))),Tr=u(2,(e,t)=>{let r=Object.create(ma);return r[h]=e,r[P]=t.onSuccess,r[G]=t.onFailure,r}),ma=Se({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[h]}}),Sa=u(2,(e,t)=>Tr(e,{onFailure:r=>Be(()=>t.onFailure(r)),onSuccess:r=>Be(()=>t.onSuccess(r))})),$r=e=>Pe(t=>{let r=setTimeout(()=>{t(Ue)},e);return Be(()=>{clearTimeout(r)})}),ka=u(2,(e,t)=>W($r(t),e)),wa=u(2,(e,t)=>Ea(r=>Tr(r(e),{onFailure:n=>M(t(We(n)),()=>ae(n)),onSuccess:n=>M(t(ze(n)),()=>_(n))}))),_t=z({op:"SetInterruptible",ensure(e){if(e.interruptible=this[h],e._interrupted&&e.interruptible)return()=>yt}}),Oa=e=>oe(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(_t(!1)),t._interrupted?yt:e)),Ea=e=>oe(t=>t.interruptible?(t.interruptible=!1,t._stack.push(_t(!0)),e(Oa)):e(v)),Ca=z({op:"While",contA(e,t){return this[h].step(e),this[h].while()?(t._stack.push(this),this[h].body()):le},eval(e){return this[h].while()?(e._stack.push(this),this[h].body()):le}}),Ia=(e,t,r)=>oe(n=>{let i=r==null?void 0:r.concurrency,a=Math.max(1,i),s=hr(e),o=s.length;if(o===0)return r!=null&&r.discard?Ue:_([]);let l=r!=null&&r.discard?void 0:new Array(o),f=0;return a===1?Nr(Ca({while:()=>f<s.length,body:()=>t(s[f],f),step:l?d=>l[f++]=d:d=>f++}),l):Pe(d=>{let p=new Set,S,m=0,Ne=0,Z=!1,Q=!1;function ee(){for(Z=!0;m<a&&f<o;){let te=f,mo=s[te];f++,m++;try{let je=Jr(n,t(mo,te),!0,!0);p.add(je),je.addObserver(Me=>{p.delete(je),!Q&&(Me._tag==="Failure"?S===void 0&&(S=Me,o=f,p.forEach(So=>So.unsafeInterrupt())):l!==void 0&&(l[te]=Me.value),Ne++,m--,Ne===o?d(S??_(l)):!Z&&m<a&&ee())})}catch(je){S=De(je),o=f,p.forEach(Me=>Me.unsafeInterrupt())}}Z=!1}return ee(),Y(()=>(Q=!0,f=o,ta(p)))})}),Jr=(e,t,r=!1,n=!1)=>{let i=new kr(e.context,e.interruptible);return n||(e.children().add(i),i.addObserver(()=>e.children().delete(i))),r?i.evaluate(t):e.getRef(Ve).scheduleTask(()=>i.evaluate(t),0),i},xa=e=>oe(t=>_(Jr(t,e,!1,!0))),Na=(e,t)=>{let r=new kr(Ve.context((t==null?void 0:t.scheduler)??new jr));if(r.evaluate(e),t==null?void 0:t.signal)if(t.signal.aborted)r.unsafeInterrupt();else{let n=()=>r.unsafeInterrupt();t.signal.addEventListener("abort",n,{once:!0}),r.addObserver(()=>t.signal.removeEventListener("abort",n))}return r},ja=(e,t)=>new Promise((r,n)=>{Na(e,t).addObserver(r)}),Fr=(e,t)=>ja(e,t).then(r=>{if(r._tag==="Failure")throw r.cause;return r.value}),Ma="https://api.telegram.org",Aa={"🔥":"5104841245755180586","👍":"5107584321108051014","👎":"5104858069142078462","❤️":"5159385139981059251","🎉":"5046509860389126442","💩":"5046589136895476101"},Rr=e=>qe.of({...e,base_url:e.base_url??Ma}),qe=class extends dt("TgBotClientConfig")(){},Lr=Symbol.for("effect/Chunk");function Ta(e,t,r,n,i){for(let a=t;a<Math.min(e.length,t+i);a++)r[n+a-t]=e[a];return r}var Br=[],$a=e=>Hn((t,r)=>t.length===r.length&&Oe(t).every((n,i)=>e(n,ue(r,i)))),Ja=$a(O),Fa={[Lr]:{_A:e=>e},toString(){return A(this.toJSON())},toJSON(){return{_id:"Chunk",values:Oe(this).map(I)}},[x](){return this.toJSON()},[w](e){return Ra(e)&&Ja(this,e)},[b](){return j(this,Zt(Oe(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return Br[Symbol.iterator]();default:return Oe(this)[Symbol.iterator]()}},pipe(){return F(this,arguments)}},E=e=>{let t=Object.create(Fa);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=H,t.right=H;break}case"ISingleton":{t.length=1,t.depth=0,t.left=H,t.right=H;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=H,t.right=H;break}}return t},Ra=e=>C(e,Lr),H=E({_tag:"IEmpty"}),ke=()=>H,mt=(...e)=>e.length===1?we(e[0]):Ua(e),we=e=>E({_tag:"ISingleton",a:e}),St=(e,t,r)=>{switch(e.backing._tag){case"IArray":{Ta(e.backing.array,0,t,r,e.length);break}case"IConcat":{St(e.left,t,r),St(e.right,t,r+e.left.length);break}case"ISingleton":{t[r]=e.backing.a;break}case"ISlice":{let n=0,i=r;for(;n<e.length;)t[i]=ue(e,n),n+=1,i+=1;break}}},La=e=>{switch(e.backing._tag){case"IEmpty":return Br;case"IArray":return e.backing.array;default:{let t=new Array(e.length);return St(e,t,0),e.backing={_tag:"IArray",array:t},e.left=H,e.right=H,e.depth=0,t}}},Oe=La,Ba=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return E({_tag:"IArray",array:dr(e.backing.array)});case"IConcat":return E({_tag:"IConcat",left:kt(e.backing.right),right:kt(e.backing.left)});case"ISlice":return Ur(dr(Oe(e)))}},kt=Ba,Ur=e=>E({_tag:"IArray",array:e}),Ua=e=>Ur(e),ue=u(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?ue(e.left,t):ue(e.right,t-e.left.length);case"ISlice":return ue(e.backing.chunk,t+e.backing.offset)}}),Pr=u(2,(e,t)=>V(we(t),e)),V=u(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;let r=t.depth-e.depth;if(Math.abs(r)<=1)return E({_tag:"IConcat",left:e,right:t});if(r<-1)if(e.left.depth>=e.right.depth){let n=V(e.right,t);return E({_tag:"IConcat",left:e.left,right:n})}else{let n=V(e.right.right,t);if(n.depth===e.depth-3){let i=E({_tag:"IConcat",left:e.right.left,right:n});return E({_tag:"IConcat",left:e.left,right:i})}else{let i=E({_tag:"IConcat",left:e.left,right:e.right.left});return E({_tag:"IConcat",left:i,right:n})}}else if(t.right.depth>=t.left.depth){let n=V(e,t.left);return E({_tag:"IConcat",left:n,right:t.right})}else{let n=V(e,t.left.left);if(n.depth===t.depth-3){let i=E({_tag:"IConcat",left:n,right:t.left.right});return E({_tag:"IConcat",left:i,right:t.right})}else{let i=E({_tag:"IConcat",left:t.left.right,right:t.right});return E({_tag:"IConcat",left:n,right:i})}}}),Pa=e=>e.length===0,zr=e=>e.length>0,za=e=>ue(e,0),Wr=za,wt=Math.pow(2,5),Wa=wt-1,Da=wt/2,Ha=wt/4;function Va(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function ce(e,t){return t>>>e&Wa}function fe(e){return 1<<e}function Dr(e,t){return Va(e&t-1)}var qa=(e,t)=>({value:e,previous:t});function he(e,t,r,n){let i=n;if(!e){let a=n.length;i=new Array(a);for(let s=0;s<a;++s)i[s]=n[s]}return i[t]=r,i}function Hr(e,t,r){let n=r.length-1,i=0,a=0,s=r;if(e)i=a=t;else for(s=new Array(n);i<t;)s[a++]=r[i++];for(++i;i<=n;)s[a++]=r[i++];return e&&(s.length=n),s}function Ga(e,t,r,n){let i=n.length;if(e){let l=i;for(;l>=t;)n[l--]=n[l];return n[t]=r,n}let a=0,s=0,o=new Array(i+1);for(;a<t;)o[s++]=n[a++];for(o[t]=r;a<i;)o[++s]=n[a++];return o}var de=class Rn{constructor(){c(this,"_tag","EmptyNode")}modify(t,r,n,i,a,s){let o=n(T());return R(o)?new Rn:(++s.value,new Ye(t,i,a,o))}};function B(e){return Gn(e,"EmptyNode")}function Ya(e){return B(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Ge(e,t){return B(e)?!1:t===e.edit}var Ye=class Dt{constructor(t,r,n,i){c(this,"edit");c(this,"hash");c(this,"key");c(this,"value");c(this,"_tag","LeafNode");this.edit=t,this.hash=r,this.key=n,this.value=i}modify(t,r,n,i,a,s){if(O(a,this.key)){let l=n(this.value);return l===this.value?this:R(l)?(--s.value,new de):Ge(this,t)?(this.value=l,this):new Dt(t,i,a,l)}let o=n(T());return R(o)?this:(++s.value,Vr(t,r,this.hash,this,i,new Dt(t,i,a,o)))}},Ka=class Ln{constructor(t,r,n){c(this,"edit");c(this,"hash");c(this,"children");c(this,"_tag","CollisionNode");this.edit=t,this.hash=r,this.children=n}modify(t,r,n,i,a,s){if(i===this.hash){let l=Ge(this,t),f=this.updateCollisionList(l,t,this.hash,this.children,n,a,s);return f===this.children?this:f.length>1?new Ln(t,this.hash,f):f[0]}let o=n(T());return R(o)?this:(++s.value,Vr(t,r,this.hash,this,i,new Ye(t,i,a,o)))}updateCollisionList(t,r,n,i,a,s,o){let l=i.length;for(let d=0;d<l;++d){let p=i[d];if("key"in p&&O(s,p.key)){let S=p.value,m=a(S);return m===S?i:R(m)?(--o.value,Hr(t,d,i)):he(t,d,new Ye(r,n,s,m),i)}}let f=a(T());return R(f)?i:(++o.value,he(t,l,new Ye(r,n,s,f),i))}},Ot=class Ht{constructor(t,r,n){c(this,"edit");c(this,"mask");c(this,"children");c(this,"_tag","IndexedNode");this.edit=t,this.mask=r,this.children=n}modify(t,r,n,i,a,s){let o=this.mask,l=this.children,f=ce(r,i),d=fe(f),p=Dr(o,d),S=o&d,m=Ge(this,t);if(!S){let te=new de().modify(t,r+5,n,i,a,s);return te?l.length>=Da?Qa(t,f,te,o,l):new Ht(t,o|d,Ga(m,p,te,l)):this}let Ne=l[p],Z=Ne.modify(t,r+5,n,i,a,s);if(Ne===Z)return this;let Q=o,ee;if(B(Z)){if(Q&=~d,!Q)return new de;if(l.length<=2&&Ya(l[p^1]))return l[p^1];ee=Hr(m,p,l)}else ee=he(m,p,Z,l);return m?(this.mask=Q,this.children=ee,this):new Ht(t,Q,ee)}},Xa=class Bn{constructor(t,r,n){c(this,"edit");c(this,"size");c(this,"children");c(this,"_tag","ArrayNode");this.edit=t,this.size=r,this.children=n}modify(t,r,n,i,a,s){let o=this.size,l=this.children,f=ce(r,i),d=l[f],p=(d||new de).modify(t,r+5,n,i,a,s);if(d===p)return this;let S=Ge(this,t),m;if(B(d)&&!B(p))++o,m=he(S,f,p,l);else if(!B(d)&&B(p)){if(--o,o<=Ha)return Za(t,o,f,l);m=he(S,f,new de,l)}else m=he(S,f,p,l);return S?(this.size=o,this.children=m,this):new Bn(t,o,m)}};function Za(e,t,r,n){let i=new Array(t-1),a=0,s=0;for(let o=0,l=n.length;o<l;++o)if(o!==r){let f=n[o];f&&!B(f)&&(i[a++]=f,s|=1<<o)}return new Ot(e,s,i)}function Qa(e,t,r,n,i){let a=[],s=n,o=0;for(let l=0;s;++l)s&1&&(a[l]=i[o++]),s>>>=1;return a[t]=r,new Xa(e,o+1,a)}function es(e,t,r,n,i,a){if(r===i)return new Ka(e,r,[a,n]);let s=ce(t,r),o=ce(t,i);if(s===o)return l=>new Ot(e,fe(s)|fe(o),[l]);{let l=s<o?[n,a]:[a,n];return new Ot(e,fe(s)|fe(o),l)}}function Vr(e,t,r,n,i,a){let s,o=t;for(;;){let l=es(e,o,r,n,i,a);if(typeof l=="function")s=qa(l,s),o=o+5;else{let f=l;for(;s!=null;)f=s.value(f),s=s.previous;return f}}}var qr="effect/HashMap",Et=Symbol.for(qr),ts={[Et]:Et,[Symbol.iterator](){return new Gr(this,(e,t)=>[e,t])},[b](){let e=y(qr);for(let t of this)e^=k(y(t[0]),J(y(t[1])));return j(this,e)},[w](e){if(is(e)){if(e._size!==this._size)return!1;for(let t of this){let r=k(e,as(t[0],y(t[0])));if(R(r)||!O(t[1],r.value))return!1}return!0}return!1},toString(){return A(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(I)}},[x](){return this.toJSON()},pipe(){return F(this,arguments)}},Ct=(e,t,r,n)=>{let i=Object.create(ts);return i._editable=e,i._edit=t,i._root=r,i._size=n,i},Gr=class Un{constructor(t,r){c(this,"map");c(this,"f");c(this,"v");this.map=t,this.f=r,this.v=Yr(this.map._root,this.f,void 0)}next(){if(R(this.v))return{done:!0,value:void 0};let t=this.v.value;return this.v=Ke(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Un(this.map,this.f)}},Ke=e=>e?Kr(e[0],e[1],e[2],e[3],e[4]):T(),Yr=(e,t,r=void 0)=>{switch(e._tag){case"LeafNode":return be(e.value)?ye({value:t(e.key,e.value.value),cont:r}):Ke(r);case"CollisionNode":case"ArrayNode":case"IndexedNode":{let n=e.children;return Kr(n.length,n,0,t,r)}default:return Ke(r)}},Kr=(e,t,r,n,i)=>{for(;r<e;){let a=t[r++];if(a&&!B(a))return Yr(a,n,[e,t,r,n,i])}return Ke(i)},rs=Ct(!1,0,new de,0),ns=()=>rs,is=e=>C(e,Et),as=u(3,(e,t,r)=>{let n=e._root,i=0;for(;;)switch(n._tag){case"LeafNode":return O(t,n.key)?n.value:T();case"CollisionNode":{if(r===n.hash){let a=n.children;for(let s=0,o=a.length;s<o;++s){let l=a[s];if("key"in l&&O(t,l.key))return l.value}}return T()}case"IndexedNode":{let a=ce(i,r),s=fe(a);if(n.mask&s){n=n.children[Dr(n.mask,s)],i+=5;break}return T()}case"ArrayNode":{if(n=n.children[ce(i,r)],n){i+=5;break}return T()}default:return T()}}),Xr=u(3,(e,t,r)=>us(e,t,()=>ye(r))),ss=u(3,(e,t,r)=>e._editable?(e._root=t,e._size=r,e):t===e._root?e:Ct(e._editable,e._edit,t,r)),os=e=>new Gr(e,t=>t),It=e=>e._size,ls=e=>Ct(!0,e._edit+1,e._root,e._size),us=u(3,(e,t,r)=>cs(e,t,y(t),r)),cs=u(4,(e,t,r,n)=>{let i={value:e._size},a=e._root.modify(e._editable?e._edit:NaN,0,n,r,t,i);return k(e,ss(a,i.value))}),fs=u(2,(e,t)=>hs(e,void 0,(r,n,i)=>t(n,i))),hs=u(3,(e,t,r)=>{let n=e._root;if(n._tag==="LeafNode")return be(n.value)?r(t,n.value.value,n.key):t;if(n._tag==="EmptyNode")return t;let i=[n.children],a;for(;a=i.pop();)for(let s=0,o=a.length;s<o;){let l=a[s++];l&&!B(l)&&(l._tag==="LeafNode"?be(l.value)&&(t=r(t,l.value.value,l.key)):i.push(l.children))}return t}),Zr="effect/HashSet",xt=Symbol.for(Zr),ds={[xt]:xt,[Symbol.iterator](){return os(this._keyMap)},[b](){return j(this,J(y(this._keyMap))(y(Zr)))},[w](e){return ps(e)?It(this._keyMap)===It(e._keyMap)&&O(this._keyMap,e._keyMap):!1},toString(){return A(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(I)}},[x](){return this.toJSON()},pipe(){return F(this,arguments)}},Nt=e=>{let t=Object.create(ds);return t._keyMap=e,t},ps=e=>C(e,xt),gs=Nt(ns()),Qr=()=>gs,vs=e=>It(e._keyMap),ys=e=>Nt(ls(e._keyMap)),bs=e=>(e._keyMap._editable=!1,e),_s=u(2,(e,t)=>{let r=ys(e);return t(r),bs(r)}),jt=u(2,(e,t)=>e._keyMap._editable?(Xr(t,!0)(e._keyMap),e):Nt(Xr(t,!0)(e._keyMap))),ms=u(2,(e,t)=>_s(Qr(),r=>{Ss(e,n=>jt(r,n));for(let n of t)jt(r,n)})),Ss=u(2,(e,t)=>fs(e._keyMap,(r,n)=>t(n))),Xe=Qr,ks=vs,Mt=jt,At=ms;Object.assign(Object.create(Array.prototype),{[b](){return j(this,Zt(this))},[w](e){return Array.isArray(e)&&this.length===e.length?this.every((t,r)=>O(t,e[r])):!1}});var ws=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=rr,e}(),en="Die",Tt="Empty",$t="Fail",tn="Interrupt",Ee="Parallel",Ce="Sequential",rn="effect/Cause",nn=Symbol.for(rn),Os={_E:e=>e},Jt={[nn]:Os,[b](){return k(y(rn),J(y(Ns(this))),j(this))},[w](e){return Cs(e)&&xs(this,e)},pipe(){return F(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:I(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:I(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:I(this.left),right:I(this.right)}}},toString(){return un(this)},[x](){return this.toJSON()}},Ft=e=>{let t=Object.create(Jt);return t._tag=$t,t.error=e,t},Es=(e,t)=>{let r=Object.create(Jt);return r._tag=Ee,r.left=e,r.right=t,r},Ze=(e,t)=>{let r=Object.create(Jt);return r._tag=Ce,r.left=e,r.right=t,r},Cs=e=>C(e,nn),Is=e=>ln(void 0,Ms)(e),xs=(e,t)=>{let r=we(e),n=we(t);for(;zr(r)&&zr(n);){let[i,a]=k(Wr(r),on([Xe(),ke()],([l,f],d)=>{let[p,S]=Rt(d);return ye([k(l,At(p)),k(f,V(S))])})),[s,o]=k(Wr(n),on([Xe(),ke()],([l,f],d)=>{let[p,S]=Rt(d);return ye([k(l,At(p)),k(f,V(S))])}));if(!O(i,s))return!1;r=a,n=o}return!0},Ns=e=>js(we(e),ke()),js=(e,t)=>{for(;;){let[r,n]=k(e,Ei([Xe(),ke()],([a,s],o)=>{let[l,f]=Rt(o);return[k(a,At(l)),k(s,V(f))]})),i=ks(r)>0?k(t,Pr(r)):t;if(Pa(n))return kt(i);e=n,t=i}throw new Error(it("Cause.flattenCauseLoop"))},Rt=e=>{let t=e,r=[],n=Xe(),i=ke();for(;t!==void 0;)switch(t._tag){case Tt:{if(r.length===0)return[n,i];t=r.pop();break}case $t:{if(n=Mt(n,mt(t._tag,t.error)),r.length===0)return[n,i];t=r.pop();break}case en:{if(n=Mt(n,mt(t._tag,t.defect)),r.length===0)return[n,i];t=r.pop();break}case tn:{if(n=Mt(n,mt(t._tag,t.fiberId)),r.length===0)return[n,i];t=r.pop();break}case Ce:{switch(t.left._tag){case Tt:{t=t.right;break}case Ce:{t=Ze(t.left.left,Ze(t.left.right,t.right));break}case Ee:{t=Es(Ze(t.left.left,t.right),Ze(t.left.right,t.right));break}default:{i=Pr(i,t.right),t=t.left;break}}break}case Ee:{r.push(t.right),t=t.left;break}}throw new Error(it("Cause.evaluateCauseLoop"))},Ms={emptyCase:Vt,failCase:qt,dieCase:qt,interruptCase:Vt,sequentialCase:(e,t,r)=>t&&r,parallelCase:(e,t,r)=>t&&r},an="SequentialCase",sn="ParallelCase",on=u(3,(e,t,r)=>{let n=t,i=e,a=[];for(;i!==void 0;){let s=r(n,i);switch(n=be(s)?s.value:n,i._tag){case Ce:{a.push(i.right),i=i.left;break}case Ee:{a.push(i.right),i=i.left;break}default:{i=void 0;break}}i===void 0&&a.length>0&&(i=a.pop())}return n}),ln=u(3,(e,t,r)=>{let n=[e],i=[];for(;n.length>0;){let s=n.pop();switch(s._tag){case Tt:{i.push(Fe(r.emptyCase(t)));break}case $t:{i.push(Fe(r.failCase(t,s.error)));break}case en:{i.push(Fe(r.dieCase(t,s.defect)));break}case tn:{i.push(Fe(r.interruptCase(t,s.fiberId)));break}case Ce:{n.push(s.right),n.push(s.left),i.push(fr({_tag:an}));break}case Ee:{n.push(s.right),n.push(s.left),i.push(fr({_tag:sn}));break}}}let a=[];for(;i.length>0;){let s=i.pop();switch(s._tag){case"Left":{switch(s.left._tag){case an:{let o=a.pop(),l=a.pop(),f=r.sequentialCase(t,o,l);a.push(f);break}case sn:{let o=a.pop(),l=a.pop(),f=r.parallelCase(t,o,l);a.push(f);break}}break}case"Right":{a.push(s.right);break}}}if(a.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return a.pop()}),un=(e,t)=>Is(e)?"All fibers interrupted without errors.":Fs(e).map(function(r){return(t==null?void 0:t.renderErrorCause)!==!0||r.cause===void 0?r.stack:`${r.stack} {
${cn(r.cause,"  ")}
}`}).join(`
`),cn=(e,t)=>{let r=e.stack.split(`
`),n=`${t}[cause]: ${r[0]}`;for(let i=1,a=r.length;i<a;i++)n+=`
${t}${r[i]}`;return e.cause&&(n+=` {
${cn(e.cause,`${t}  `)}
${t}}`),n},fn=class Pn extends globalThis.Error{constructor(r){let n=typeof r=="object"&&r!==null,i=Error.stackTraceLimit;Error.stackTraceLimit=1;super(As(r),n&&"cause"in r&&typeof r.cause<"u"?{cause:new Pn(r.cause)}:void 0);c(this,"span");this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=i,this.name=r instanceof Error?r.name:"Error",n&&(hn in r&&(this.span=r[hn]),Object.keys(r).forEach(a=>{a in this||(this[a]=r[a])})),this.stack=Js(`${this.name}: ${this.message}`,r instanceof Error&&r.stack?r.stack:"",this.span)}},As=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(C(e,"toString")&&nt(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return er(e)},Ts=/\((.*)\)/g,$s=ne("effect/Tracer/spanToTrace",()=>new WeakMap),Js=(e,t,r)=>{let n=[e],i=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let a=1;a<i.length&&!i[a].includes("Generator.next");a++){if(i[a].includes("effect_internal_function")){n.pop();break}n.push(i[a].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(r){let a=r,s=0;for(;a&&a._tag==="Span"&&s<10;){let o=$s.get(a);if(typeof o=="function"){let l=o();if(typeof l=="string"){let f=l.matchAll(Ts),d=!1;for(let[,p]of f)d=!0,n.push(`    at ${a.name} (${p})`);d||n.push(`    at ${a.name} (${l.replace(/^at /,"")})`)}else n.push(`    at ${a.name}`)}else n.push(`    at ${a.name}`);a=Oi(a.parent),s++}}return n.join(`
`)},hn=Symbol.for("effect/SpanAnnotation"),Fs=e=>ln(e,void 0,{emptyCase:()=>[],dieCase:(t,r)=>[new fn(r)],failCase:(t,r)=>[new fn(r)],interruptCase:()=>[],parallelCase:(t,r,n)=>[...r,...n],sequentialCase:(t,r,n)=>[...r,...n]}),dn=class zn{constructor(t){c(this,"self");c(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new zn(this.self)}},Lt=Symbol.for("effect/Effect"),Rs=class{constructor(e){c(this,"_op");c(this,"effect_instruction_i0");c(this,"effect_instruction_i1");c(this,"effect_instruction_i2");c(this,"trace");c(this,Nn,ge);this._op=e}[(Nn=Lt,w)](e){return this===e}[b](){return j(this,ot(this))}pipe(){return F(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:I(this.effect_instruction_i0),effect_instruction_i1:I(this.effect_instruction_i1),effect_instruction_i2:I(this.effect_instruction_i2)}}toString(){return A(this.toJSON())}[x](){return this.toJSON()}[Symbol.iterator](){return new dn(new Ae(this))}},Ls=class{constructor(e){c(this,"_op");c(this,"effect_instruction_i0");c(this,"effect_instruction_i1");c(this,"effect_instruction_i2");c(this,"trace");c(this,jn,ge);this._op=e,this._tag=e}[(jn=Lt,w)](e){return Ws(e)&&e._op==="Failure"&&O(this.effect_instruction_i0,e.effect_instruction_i0)}[b](){return k(U(this._tag),J(y(this.effect_instruction_i0)),j(this))}get cause(){return this.effect_instruction_i0}pipe(){return F(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return A(this.toJSON())}[x](){return this.toJSON()}[Symbol.iterator](){return new dn(new Ae(this))}},Bs=e=>C(e,Lt),Us=e=>{let t=new Rs(ni);return t.effect_instruction_i0=e,t},Bt=Symbol.for("effect/SpanAnnotation"),pn=Symbol.for("effect/OriginalAnnotation"),Ps=(e,t)=>be(t)?new Proxy(e,{has(r,n){return n===Bt||n===pn||n in r},get(r,n){return n===Bt?t.value:n===pn?e:r[n]}}):e,zs=e=>Kt(e)&&!(Bt in e)?Us(t=>gn(Ft(Ps(e,Ds(t))))):gn(Ft(e)),gn=e=>{let t=new Ls(ri);return t.effect_instruction_i0=e,t},vn=function(){class e extends globalThis.Error{commit(){return zs(this)}toJSON(){return{...this}}[x](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?un(Ft(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,fi),e}(),K=(e,t)=>{class r extends vn{constructor(){super(...arguments);c(this,"_tag",t)}}return Object.assign(r.prototype,e),r.prototype.name=t,r},yn=Symbol.for("effect/Cause/errors/RuntimeException");K({[yn]:yn},"RuntimeException");var bn=Symbol.for("effect/Cause/errors/InterruptedException");K({[bn]:bn},"InterruptedException");var _n=Symbol.for("effect/Cause/errors/IllegalArgument");K({[_n]:_n},"IllegalArgumentException");var mn=Symbol.for("effect/Cause/errors/NoSuchElement");K({[mn]:mn},"NoSuchElementException");var Sn=Symbol.for("effect/Cause/errors/InvalidPubSubCapacityException");K({[Sn]:Sn},"InvalidPubSubCapacityException");var kn=Symbol.for("effect/Cause/errors/ExceededCapacityException");K({[kn]:kn},"ExceededCapacityException");var wn=Symbol.for("effect/Cause/errors/Timeout");K({[wn]:wn},"TimeoutException");var Ws=e=>Bs(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),Ds=e=>{let t=e.currentSpan;return t!==void 0&&t._tag==="Span"?ye(t):T()},Ut=ws,Hs=e=>{class t extends Ut{constructor(){super(...arguments);c(this,"_tag",e)}}return t},Vs=function(){let e=Symbol.for("effect/Data/Error/plainArgs");return class extends vn{constructor(t){super(t==null?void 0:t.message,t!=null&&t.cause?{cause:t.cause}:void 0),t&&(Object.assign(this,t),Object.defineProperty(this,e,{value:t,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}(),Pt=e=>{class t extends Vs{constructor(){super(...arguments);c(this,"_tag",e)}}return t.prototype.name=e,t},qs=(q=class extends Hs("BotResponse"){static make(t){return new q({response:t})}},c(q,"ignore",new q({})),q),zt=class extends dt("BotUpdateHandlers")(){},Gs=e=>{for(let[t,r]of Object.entries(e))if(t!="update_id")return{type:t,...r}},Ys=e=>{let t=e[0];for(let r=1;r<e.length;r++)t+=e[r]==="_"?e[++r].toUpperCase():e[r];return t},pe=(X=class extends Pt("TgBotClientError"){},c(X,"missingSuccess",new X({reason:{type:"ClientInternalError",cause:"Expected 'success' to be defined"}})),X),Ks=e=>typeof e=="object"&&e!=null&&"file_content"in e&&e.file_content instanceof Uint8Array&&"file_name"in e&&typeof e.file_name=="string",Xs=e=>typeof e=="object"&&e!=null&&"ok"in e&&typeof e.ok=="boolean",Zs=e=>typeof e=="object"&&e!=null&&"bot_token"in e&&typeof e.bot_token=="string",Qs=e=>{let t=Object.entries(e);if(t.length==0)return;let r=new FormData;for(let[n,i]of t)i&&(typeof i!="object"?r.append(n,`${i}`):Ks(i)?r.append(n,new Blob([i.file_content]),i.file_name):r.append(n,JSON.stringify(i)));return r},Qe=(e,t)=>L(function*(){let r=yield*D(qe),n=yield*se({try:()=>fetch(`${r.base_url}/bot${r.bot_token}/${Ys(e)}`,{body:Qs(t)??null,method:"POST"}),catch:a=>new pe({reason:{type:"ClientInternalError",cause:a}})}),i=yield*se({try:()=>n.json(),catch:()=>new pe({reason:{type:"UnexpectedResponse",response:n}})});return Xs(i)?n.ok?i.result:yield*$(new pe({reason:{type:"NotOkResponse",...i.error_code?{errorCode:i.error_code}:void 0,...i.description?{details:i.description}:void 0}})):yield*$(new pe({reason:{type:"UnexpectedResponse",response:i}}))}),On=class Wn extends Ut{static make(t){let r=t.batch_size??10,n=t.poll_timeout??10,i=t.max_empty_responses,a=t.log_level??"info",s=t.on_error;(r<10||r>100)&&(console.warn("Wrong batch_size, must be in [10..100], using 10 instead"),r=10),(n<2||n>10)&&(console.warn("Wrong poll_timeout, must be in [2..10], using 2 instead"),n=10),i&&i<2&&(console.warn("Wrong max_empty_responses, must be in [2..infinity], using infinity"),i=void 0),a||(a="info"),s||(s="stop");let o=new Wn({batch_size:r,poll_timeout:n,max_empty_responses:i,log_level:a,on_error:s});return console.log("bot poll settings",o),o}},Ie=class extends ie()("BotSettings",{defaultValue(){return On.make({})}}){},Wt=class extends Ut{},eo=e=>L(function*(){let t=yield*D(Ie),r=yield*D(zt);return r.type=="single"?yield*ro(e,r,t):yield*to(e,r)}),to=(e,t,r)=>Ir({try:()=>t.on_batch(e),catch:n=>n}).pipe(W(n=>n instanceof Promise?se({try:()=>n,catch:i=>i}):_(n)),W(n=>new Wt({hasErrors:!n,updates:e})),bt(n=>(console.log("handle batch error",{errorMessage:n instanceof Error?n.message:void 0,updates:e.map(i=>Object.keys(i).at(1))}),_(new Wt({hasErrors:!0,updates:e}))))),et=class extends Pt("HandleUpdateError"){},ro=(e,t,r)=>Ia(e,n=>no(n,t).pipe(bt(i=>(console.log("update handle error",{updateId:n.update_id,updateKey:Object.keys(n).at(1),name:i._tag,...i.cause instanceof Error?{error:i.cause.message}:void 0}),_(i)))),{concurrency:10}).pipe(W(n=>(r.log_level=="debug"&&console.debug("handle batch result",n),new Wt({hasErrors:!n.every(i=>i==null),updates:e})))),no=(e,t)=>L(function*(){let r=Gs(e);if(!r)return yield*$(new et({name:"UnknownUpdate",update:e}));let n=t[`on_${r.type}`];if(!n)return yield*$(new et({name:"HandlerNotDefined",update:e}));r.type=="message"&&"text"in r&&console.info("Got a new text message",{chatId:r.chat.id,chatType:r.chat.type,message:`${r.text.slice(0,5)}...`});let i,a=yield*Ir({try:()=>n(r),catch:o=>new et({name:"BotHandlerError",update:e,cause:o})}).pipe(W(o=>o instanceof Promise?se({try:()=>o,catch:l=>new et({name:"BotHandlerError",update:e,cause:l})}):_(o)),bt(o=>{var l,f;return i=o,console.log("error",{updateId:e.update_id,updateKey:Object.keys(e).at(1),name:o._tag,...o.cause instanceof Error?{error:o.cause.message}:void 0}),_(qs.make({type:"message",text:`Some internal error has happend(${o.name}) while handling this message`,message_effect_id:Aa["💩"],...(l=e.message)!=null&&l.message_id?{reply_parameters:{message_id:(f=e.message)==null?void 0:f.message_id}}:void 0}))})),s=yield*D(Ie);if(!a&&s.log_level=="debug"){console.log(`Bot response is undefined for update with ID #${e.update_id}.`);return}if("chat"in r&&a.response){let o=yield*Qe(`send_${a.response.type}`,{...a.response,chat_id:r.chat.id});s.log_level=="debug"&&console.debug("bot response",o)}return i}),io=class extends ie()("BotFetchUpdatesService",{defaultValue:()=>{let e={lastUpdateId:void 0,emptyResponses:0},t=ao(e).pipe(vt(n=>{let i=n.map(a=>a.update_id).sort().at(-1);console.log("updating last update id",i),e.lastUpdateId=i?i+1:void 0,console.log(e)})),r=so(e);return{state:e,fetchUpdates:t,commit:r}}}){},En=class extends Pt("FetchUpdatesError"){},ao=e=>L(function*(){let t=yield*D(Ie);if(t.max_empty_responses&&e.emptyResponses==t.max_empty_responses)return yield*$(new En({name:"TooManyEmptyResponses"}));let r=e.lastUpdateId;t.log_level=="debug"&&console.debug("getting updates",e);let n=yield*Qe("get_updates",{timeout:t.poll_timeout,...r?{offset:r}:void 0}).pipe(W(i=>i.sort(a=>a.update_id)));return n.length?(console.debug(`got a batch of updates (${n.length})`),e.emptyResponses=0,n):(e.emptyResponses+=1,[])}),so=e=>L(function*(){return console.log("commit",{pollState:e}),e.lastUpdateId?yield*Qe("get_updates",{offset:e.lastUpdateId,limit:0}).pipe(W(W(D(Ie),t=>{t.log_level=="debug"&&console.debug("committed offset",e)}))):yield*$(new En({name:"NoUpdatesToCommit"}))}),oo=class extends ie()("BotRunService",{defaultValue:()=>{console.log("Initiating BotRunService");let e={fiber:void 0};return{runBotInBackground:lo(e),getFiber:()=>e.fiber}}}){},lo=e=>L(function*(){console.log("run bot");let t=yield*D(io),r=ka(1e3)(t.fetchUpdates.pipe(W(n=>eo(n)),vt(({updates:n})=>n.length>0?t.commit:Ue))).pipe(va({while:n=>!n.hasErrors}),xa,vt(n=>n.addObserver(i=>{console.log("bot's fiber has been closed",i)})));e.fiber&&(console.log("killing previous bot's fiber"),yield*ea(e.fiber)),e.fiber=yield*r,console.log("Fetching bot updates via long polling...")}),uo=e=>L(function*(){if(e.type=="config")return Rr(e);let t=yield*se({try:async()=>{let{readFileSync:r}=await Promise.resolve().then(function(){return _o});return JSON.parse(await r("config.json","utf-8"))},catch:r=>(console.warn("invalid tg bot config",r),"ReadingConfigError")});return Zs(t)?Rr(t):yield*$("InvalidConfig")}),co=e=>L(function*(){let t=Bi(qe,yield*uo(e)),r=yield*D(oo);return yield*r.runBotInBackground.pipe(Ar(t),He(zt,e.mode),He(Ie,On.make(e.poll??{}))),{reload:n=>r.runBotInBackground.pipe(He(zt,n),Ar(t),Fr),fiber:r.getFiber}}),fo=e=>co(e).pipe(Fr),ho=e=>L(function*(){let t=yield*Qe("get_file",{file_id:e}),r=yield*D(qe),n=t.file_path;if(!n||n.length==0)return yield*$(new pe({reason:{type:"UnableToGetFile",cause:"File path not defined"}}));let i=n.replaceAll("/","-"),a=`${r.base_url}/file/bot${r.bot_token}/${n}`,s=yield*se({try:()=>fetch(a).then(o=>o.arrayBuffer()),catch:o=>new pe({reason:{type:"UnableToGetFile",cause:o}})});return new File([new Uint8Array(s)],i)});(class extends dt("ClientFileService")(){}),L(function*(){return{getFile:e=>ho(e.file_id)}});const po=e=>typeof e=="object"&&e!=null&&"command"in e&&"token"in e&&"code"in e,go={"@effect-ak/tg-bot-client":"@effect-ak/tg-bot-client@0.5.1/dist/index.min.mjs"},vo=e=>{let t=e;for(const[r,n]of Object.entries(go)){const i=`https://cdn.jsdelivr.net/npm/${n}`;t=t.replaceAll(r,i)}return t};function yo(e){const t=vo(e);console.log("loading js code",{code:e,prepared:t});const r=new Blob([t],{type:"application/javascript"}),n=URL.createObjectURL(r);return import(n).finally(()=>URL.revokeObjectURL(n))}const bo=(e=>{let t=0,r;const n=i=>e({...i,messageId:t++});return async i=>{var a;if(!po(i)){n({error:"not a run bot command",command:i});return}if(i.command=="run-bot"){const s=await yo(i.code);if(console.log("worker got run-bot command",s),r){console.log("reloading..."),await r.reload({type:"single",...s.default}),n({botState:{status:"reloaded"}});return}r=await fo({type:"config",bot_token:i.token,mode:{type:"single",...s.default}}),(a=r.fiber())==null||a.addObserver(o=>{n({success:"Bot's fiber has been shutdown",exit:o,botState:{status:"stopped"}})}),n({success:"Bot's fiber has been created",botState:{status:"active"}});return}n({error:"Unknown command"})}})(e=>self.postMessage(e));self.onmessage=e=>bo(e.data);var _o=Object.freeze({__proto__:null})})();
