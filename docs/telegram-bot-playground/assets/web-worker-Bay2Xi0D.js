var Ki=Object.defineProperty;var wr=y=>{throw TypeError(y)};var Xi=(y,u,g)=>u in y?Ki(y,u,{enumerable:!0,configurable:!0,writable:!0,value:g}):y[u]=g;var l=(y,u,g)=>Xi(y,typeof u!="symbol"?u+"":u,g),vr=(y,u,g)=>u.has(y)||wr("Cannot "+g);var Er=(y,u,g)=>(vr(y,u,"read from private field"),g?g.call(y):u.get(y)),Or=(y,u,g)=>u.has(y)?wr("Cannot add the same private member more than once"):u instanceof WeakSet?u.add(y):u.set(y,g),Ir=(y,u,g,re)=>(vr(y,u,"write to private field"),re?re.call(y,g):u.set(y,g),g);(function(){"use strict";var Te,_r,br,Sr,kr,z;const y=e=>typeof e=="function",u=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(c){return t(c,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},g=e=>e,re=e=>()=>e,Yt=re(!0),Kt=re(!1),Xt=re(void 0),Mr=Xt;function w(e,t,n,r,s,o,i,c,a){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return c(i(o(s(r(n(t(e)))))));case 9:return a(c(i(o(s(r(n(t(e))))))));default:{let f=arguments[0];for(let d=1;d<arguments.length;d++)f=arguments[d](f);return f}}}const $r=e=>(t,n)=>t===n||e(t,n);let Tr="3.16.3";const Qt=()=>Tr,Pe=`effect/GlobalValue/globalStoreId/${Qt()}`;let ye;const se=(e,t)=>(ye||(globalThis[Pe]??(globalThis[Pe]=new Map),ye=globalThis[Pe]),ye.has(e)||ye.set(e,t()),ye.get(e)),ct=y,Ar=e=>typeof e=="object"&&e!==null,Zt=e=>Ar(e)||ct(e),O=u(2,(e,t)=>Zt(e)&&t in e),jr=u(2,(e,t)=>O(e,"_tag")&&e._tag===t),at=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let en=class Cr{constructor(t){l(this,"self");l(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Cr(this.self)}};const ut=Symbol.for("effect/Utils/YieldWrap");class Re{constructor(t){Or(this,Te);Ir(this,Te,t)}[ut](){return Er(this,Te)}}Te=new WeakMap;function xr(e){if(typeof e=="object"&&e!==null&&ut in e)return e[ut]();throw new Error(at("yieldWrapGet"))}const M=se("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),lt=se(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),S=Symbol.for("effect/Hash"),m=e=>{if(M.enabled===!0)return 0;switch(typeof e){case"number":return ht(e);case"bigint":return B(e.toString(10));case"boolean":return B(String(e));case"symbol":return B(String(e));case"string":return B(e);case"undefined":return B("undefined");case"function":case"object":return e===null?B("null"):e instanceof Date?m(e.toISOString()):e instanceof URL?m(e.href):Pr(e)?e[S]():ft(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},ft=e=>(lt.has(e)||lt.set(e,ht(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),lt.get(e)),x=e=>t=>t*53^e,Fe=e=>e&3221225471|e>>>1&1073741824,Pr=e=>O(e,S),ht=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Fe(t)},B=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Fe(t)},Rr=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=w(B(t[r]),x(m(e[t[r]])));return Fe(n)},Fr=e=>Rr(e,Object.keys(e)),Lr=e=>{let t=6151;for(let n=0;n<e.length;n++)t=w(t,x(m(e[n])));return Fe(t)},$=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,S,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,S,{value(){return t},enumerable:!1}),t},v=Symbol.for("effect/Equal");function I(){return arguments.length===1?e=>Le(e,arguments[0]):Le(arguments[0],arguments[1])}function Le(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(tn(e)&&tn(t))return m(e)===m(t)&&e[v](t)?!0:M.enabled&&M.tester?M.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString();if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(M.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>Le(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&Le(e[o],t[o])))return M.tester?M.tester(e,t):!1;return!0}}return M.tester?M.tester(e,t):!1}}return M.enabled&&M.tester?M.tester(e,t):!1}const tn=e=>O(e,v),N=Symbol.for("nodejs.util.inspect.custom"),C=e=>{try{if(O(e,"toJSON")&&ct(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(C)}catch{return{}}return Jr(e)},T=e=>JSON.stringify(e,null,2),Br=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?nn(e,t):String(e)}catch{return String(e)}},nn=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(Be.fiberRefs!==void 0&&rn(o)?o[dt](Be.fiberRefs):o):o,t);return n=void 0,r},dt=Symbol.for("effect/Inspectable/Redactable"),rn=e=>typeof e=="object"&&e!==null&&dt in e,Be=se("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),Jr=e=>rn(e)&&Be.fiberRefs!==void 0?e[dt](Be.fiberRefs):e,P=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},Ur="Commit",Hr="Failure",Vr="WithRuntime",Dr=Symbol.for("effect/Effect"),Wr=Symbol.for("effect/Stream"),qr=Symbol.for("effect/Sink"),zr=Symbol.for("effect/Channel"),_e={_R:e=>e,_E:e=>e,_A:e=>e,_V:Qt()},Gr={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},Yr={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},be={[Dr]:_e,[Wr]:_e,[qr]:Gr,[zr]:Yr,[v](e){return this===e},[S](){return $(this,ft(this))},[Symbol.iterator](){return new en(new Re(this))},pipe(){return P(this,arguments)}},sn={[S](){return $(this,Fr(this))},[v](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&I(this[r],e[r])))return!1;return!0}},Kr={...{...be,_op:Ur},...sn},on=Symbol.for("effect/Option"),cn={...be,[on]:{_A:e=>e},[N](){return this.toJSON()},toString(){return T(this.toJSON())}},Xr=Object.assign(Object.create(cn),{_tag:"Some",_op:"Some",[v](e){return an(e)&&ln(e)&&I(this.value,e.value)},[S](){return $(this,x(m(this._tag))(m(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:C(this.value)}}}),Qr=m("None"),Zr=Object.assign(Object.create(cn),{_tag:"None",_op:"None",[v](e){return an(e)&&un(e)},[S](){return Qr},toJSON(){return{_id:"Option",_tag:this._tag}}}),an=e=>O(e,on),un=e=>e._tag==="None",ln=e=>e._tag==="Some",es=Object.create(Zr),ts=e=>{const t=Object.create(Xr);return t.value=e,t},fn=Symbol.for("effect/Either"),hn={...be,[fn]:{_R:e=>e},[N](){return this.toJSON()},toString(){return T(this.toJSON())}},ns=Object.assign(Object.create(hn),{_tag:"Right",_op:"Right",[v](e){return dn(e)&&os(e)&&I(this.right,e.right)},[S](){return x(m(this._tag))(m(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:C(this.right)}}}),rs=Object.assign(Object.create(hn),{_tag:"Left",_op:"Left",[v](e){return dn(e)&&ss(e)&&I(this.left,e.left)},[S](){return x(m(this._tag))(m(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:C(this.left)}}}),dn=e=>O(e,fn),ss=e=>e._tag==="Left",os=e=>e._tag==="Right",is=e=>{const t=Object.create(rs);return t.left=e,t},Je=e=>{const t=Object.create(ns);return t.right=e,t},pn=is,A=()=>es,Se=ts,R=un,ke=ln,cs=u(2,(e,t)=>R(e)?t():e.value)(Xt),gn=e=>Array.isArray(e)?e:Array.from(e),mn=e=>Array.from(e).reverse(),as=u(3,(e,t,n)=>gn(e).reduce((r,s,o)=>n(r,s,o),t)),yn=Symbol.for("effect/Chunk");function us(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const _n=[],ls=(e=>$r((t,n)=>t.length===n.length&&ve(t).every((r,s)=>e(r,ie(n,s)))))(I),fs={[yn]:{_A:e=>e},toString(){return T(this.toJSON())},toJSON(){return{_id:"Chunk",values:ve(this).map(C)}},[N](){return this.toJSON()},[v](e){return hs(e)&&ls(this,e)},[S](){return $(this,Lr(ve(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return _n[Symbol.iterator]();default:return ve(this)[Symbol.iterator]()}},pipe(){return P(this,arguments)}},E=e=>{const t=Object.create(fs);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=J,t.right=J;break}case"ISingleton":{t.length=1,t.depth=0,t.left=J,t.right=J;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=J,t.right=J;break}}return t},hs=e=>O(e,yn),J=E({_tag:"IEmpty"}),oe=()=>J,pt=(...e)=>ds(e),we=e=>E({_tag:"ISingleton",a:e}),gt=(e,t,n)=>{switch(e.backing._tag){case"IArray":{us(e.backing.array,0,t,n,e.length);break}case"IConcat":{gt(e.left,t,n),gt(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=ie(e,r),r+=1,s+=1;break}}},ve=e=>{switch(e.backing._tag){case"IEmpty":return _n;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return gt(e,t,0),e.backing={_tag:"IArray",array:t},e.left=J,e.right=J,e.depth=0,t}}},mt=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return E({_tag:"IArray",array:mn(e.backing.array)});case"IConcat":return E({_tag:"IConcat",left:mt(e.backing.right),right:mt(e.backing.left)});case"ISlice":return bn(mn(ve(e)))}},bn=e=>e.length===0?oe():e.length===1?we(e[0]):E({_tag:"IArray",array:e}),ds=e=>bn(e),ie=u(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?ie(e.left,t):ie(e.right,t-e.left.length);case"ISlice":return ie(e.backing.chunk,t+e.backing.offset)}}),Sn=u(2,(e,t)=>W(we(t),e)),W=u(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return E({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=W(e.right,t);return E({_tag:"IConcat",left:e.left,right:r})}else{const r=W(e.right.right,t);if(r.depth===e.depth-3){const s=E({_tag:"IConcat",left:e.right.left,right:r});return E({_tag:"IConcat",left:e.left,right:s})}else{const s=E({_tag:"IConcat",left:e.left,right:e.right.left});return E({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=W(e,t.left);return E({_tag:"IConcat",left:r,right:t.right})}else{const r=W(e,t.left.left);if(r.depth===t.depth-3){const s=E({_tag:"IConcat",left:r,right:t.left.right});return E({_tag:"IConcat",left:s,right:t.right})}else{const s=E({_tag:"IConcat",left:t.left.right,right:t.right});return E({_tag:"IConcat",left:r,right:s})}}}),ps=e=>e.length===0,kn=e=>e.length>0,wn=e=>ie(e,0),gs=Symbol.for("effect/Context/Tag"),yt=Symbol.for("effect/Context/Reference"),vn={...be,_op:"Tag",[Symbol.for("effect/STM")]:_e,[gs]:{_Service:e=>e,_Identifier:e=>e},toString(){return T(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[N](){return this.toJSON()},of(e){return e},context(e){return On(this,e)}},ms={...vn,[yt]:yt},ys=e=>()=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;function r(){}return Object.setPrototypeOf(r,vn),r.key=e,Object.defineProperty(r,"stack",{get(){return n.stack}}),r},_s=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,ms),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},En=Symbol.for("effect/Context"),bs={[En]:{_Services:e=>e},[v](e){if(ks(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!I(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[S](){return $(this,ht(this.unsafeMap.size))},pipe(){return P(this,arguments)},toString(){return T(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(C)}},[N](){return this.toJSON()}},_t=e=>{const t=Object.create(bs);return t.unsafeMap=e,t},Ss=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},ks=e=>O(e,En),On=(e,t)=>_t(new Map([[e.key,t]])),ws=u(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),_t(r)}),bt=se("effect/Context/defaultValueCache",()=>new Map),In=e=>{if(bt.has(e.key))return bt.get(e.key);const t=e.defaultValue();return bt.set(e.key,t),t},vs=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):In(t),Es=u(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(yt in t)return In(t);throw Ss(t)}return e.unsafeMap.get(t.key)}),Os=u(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return _t(n)}),Is=On,Cs=ws,Ns=Es,Ms=Os,Cn=ys,ce=_s,G=5,St=Math.pow(2,G),$s=St-1,Ts=St/2,As=St/4;function js(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function ae(e,t){return t>>>e&$s}function ue(e){return 1<<e}function Nn(e,t){return js(e&t-1)}const xs=(e,t)=>({value:e,previous:t});function le(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function Mn(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function Ps(e,t,n,r){const s=r.length;if(e){let a=s;for(;a>=t;)r[a--]=r[a];return r[t]=n,r}let o=0,i=0;const c=new Array(s+1);for(;o<t;)c[i++]=r[o++];for(c[t]=n;o<s;)c[++i]=r[o++];return c}class q{constructor(){l(this,"_tag","EmptyNode")}modify(t,n,r,s,o,i){const c=r(A());return R(c)?new q:(++i.value,new Y(t,s,o,c))}}function F(e){return jr(e,"EmptyNode")}function Rs(e){return F(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Ue(e,t){return F(e)?!1:t===e.edit}class Y{constructor(t,n,r,s){l(this,"edit");l(this,"hash");l(this,"key");l(this,"value");l(this,"_tag","LeafNode");this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(I(o,this.key)){const a=r(this.value);return a===this.value?this:R(a)?(--i.value,new q):Ue(this,t)?(this.value=a,this):new Y(t,s,o,a)}const c=r(A());return R(c)?this:(++i.value,$n(t,n,this.hash,this,s,new Y(t,s,o,c)))}}class kt{constructor(t,n,r){l(this,"edit");l(this,"hash");l(this,"children");l(this,"_tag","CollisionNode");this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const a=Ue(this,t),f=this.updateCollisionList(a,t,this.hash,this.children,r,o,i);return f===this.children?this:f.length>1?new kt(t,this.hash,f):f[0]}const c=r(A());return R(c)?this:(++i.value,$n(t,n,this.hash,this,s,new Y(t,s,o,c)))}updateCollisionList(t,n,r,s,o,i,c){const a=s.length;for(let d=0;d<a;++d){const p=s[d];if("key"in p&&I(i,p.key)){const k=p.value,b=o(k);return b===k?s:R(b)?(--c.value,Mn(t,d,s)):le(t,d,new Y(n,r,i,b),s)}}const f=o(A());return R(f)?s:(++c.value,le(t,a,new Y(n,r,i,f),s))}}class fe{constructor(t,n,r){l(this,"edit");l(this,"mask");l(this,"children");l(this,"_tag","IndexedNode");this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const c=this.mask,a=this.children,f=ae(n,s),d=ue(f),p=Nn(c,d),k=c&d,b=Ue(this,t);if(!k){const ne=new q().modify(t,n+G,r,s,o,i);return ne?a.length>=Ts?Ls(t,f,ne,c,a):new fe(t,c|d,Ps(b,p,ne,a)):this}const Ae=a[p],Z=Ae.modify(t,n+G,r,s,o,i);if(Ae===Z)return this;let ee=c,te;if(F(Z)){if(ee&=~d,!ee)return new q;if(a.length<=2&&Rs(a[p^1]))return a[p^1];te=Mn(b,p,a)}else te=le(b,p,Z,a);return b?(this.mask=ee,this.children=te,this):new fe(t,ee,te)}}class wt{constructor(t,n,r){l(this,"edit");l(this,"size");l(this,"children");l(this,"_tag","ArrayNode");this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let c=this.size;const a=this.children,f=ae(n,s),d=a[f],p=(d||new q).modify(t,n+G,r,s,o,i);if(d===p)return this;const k=Ue(this,t);let b;if(F(d)&&!F(p))++c,b=le(k,f,p,a);else if(!F(d)&&F(p)){if(--c,c<=As)return Fs(t,c,f,a);b=le(k,f,new q,a)}else b=le(k,f,p,a);return k?(this.size=c,this.children=b,this):new wt(t,c,b)}}function Fs(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const f=r[c];f&&!F(f)&&(s[o++]=f,i|=1<<c)}return new fe(e,i,s)}function Ls(e,t,n,r,s){const o=[];let i=r,c=0;for(let a=0;i;++a)i&1&&(o[a]=s[c++]),i>>>=1;return o[t]=n,new wt(e,c+1,o)}function Bs(e,t,n,r,s,o){if(n===s)return new kt(e,n,[o,r]);const i=ae(t,n),c=ae(t,s);if(i===c)return a=>new fe(e,ue(i)|ue(c),[a]);{const a=i<c?[r,o]:[o,r];return new fe(e,ue(i)|ue(c),a)}}function $n(e,t,n,r,s,o){let i,c=t;for(;;){const a=Bs(e,c,n,r,s,o);if(typeof a=="function")i=xs(a,i),c=c+G;else{let f=a;for(;i!=null;)f=i.value(f),i=i.previous;return f}}}const Tn="effect/HashMap",vt=Symbol.for(Tn),Js={[vt]:vt,[Symbol.iterator](){return new He(this,(e,t)=>[e,t])},[S](){let e=m(Tn);for(const t of this)e^=w(m(t[0]),x(m(t[1])));return $(this,e)},[v](e){if(Vs(e)){if(e._size!==this._size)return!1;for(const t of this){const n=w(e,Ds(t[0],m(t[0])));if(R(n))return!1;if(!I(t[1],n.value))return!1}return!0}return!1},toString(){return T(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(C)}},[N](){return this.toJSON()},pipe(){return P(this,arguments)}},Et=(e,t,n,r)=>{const s=Object.create(Js);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class He{constructor(t,n){l(this,"map");l(this,"f");l(this,"v");this.map=t,this.f=n,this.v=An(this.map._root,this.f,void 0)}next(){if(R(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=Ve(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new He(this.map,this.f)}}const Ve=e=>e?jn(e[0],e[1],e[2],e[3],e[4]):A(),An=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return ke(e.value)?Se({value:t(e.key,e.value.value),cont:n}):Ve(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return jn(r.length,r,0,t,n)}default:return Ve(n)}},jn=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!F(o))return An(o,r,[e,t,n,r,s])}return Ve(s)},Us=Et(!1,0,new q,0),Hs=()=>Us,Vs=e=>O(e,vt),Ds=u(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return I(t,r.key)?r.value:A();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,c=o.length;i<c;++i){const a=o[i];if("key"in a&&I(t,a.key))return a.value}}return A()}case"IndexedNode":{const o=ae(s,n),i=ue(o);if(r.mask&i){r=r.children[Nn(r.mask,i)],s+=G;break}return A()}case"ArrayNode":{if(r=r.children[ae(s,n)],r){s+=G;break}return A()}default:return A()}}),xn=u(3,(e,t,n)=>Gs(e,t,()=>Se(n))),Ws=u(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:Et(e._editable,e._edit,t,n)),qs=e=>new He(e,t=>t),Ot=e=>e._size,zs=e=>Et(!0,e._edit+1,e._root,e._size),Gs=u(3,(e,t,n)=>Ys(e,t,m(t),n)),Ys=u(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return w(e,Ws(o,s.value))}),Ks=u(2,(e,t)=>Xs(e,void 0,(n,r,s)=>t(r,s))),Xs=u(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return ke(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,c=o.length;i<c;){const a=o[i++];a&&!F(a)&&(a._tag==="LeafNode"?ke(a.value)&&(t=n(t,a.value.value,a.key)):s.push(a.children))}return t}),Pn="effect/HashSet",It=Symbol.for(Pn),Qs={[It]:It,[Symbol.iterator](){return qs(this._keyMap)},[S](){return $(this,x(m(this._keyMap))(m(Pn)))},[v](e){return Zs(e)?Ot(this._keyMap)===Ot(e._keyMap)&&I(this._keyMap,e._keyMap):!1},toString(){return T(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(C)}},[N](){return this.toJSON()},pipe(){return P(this,arguments)}},Ct=e=>{const t=Object.create(Qs);return t._keyMap=e,t},Zs=e=>O(e,It),eo=Ct(Hs()),Rn=()=>eo,to=e=>Ot(e._keyMap),no=e=>Ct(zs(e._keyMap)),ro=e=>(e._keyMap._editable=!1,e),so=u(2,(e,t)=>{const n=no(e);return t(n),ro(n)}),Nt=u(2,(e,t)=>e._keyMap._editable?(xn(t,!0)(e._keyMap),e):Ct(xn(t,!0)(e._keyMap))),oo=u(2,(e,t)=>so(Rn(),n=>{io(e,r=>Nt(n,r));for(const r of t)Nt(n,r)})),io=u(2,(e,t)=>Ks(e._keyMap,(n,r)=>t(r))),De=Rn,co=to,Mt=Nt,$t=oo,ao=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=sn,e}(),Fn="Die",Tt="Empty",At="Fail",Ln="Interrupt",Ee="Parallel",Oe="Sequential",Bn="effect/Cause",Jn=Symbol.for(Bn),uo={_E:e=>e},jt={[Jn]:uo,[S](){return w(m(Bn),x(m(go(this))),$(this))},[v](e){return fo(e)&&po(this,e)},pipe(){return P(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:C(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:C(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:C(this.left),right:C(this.right)}}},toString(){return Wn(this)},[N](){return this.toJSON()}},xt=e=>{const t=Object.create(jt);return t._tag=At,t.error=e,t},lo=(e,t)=>{const n=Object.create(jt);return n._tag=Ee,n.left=e,n.right=t,n},We=(e,t)=>{const n=Object.create(jt);return n._tag=Oe,n.left=e,n.right=t,n},fo=e=>O(e,Jn),ho=e=>Dn(void 0,yo)(e),po=(e,t)=>{let n=we(e),r=we(t);for(;kn(n)&&kn(r);){const[s,o]=w(wn(n),Vn([De(),oe()],([a,f],d)=>{const[p,k]=Pt(d);return Se([w(a,$t(p)),w(f,W(k))])})),[i,c]=w(wn(r),Vn([De(),oe()],([a,f],d)=>{const[p,k]=Pt(d);return Se([w(a,$t(p)),w(f,W(k))])}));if(!I(s,i))return!1;n=o,r=c}return!0},go=e=>mo(we(e),oe()),mo=(e,t)=>{for(;;){const[n,r]=w(e,as([De(),oe()],([o,i],c)=>{const[a,f]=Pt(c);return[w(o,$t(a)),w(i,W(f))]})),s=co(n)>0?w(t,Sn(n)):t;if(ps(r))return mt(s);e=r,t=s}throw new Error(at("Cause.flattenCauseLoop"))},Pt=e=>{let t=e;const n=[];let r=De(),s=oe();for(;t!==void 0;)switch(t._tag){case Tt:{if(n.length===0)return[r,s];t=n.pop();break}case At:{if(r=Mt(r,pt(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case Fn:{if(r=Mt(r,pt(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Ln:{if(r=Mt(r,pt(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case Oe:{switch(t.left._tag){case Tt:{t=t.right;break}case Oe:{t=We(t.left.left,We(t.left.right,t.right));break}case Ee:{t=lo(We(t.left.left,t.right),We(t.left.right,t.right));break}default:{s=Sn(s,t.right),t=t.left;break}}break}case Ee:{n.push(t.right),t=t.left;break}}throw new Error(at("Cause.evaluateCauseLoop"))},yo={emptyCase:Yt,failCase:Kt,dieCase:Kt,interruptCase:Yt,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},Un="SequentialCase",Hn="ParallelCase",Vn=u(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=ke(i)?i.value:r,s._tag){case Oe:{o.push(s.right),s=s.left;break}case Ee:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),Dn=u(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case Tt:{s.push(Je(n.emptyCase(t)));break}case At:{s.push(Je(n.failCase(t,i.error)));break}case Fn:{s.push(Je(n.dieCase(t,i.defect)));break}case Ln:{s.push(Je(n.interruptCase(t,i.fiberId)));break}case Oe:{r.push(i.right),r.push(i.left),s.push(pn({_tag:Un}));break}case Ee:{r.push(i.right),r.push(i.left),s.push(pn({_tag:Hn}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case Un:{const c=o.pop(),a=o.pop(),f=n.sequentialCase(t,c,a);o.push(f);break}case Hn:{const c=o.pop(),a=o.pop(),f=n.parallelCase(t,c,a);o.push(f);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),Wn=(e,t)=>ho(e)?"All fibers interrupted without errors.":wo(e).map(function(n){return(t==null?void 0:t.renderErrorCause)!==!0||n.cause===void 0?n.stack:`${n.stack} {
${qn(n.cause,"  ")}
}`}).join(`
`),qn=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${qn(e.cause,`${t}  `)}
${t}}`),r};class qe extends globalThis.Error{constructor(n){const r=typeof n=="object"&&n!==null,s=Error.stackTraceLimit;Error.stackTraceLimit=1;super(_o(n),r&&"cause"in n&&typeof n.cause<"u"?{cause:new qe(n.cause)}:void 0);l(this,"span");this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=s,this.name=n instanceof Error?n.name:"Error",r&&(Ie in n&&(this.span=n[Ie]),Object.keys(n).forEach(o=>{o in this||(this[o]=n[o])})),this.stack=ko(`${this.name}: ${this.message}`,n instanceof Error&&n.stack?n.stack:"",this.span)}}const _o=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(O(e,"toString")&&ct(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return nn(e)},bo=/\((.*)\)/g,So=se("effect/Tracer/spanToTrace",()=>new WeakMap),ko=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const c=So.get(o);if(typeof c=="function"){const a=c();if(typeof a=="string"){const f=a.matchAll(bo);let d=!1;for(const[,p]of f)d=!0,r.push(`    at ${o.name} (${p})`);d||r.push(`    at ${o.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=cs(o.parent),i++}}return r.join(`
`)},Ie=Symbol.for("effect/SpanAnnotation"),wo=e=>Dn(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new qe(n)],failCase:(t,n)=>[new qe(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]});class ze{constructor(t){l(this,"self");l(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new ze(this.self)}}const Rt=Symbol.for("effect/Effect");class vo{constructor(t){l(this,"_op");l(this,"effect_instruction_i0");l(this,"effect_instruction_i1");l(this,"effect_instruction_i2");l(this,"trace");l(this,_r,_e);this._op=t}[(_r=Rt,v)](t){return this===t}[S](){return $(this,ft(this))}pipe(){return P(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:C(this.effect_instruction_i0),effect_instruction_i1:C(this.effect_instruction_i1),effect_instruction_i2:C(this.effect_instruction_i2)}}toString(){return T(this.toJSON())}[N](){return this.toJSON()}[Symbol.iterator](){return new ze(new Re(this))}}class Eo{constructor(t){l(this,"_op");l(this,"effect_instruction_i0");l(this,"effect_instruction_i1");l(this,"effect_instruction_i2");l(this,"trace");l(this,br,_e);this._op=t,this._tag=t}[(br=Rt,v)](t){return $o(t)&&t._op==="Failure"&&I(this.effect_instruction_i0,t.effect_instruction_i0)}[S](){return w(B(this._tag),x(m(this.effect_instruction_i0)),$(this))}get cause(){return this.effect_instruction_i0}pipe(){return P(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return T(this.toJSON())}[N](){return this.toJSON()}[Symbol.iterator](){return new ze(new Re(this))}}const Oo=e=>O(e,Rt),Io=e=>{const t=new vo(Vr);return t.effect_instruction_i0=e,t},zn=Symbol.for("effect/OriginalAnnotation"),Co=(e,t)=>ke(t)?new Proxy(e,{has(n,r){return r===Ie||r===zn||r in n},get(n,r){return r===Ie?t.value:r===zn?e:n[r]}}):e,No=e=>Zt(e)&&!(Ie in e)?Io(t=>Gn(xt(Co(e,To(t))))):Gn(xt(e)),Gn=e=>{const t=new Eo(Hr);return t.effect_instruction_i0=e,t},Mo=function(){class e extends globalThis.Error{commit(){return No(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[N](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?Wn(xt(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,Kr),e}(),$o=e=>Oo(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),To=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?Se(t):A()},Ft=ao,Ao=e=>{class t extends Ft{constructor(){super(...arguments);l(this,"_tag",e)}}return t},jo=function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends Mo{constructor(n){super(n==null?void 0:n.message,n!=null&&n.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError}(),Lt=e=>{const t={BaseEffectError:class extends jo{constructor(){super(...arguments);l(this,"_tag",e)}}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},xo=be,Yn=Symbol.for("effect/Micro"),Ge=Symbol.for("effect/Micro/MicroExit"),Ce=e=>typeof e=="object"&&e!==null&&Yn in e,Kn=Symbol.for("effect/Micro/MicroCause"),Po={_E:g};class Bt extends globalThis.Error{constructor(n,r,s){const o=`MicroCause.${n}`;let i,c,a;if(r instanceof globalThis.Error){i=`(${o}) ${r.name}`,c=r.message;const f=c.split(`
`).length;a=r.stack?`(${o}) ${r.stack.split(`
`).slice(0,f+3).join(`
`)}`:`${i}: ${c}`}else i=o,c=Br(r,0),a=`${i}: ${c}`;s.length>0&&(a+=`
    ${s.join(`
    `)}`);super(c);l(this,"_tag");l(this,"traces");l(this,Sr);this._tag=n,this.traces=s,this[Kn]=Po,this.name=i,this.stack=a}pipe(){return P(this,arguments)}toString(){return this.stack}[(Sr=Kn,N)](){return this.stack}}class Ro extends Bt{constructor(n,r=[]){super("Fail",n,r);l(this,"error");this.error=n}}const Fo=(e,t=[])=>new Ro(e,t);class Lo extends Bt{constructor(n,r=[]){super("Die",n,r);l(this,"defect");this.defect=n}}const Bo=(e,t=[])=>new Lo(e,t);class Jo extends Bt{constructor(t=[]){super("Interrupt","interrupted",t)}}const Uo=(e=[])=>new Jo(e),Ho=e=>e._tag==="Fail",Xn=e=>e._tag==="Interrupt",Qn=Symbol.for("effect/Micro/MicroFiber"),Vo={_A:g,_E:g};kr=Qn;class Zn{constructor(t,n=!0){l(this,"context");l(this,"interruptible");l(this,kr);l(this,"_stack",[]);l(this,"_observers",[]);l(this,"_exit");l(this,"_children");l(this,"currentOpCount",0);l(this,"_interrupted",!1);l(this,"_yielded");this.context=t,this.interruptible=n,this[Qn]=Vo}getRef(t){return vs(this.context,t)}addObserver(t){return this._exit?(t(this._exit),Mr):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Ht))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===he)return;const r=er.interruptChildren&&er.interruptChildren(this);if(r!==void 0)return this.evaluate(j(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(rt).shouldYield(this)){n=!0;const s=r;r=j(rr,()=>s)}if(r=r[Jt](this),r===he){const s=this._yielded;return Ge in s?(this._yielded=void 0,s):he}}}catch(s){return O(r,Jt)?nt(s):nt(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[Ye]&&n[Ye](this);if(r)return{[t]:r};if(n[t])return n}}yieldWith(t){return this._yielded=t,he}children(){return this._children??(this._children=new Set)}}const er=se("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),Do=e=>Ze(t=>Ke(e.addObserver(n=>t(_(n))))),Wo=e=>X(()=>(e.unsafeInterrupt(),Qo(Do(e)))),qo=e=>X(()=>{for(const r of e)r.unsafeInterrupt();const t=e[Symbol.iterator](),n=X(()=>{let r=t.next();for(;!r.done;){if(r.value.unsafePoll()){r=t.next();continue}const s=r.value;return Ze(o=>{s.addObserver(i=>{o(n)})})}return ge});return n}),tr=Symbol.for("effect/Micro/identifier"),h=Symbol.for("effect/Micro/args"),Jt=Symbol.for("effect/Micro/evaluate"),U=Symbol.for("effect/Micro/successCont"),K=Symbol.for("effect/Micro/failureCont"),Ye=Symbol.for("effect/Micro/ensureCont"),he=Symbol.for("effect/Micro/Yield"),zo={_A:g,_E:g,_R:g},Go={...xo,_op:"Micro",[Yn]:zo,pipe(){return P(this,arguments)},[Symbol.iterator](){return new en(new Re(this))},toJSON(){return{_id:"Micro",op:this[tr],...h in this?{args:this[h]}:void 0}},toString(){return T(this)},[N](){return T(this)}};function Yo(e){return nt("Micro.evaluate: Not implemented")}const Ne=e=>({...Go,[tr]:e.op,[Jt]:e.eval??Yo,[U]:e.contA,[K]:e.contE,[Ye]:e.ensure}),H=e=>{const t=Ne(e);return function(){const n=Object.create(t);return n[h]=e.single===!1?arguments:arguments[0],n}},nr=e=>{const t={...Ne(e),[Ge]:Ge,_tag:e.op,get[e.prop](){return this[h]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[h]}},[v](n){return ni(n)&&n._tag===e.op&&I(this[h],n[h])},[S](){return $(this,x(B(e.op))(m(this[h])))}};return function(n){const r=Object.create(t);return r[h]=n,r[U]=void 0,r[K]=void 0,r[Ye]=void 0,r}},_=nr({op:"Success",prop:"value",eval(e){const t=e.getCont(U);return t?t[U](this[h],e):e.yieldWith(this)}}),de=nr({op:"Failure",prop:"cause",eval(e){let t=e.getCont(K);for(;Xn(this[h])&&t&&e.interruptible;)t=e.getCont(K);return t?t[K](this[h],e):e.yieldWith(this)}}),V=e=>de(Fo(e)),Ke=H({op:"Sync",eval(e){const t=this[h](),n=e.getCont(U);return n?n[U](t,e):e.yieldWith(et(t))}}),X=H({op:"Suspend",eval(e){return this[h]()}}),rr=H({op:"Yield",eval(e){let t=!1;return e.getRef(rt).scheduleTask(()=>{t||e.evaluate(ge)},this[h]??0),e.yieldWith(()=>{t=!0})}})(0),Xe=_(void 0),sr=e=>X(()=>{try{return _(e.try())}catch(t){return V(e.catch(t))}}),Qe=e=>or(function(t,n){try{e.try(n).then(r=>t(_(r)),r=>t(V(e.catch(r))))}catch(r){t(V(e.catch(r)))}},e.try.length!==0),pe=H({op:"WithMicroFiber",eval(e){return this[h](e)}}),or=H({op:"Async",single:!1,eval(e){const t=this[h][0];let n=!1,r=!1;const s=this[h][1]?new AbortController:void 0,o=t(i=>{n||(n=!0,r?e.evaluate(i):r=i)},s==null?void 0:s.signal);return r!==!1?r:(r=!0,e._yielded=()=>{n=!0},s===void 0&&o===void 0||e._stack.push(Ko(()=>(n=!0,s==null||s.abort(),o??ge))),he)}}),Ko=H({op:"AsyncFinalizer",ensure(e){e.interruptible&&(e.interruptible=!1,e._stack.push(Wt(!0)))},contE(e,t){return Xn(e)?j(this[h](),()=>de(e)):de(e)}}),Ze=e=>or(e,e.length>=2),Q=(...e)=>X(()=>Xo(e.length===1?e[0]():e[1].call(e[0]))),Xo=H({op:"Iterator",contA(e,t){const n=this[h].next(e);return n.done?_(n.value):(t._stack.push(this),xr(n.value))},eval(e){return this[U](void 0,e)}}),ir=u(2,(e,t)=>ti(e,n=>t)),D=u(2,(e,t)=>j(e,n=>{const r=Ce(t)?t:typeof t=="function"?t(n):t;return Ce(r)?r:_(r)})),Ut=u(2,(e,t)=>j(e,n=>{const r=Ce(t)?t:typeof t=="function"?t(n):t;return Ce(r)?ir(r,n):_(n)})),Qo=e=>j(e,t=>ge),Zo=e=>fi(e,{onFailure:tt,onSuccess:et}),j=u(2,(e,t)=>{const n=Object.create(ei);return n[h]=e,n[U]=t,n}),ei=Ne({op:"OnSuccess",eval(e){return e._stack.push(this),this[h]}}),ti=u(2,(e,t)=>j(e,n=>_(t(n)))),ni=e=>O(e,Ge),et=_,tt=de,Ht=tt(Uo()),nt=e=>tt(Bo(e)),ge=et(void 0),ri="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class cr{constructor(){l(this,"tasks",[]);l(this,"running",!1);l(this,"afterScheduled",()=>{this.running=!1,this.runTasks()})}scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,ri(this.afterScheduled))}runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(si)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const L=e=>pe(t=>_(Ns(t.context,e))),ar=u(2,(e,t)=>pe(n=>{const r=n.context;return n.context=t(r),di(e,()=>(n.context=r,Xe))})),ur=u(2,(e,t)=>ar(e,Ms(t))),Vt=u(3,(e,t,n)=>ar(e,Cs(t,n)));class si extends ce()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class rt extends ce()("effect/Micro/currentScheduler",{defaultValue:()=>new cr}){}const oi=u(2,(e,t)=>X(()=>{const n=t.schedule?Date.now():0;let r=0;const s=j(Zo(e),o=>{if(t.while!==void 0&&!t.while(o))return o;if(t.times!==void 0&&r>=t.times)return o;r++;let i=rr;if(t.schedule!==void 0){const c=Date.now()-n,a=t.schedule(r,c);if(R(a))return o;i=fr(a.value)}return j(i,()=>s)});return s})),ii=u(e=>Ce(e[0]),(e,t)=>oi(e,{...t,while:n=>n._tag==="Success"&&((t==null?void 0:t.while)===void 0||t.while(n.value))})),ci=u(2,(e,t)=>{const n=Object.create(ai);return n[h]=e,n[K]=t,n}),ai=Ne({op:"OnFailure",eval(e){return e._stack.push(this),this[h]}}),ui=u(3,(e,t,n)=>ci(e,r=>t(r)?n(r):de(r))),Dt=u(2,(e,t)=>ui(e,Ho,n=>t(n.error))),lr=u(2,(e,t)=>{const n=Object.create(li);return n[h]=e,n[U]=t.onSuccess,n[K]=t.onFailure,n}),li=Ne({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[h]}}),fi=u(2,(e,t)=>lr(e,{onFailure:n=>Ke(()=>t.onFailure(n)),onSuccess:n=>Ke(()=>t.onSuccess(n))})),fr=e=>Ze(t=>{const n=setTimeout(()=>{t(Xe)},e);return Ke(()=>{clearTimeout(n)})}),hi=u(2,(e,t)=>D(fr(t),e)),di=u(2,(e,t)=>gi(n=>lr(n(e),{onFailure:r=>j(t(tt(r)),()=>de(r)),onSuccess:r=>j(t(et(r)),()=>_(r))}))),Wt=H({op:"SetInterruptible",ensure(e){if(e.interruptible=this[h],e._interrupted&&e.interruptible)return()=>Ht}}),pi=e=>pe(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(Wt(!1)),t._interrupted?Ht:e)),gi=e=>pe(t=>t.interruptible?(t.interruptible=!1,t._stack.push(Wt(!0)),e(pi)):e(g)),mi=H({op:"While",contA(e,t){return this[h].step(e),this[h].while()?(t._stack.push(this),this[h].body()):ge},eval(e){return this[h].while()?(e._stack.push(this),this[h].body()):ge}}),yi=(e,t,n)=>pe(r=>{const s=n==null?void 0:n.concurrency,o=Math.max(1,s),i=gn(e);let c=i.length;if(c===0)return n!=null&&n.discard?Xe:_([]);const a=n!=null&&n.discard?void 0:new Array(c);let f=0;return o===1?ir(mi({while:()=>f<i.length,body:()=>t(i[f],f),step:a?d=>a[f++]=d:d=>f++}),a):Ze(d=>{const p=new Set;let k,b=0,Ae=0,Z=!1,ee=!1;function te(){for(Z=!0;b<o&&f<c;){const ne=f,Gi=i[ne];f++,b++;try{const je=hr(r,t(Gi,ne),!0,!0);p.add(je),je.addObserver(xe=>{p.delete(je),!ee&&(xe._tag==="Failure"?k===void 0&&(k=xe,c=f,p.forEach(Yi=>Yi.unsafeInterrupt())):a!==void 0&&(a[ne]=xe.value),Ae++,b--,Ae===c?d(k??_(a)):!Z&&b<o&&te())})}catch(je){k=nt(je),c=f,p.forEach(xe=>xe.unsafeInterrupt())}}Z=!1}return te(),X(()=>(ee=!0,f=c,qo(p)))})}),hr=(e,t,n=!1,r=!1)=>{const s=new Zn(e.context,e.interruptible);return r||(e.children().add(s),s.addObserver(()=>e.children().delete(s))),n?s.evaluate(t):e.getRef(rt).scheduleTask(()=>s.evaluate(t),0),s},_i=e=>pe(t=>_(hr(t,e,!1,!0))),bi=(e,t)=>{const n=new Zn(rt.context((t==null?void 0:t.scheduler)??new cr));if(n.evaluate(e),t!=null&&t.signal)if(t.signal.aborted)n.unsafeInterrupt();else{const r=()=>n.unsafeInterrupt();t.signal.addEventListener("abort",r,{once:!0}),n.addObserver(()=>t.signal.removeEventListener("abort",r))}return n},Si=(e,t)=>new Promise((n,r)=>{bi(e,t).addObserver(n)}),dr=(e,t)=>Si(e,t).then(n=>{if(n._tag==="Failure")throw n.cause;return n.value}),ki=e=>{let t=e[0];for(let n=1;n<e.length;n++)t+=e[n]==="_"?e[++n].toUpperCase():e[n];return t};var wi=(z=class extends Ao("BotResponse"){static make(t){return new z({response:t})}},l(z,"ignore",new z({})),z),st=class extends Lt("TgBotClientError"){},vi=e=>typeof e=="object"&&e!=null&&"file_content"in e&&e.file_content instanceof Uint8Array&&"file_name"in e&&typeof e.file_name=="string",Ei=e=>typeof e=="object"&&e!=null&&"ok"in e&&typeof e.ok=="boolean",Oi="https://api.telegram.org",Ii={"🔥":"5104841245755180586","👍":"5107584321108051014","👎":"5104858069142078462","❤️":"5159385139981059251","🎉":"5046509860389126442","💩":"5046589136895476101"},Ci=class extends ce()("TgBotApiBaseUrl",{defaultValue:()=>Oi}){},pr=class extends Cn("TgBotApiToken")(){},Ni=e=>{let t=Object.entries(e);if(t.length==0)return;let n=new FormData;for(let[r,s]of t)s&&(typeof s!="object"?n.append(r,`${s}`):vi(s)?n.append(r,new Blob([s.file_content]),s.file_name):n.append(r,JSON.stringify(s)));return n},qt=(e,t)=>Q(function*(){let n=yield*L(pr),r=yield*L(Ci),s=yield*Qe({try:()=>fetch(`${r}/bot${n}/${ki(e)}`,{body:Ni(t)??null,method:"POST"}),catch:i=>new st({cause:{_tag:"ClientInternalError",cause:i}})}),o=yield*Qe({try:()=>s.json(),catch:()=>new st({cause:{_tag:"NotJsonResponse",response:s}})});return Ei(o)?s.ok?o.result:yield*V(new st({cause:{_tag:"NotOkResponse",...o.error_code?{errorCode:o.error_code}:void 0,...o.description?{details:o.description}:void 0}})):yield*V(new st({cause:{_tag:"UnexpectedResponse",response:o}}))}),zt=class extends Cn("BotUpdateHandlers")(){},gr=class Nr extends Ft{static make(t){let n=t.batch_size??10,r=t.poll_timeout??10,s=t.max_empty_responses,o=t.log_level??"info",i=t.on_error;(n<10||n>100)&&(console.warn("Wrong batch_size, must be in [10..100], using 10 instead"),n=10),(r<2||r>120)&&(console.warn("Wrong poll_timeout, must be in [2..120], using 20 instead"),r=20),s&&s<2&&(console.warn("Wrong max_empty_responses, must be in [2..infinity], using infinity"),s=void 0),o||(o="info"),i||(i="stop");let c=new Nr({batch_size:n,poll_timeout:r,max_empty_responses:s,log_level:o,on_error:i});return console.log("bot poll settings",c),c}},me=class extends ce()("BotSettings",{defaultValue(){return gr.make({})}}){},Mi=e=>{for(let[t,n]of Object.entries(e))if(t!="update_id")return{type:t,...n}},Gt=class extends Ft{},$i=e=>Q(function*(){let t=yield*L(me),n=yield*L(zt);return n.type=="single"?yield*Ai(e,n,t):yield*Ti(e,n)}),Ti=(e,t)=>sr({try:()=>t.on_batch(e),catch:g}).pipe(D(n=>n instanceof Promise?Qe({try:()=>n,catch:g}):_(n)),D(n=>new Gt({hasErrors:!n,updates:e})),Dt(n=>(console.warn("handle batch error",{errorMessage:n instanceof Error?n.message:void 0,updates:e.map(r=>Object.keys(r).at(1)),error:n}),_(new Gt({hasErrors:!0,updates:e}))))),ot=class extends Lt("HandleUpdateError"){},Ai=(e,t,n)=>yi(e,r=>ji(r,t).pipe(Dt(s=>(console.log("update handle error",{updateId:r.update_id,updateKey:Object.keys(r).at(1),name:s._tag,...s.cause instanceof Error?{error:s.cause.message}:void 0}),_(s)))),{concurrency:10}).pipe(D(r=>(n.log_level=="debug"&&console.debug("handle batch result",r),new Gt({hasErrors:!r.every(s=>s==null),updates:e})))),ji=(e,t)=>Q(function*(){let n=Mi(e);if(!n)return yield*V(new ot({name:"UnknownUpdate",update:e}));let r=t[`on_${n.type}`];if(!r)return yield*V(new ot({name:"HandlerNotDefined",update:e}));n.type=="message"&&"text"in n&&console.info("Got a new text message",{chatId:n.chat.id,chatType:n.chat.type,message:`${n.text.slice(0,5)}...`});let s,o=yield*sr({try:()=>r(n),catch:c=>new ot({name:"BotHandlerError",update:e,cause:c})}).pipe(D(c=>c instanceof Promise?Qe({try:()=>c,catch:a=>new ot({name:"BotHandlerError",update:e,cause:a})}):_(c)),Dt(c=>{var a,f;return s=c,console.log("error",{updateId:e.update_id,updateKey:Object.keys(e).at(1),name:c._tag,...c.cause instanceof Error?{error:c.cause.message}:void 0}),_(wi.make({type:"message",text:`Some internal error has happend(${c.name}) while handling this message`,message_effect_id:Ii["💩"],...(a=e.message)!=null&&a.message_id?{reply_parameters:{message_id:(f=e.message)==null?void 0:f.message_id}}:void 0}))})),i=yield*L(me);if(!o&&i.log_level=="debug"){console.log(`Bot response is undefined for update with ID #${e.update_id}.`);return}if("chat"in n&&o.response){let c=yield*qt(`send_${o.response.type}`,{...o.response,chat_id:n.chat.id});i.log_level=="debug"&&console.debug("bot response",c)}return s}),xi=class extends ce()("BotFetchUpdatesService",{defaultValue:()=>{let e={lastUpdateId:void 0,emptyResponses:0},t=Pi(e).pipe(Ut(r=>{let s=r.map(o=>o.update_id).sort().at(-1);console.log("updating last update id",s),e.lastUpdateId=s?s+1:void 0,console.log(e)})),n=Ri(e);return{state:e,fetchUpdates:t,commit:n}}}){},mr=class extends Lt("FetchUpdatesError"){},Pi=e=>Q(function*(){let t=yield*L(me);if(t.max_empty_responses&&e.emptyResponses==t.max_empty_responses)return yield*V(new mr({name:"TooManyEmptyResponses"}));let n=e.lastUpdateId;t.log_level=="debug"&&console.debug("getting updates",e);let r=yield*qt("get_updates",{timeout:t.poll_timeout,...n?{offset:n}:void 0}).pipe(D(s=>s.sort(o=>o.update_id)));return r.length?(console.debug(`got a batch of updates (${r.length})`),e.emptyResponses=0,r):(e.emptyResponses+=1,[])}),Ri=e=>Q(function*(){return console.log("commit",{pollState:e}),e.lastUpdateId?yield*qt("get_updates",{offset:e.lastUpdateId,limit:0}).pipe(D(D(L(me),t=>{t.log_level=="debug"&&console.debug("committed offset",e)}))):yield*V(new mr({name:"NoUpdatesToCommit"}))}),Fi=class extends ce()("BotRunService",{defaultValue:()=>{console.log("Initiating BotRunService");let e={fiber:void 0};return{runBotInBackground:Li(e),getFiber:()=>e.fiber}}}){},Li=e=>Q(function*(){console.log("running telegram chat bot");let t=yield*L(xi),n=yield*L(me),r=o=>n.on_error=="continue"?!0:!o,s=hi(1e3)(t.fetchUpdates.pipe(D($i),Ut(o=>o.updates.length>0&&r(o.hasErrors)?t.commit:Xe))).pipe(ii({while:o=>r(o.hasErrors)}),_i,Ut(o=>o.addObserver(i=>{console.log("bot's fiber has been closed",i)})));e.fiber&&(console.log("killing previous bot's fiber"),yield*Wo(e.fiber)),e.fiber=yield*s,console.log("Fetching bot updates via long polling...")}),Bi=e=>Q(function*(){let t=yield*L(Fi),n=Is(pr,e.bot_token);return yield*t.runBotInBackground.pipe(Vt(zt,e.mode),Vt(me,gr.make(e.poll??{})),ur(n)),{reload:r=>t.runBotInBackground.pipe(Vt(zt,r),ur(n),dr),fiber:t.getFiber}}),Ji=e=>Bi(e).pipe(dr);const Ui=e=>typeof e=="object"&&e!=null&&"command"in e&&"token"in e&&"code"in e,Hi="0.6.2",it="@effect-ak/tg-bot-client",yr="mjs",Me="https://cdn.jsdelivr.net/npm",$e=`${it}@${Hi}/dist`,Vi=[{entryName:"index",packageName:it,dts_url:`${Me}/${$e}/index.d.ts`,js_url:`${Me}/${$e}/index.${yr}`},{entryName:"bot",packageName:it,dts_url:`${Me}/${$e}/bot.d.ts`,js_url:`${Me}/${$e}/bot-bundle.${yr}`},{entryName:"config-BFdBOrJI",packageName:it,dts_url:`${Me}/${$e}/config-BFdBOrJI.d.ts`}],Di=e=>{let t=e;for(const{js_url:n,packageName:r,entryName:s}of Object.values(Vi))!r||!n||!s||(t=t.replaceAll(r+"/"+s,n));return t};async function Wi(e){const t=Di(e);console.log("prepared code",t);const n=new Blob([t],{type:"application/javascript"}),r=URL.createObjectURL(n);try{const s=await import(r);return s.default?s.default:void 0}catch(s){console.log("Can't load handlers",s);return}finally{URL.revokeObjectURL(r)}}const qi=zi();self.onmessage=e=>qi(e.data);function zi(){let e=0,t;console.log("creating web worker");const n=s=>self.postMessage({type:"from-worker",data:s,message_id:e++}),r=async s=>{var i;const o=await Wi(s.code);if(!o){n({error:"handlers doesn't return default",command:s});return}if(console.log("worker got run-bot command"),t){await t.reload({type:"single",...o}),n({newBotState:"reloaded"});return}t=await Ji({bot_token:s.token,poll:{on_error:"continue"},mode:{type:"single",...o}}),(i=t.fiber())==null||i.addObserver(c=>{n({success:"Bot's fiber has been shutdown",exit:c,newBotState:"stopped"})}),n({success:"Bot's fiber has been created",newBotState:"active"})};return async s=>{if(!Ui(s)){n({error:"not a run bot command",command:s});return}await r(s)}}})();
