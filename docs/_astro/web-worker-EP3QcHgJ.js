(function(){"use strict";const yr=e=>typeof e=="function",l=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(c){return t(c,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},R=e=>e,tt=e=>()=>e,Wt=tt(!0),qt=tt(!1),zt=tt(void 0),_r=zt;function b(e,t,n,r,s,o,i,c,a){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return c(i(o(s(r(n(t(e)))))));case 9:return a(c(i(o(s(r(n(t(e))))))));default:{let u=arguments[0];for(let h=1;h<arguments.length;h++)u=arguments[h](u);return u}}}const br=e=>(t,n)=>t===n||e(t,n);let Sr="3.16.8";const Gt=()=>Sr,Yt=`effect/GlobalValue/globalStoreId/${Gt()}`;let de;const ee=(e,t)=>(de||(globalThis[Yt]??=new Map,de=globalThis[Yt]),de.has(e)||de.set(e,t()),de.get(e)),nt=yr,kr=e=>typeof e=="object"&&e!==null,Kt=e=>kr(e)||nt(e),w=l(2,(e,t)=>Kt(e)&&t in e),wr=l(2,(e,t)=>w(e,"_tag")&&e._tag===t),rt=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let Xt=class gr{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new gr(this.self)}};const st=Symbol.for("effect/Utils/YieldWrap");class $e{#e;constructor(t){this.#e=t}[st](){return this.#e}}function vr(e){if(typeof e=="object"&&e!==null&&st in e)return e[st]();throw new Error(rt("yieldWrapGet"))}const I=ee("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),ot=ee(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),y=Symbol.for("effect/Hash"),p=e=>{if(I.enabled===!0)return 0;switch(typeof e){case"number":return ct(e);case"bigint":return F(e.toString(10));case"boolean":return F(String(e));case"symbol":return F(String(e));case"string":return F(e);case"undefined":return F("undefined");case"function":case"object":return e===null?F("null"):e instanceof Date?p(e.toISOString()):e instanceof URL?p(e.href):Er(e)?e[y]():it(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},it=e=>(ot.has(e)||ot.set(e,ct(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),ot.get(e)),T=e=>t=>t*53^e,Te=e=>e&3221225471|e>>>1&1073741824,Er=e=>w(e,y),ct=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Te(t)},F=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Te(t)},Or=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=b(F(t[r]),T(p(e[t[r]])));return Te(n)},Ir=e=>Or(e,Object.keys(e)),Cr=e=>{let t=6151;for(let n=0;n<e.length;n++)t=b(t,T(p(e[n])));return Te(t)},C=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,y,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,y,{value(){return t},enumerable:!1}),t},S=Symbol.for("effect/Equal");function v(){return arguments.length===1?e=>Ae(e,arguments[0]):Ae(arguments[0],arguments[1])}function Ae(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(Qt(e)&&Qt(t))return p(e)===p(t)&&e[S](t)?!0:I.enabled&&I.tester?I.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString();if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(I.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>Ae(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&Ae(e[o],t[o])))return I.tester?I.tester(e,t):!1;return!0}}return I.tester?I.tester(e,t):!1}}return I.enabled&&I.tester?I.tester(e,t):!1}const Qt=e=>w(e,S),O=Symbol.for("nodejs.util.inspect.custom"),E=e=>{try{if(w(e,"toJSON")&&nt(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(E)}catch{return{}}return Mr(e)},N=e=>JSON.stringify(e,null,2),Nr=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?Zt(e,t):String(e)}catch{return String(e)}},Zt=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(je.fiberRefs!==void 0&&en(o)?o[at](je.fiberRefs):o):o,t);return n=void 0,r},at=Symbol.for("effect/Inspectable/Redactable"),en=e=>typeof e=="object"&&e!==null&&at in e,je=ee("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),Mr=e=>en(e)&&je.fiberRefs!==void 0?e[at](je.fiberRefs):e,A=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},$r="Commit",Tr="Failure",Ar="WithRuntime",jr=Symbol.for("effect/Effect"),xr=Symbol.for("effect/Stream"),Pr=Symbol.for("effect/Sink"),Rr=Symbol.for("effect/Channel"),pe={_R:e=>e,_E:e=>e,_A:e=>e,_V:Gt()},Fr={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},Lr={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},ge={[jr]:pe,[xr]:pe,[Pr]:Fr,[Rr]:Lr,[S](e){return this===e},[y](){return C(this,it(this))},[Symbol.iterator](){return new Xt(new $e(this))},pipe(){return A(this,arguments)}},tn={[y](){return C(this,Ir(this))},[S](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&v(this[r],e[r])))return!1;return!0}},Br={...{...ge,_op:$r},...tn},nn=Symbol.for("effect/Option"),rn={...ge,[nn]:{_A:e=>e},[O](){return this.toJSON()},toString(){return N(this.toJSON())}},Jr=Object.assign(Object.create(rn),{_tag:"Some",_op:"Some",[S](e){return sn(e)&&cn(e)&&v(this.value,e.value)},[y](){return C(this,T(p(this._tag))(p(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:E(this.value)}}}),Ur=p("None"),Hr=Object.assign(Object.create(rn),{_tag:"None",_op:"None",[S](e){return sn(e)&&on(e)},[y](){return Ur},toJSON(){return{_id:"Option",_tag:this._tag}}}),sn=e=>w(e,nn),on=e=>e._tag==="None",cn=e=>e._tag==="Some",Vr=Object.create(Hr),Dr=e=>{const t=Object.create(Jr);return t.value=e,t},an=Symbol.for("effect/Either"),un={...ge,[an]:{_R:e=>e},[O](){return this.toJSON()},toString(){return N(this.toJSON())}},Wr=Object.assign(Object.create(un),{_tag:"Right",_op:"Right",[S](e){return ln(e)&&Gr(e)&&v(this.right,e.right)},[y](){return T(p(this._tag))(p(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:E(this.right)}}}),qr=Object.assign(Object.create(un),{_tag:"Left",_op:"Left",[S](e){return ln(e)&&zr(e)&&v(this.left,e.left)},[y](){return T(p(this._tag))(p(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:E(this.left)}}}),ln=e=>w(e,an),zr=e=>e._tag==="Left",Gr=e=>e._tag==="Right",Yr=e=>{const t=Object.create(qr);return t.left=e,t},xe=e=>{const t=Object.create(Wr);return t.right=e,t},fn=Yr,M=()=>Vr,me=Dr,j=on,ye=cn,Kr=l(2,(e,t)=>j(e)?t():e.value)(zt),hn=e=>Array.isArray(e)?e:Array.from(e),dn=e=>Array.from(e).reverse(),Xr=l(3,(e,t,n)=>hn(e).reduce((r,s,o)=>n(r,s,o),t)),pn=Symbol.for("effect/Chunk");function Qr(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const gn=[],Zr=(e=>br((t,n)=>t.length===n.length&&be(t).every((r,s)=>e(r,ne(n,s)))))(v),es={[pn]:{_A:e=>e},toString(){return N(this.toJSON())},toJSON(){return{_id:"Chunk",values:be(this).map(E)}},[O](){return this.toJSON()},[S](e){return ts(e)&&Zr(this,e)},[y](){return C(this,Cr(be(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return gn[Symbol.iterator]();default:return be(this)[Symbol.iterator]()}},pipe(){return A(this,arguments)}},k=e=>{const t=Object.create(es);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=L,t.right=L;break}case"ISingleton":{t.length=1,t.depth=0,t.left=L,t.right=L;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=L,t.right=L;break}}return t},ts=e=>w(e,pn),L=k({_tag:"IEmpty"}),te=()=>L,ut=(...e)=>ns(e),_e=e=>k({_tag:"ISingleton",a:e}),lt=(e,t,n)=>{switch(e.backing._tag){case"IArray":{Qr(e.backing.array,0,t,n,e.length);break}case"IConcat":{lt(e.left,t,n),lt(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=ne(e,r),r+=1,s+=1;break}}},be=e=>{switch(e.backing._tag){case"IEmpty":return gn;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return lt(e,t,0),e.backing={_tag:"IArray",array:t},e.left=L,e.right=L,e.depth=0,t}}},ft=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return k({_tag:"IArray",array:dn(e.backing.array)});case"IConcat":return k({_tag:"IConcat",left:ft(e.backing.right),right:ft(e.backing.left)});case"ISlice":return mn(dn(be(e)))}},mn=e=>e.length===0?te():e.length===1?_e(e[0]):k({_tag:"IArray",array:e}),ns=e=>mn(e),ne=l(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?ne(e.left,t):ne(e.right,t-e.left.length);case"ISlice":return ne(e.backing.chunk,t+e.backing.offset)}}),yn=l(2,(e,t)=>V(_e(t),e)),V=l(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return k({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=V(e.right,t);return k({_tag:"IConcat",left:e.left,right:r})}else{const r=V(e.right.right,t);if(r.depth===e.depth-3){const s=k({_tag:"IConcat",left:e.right.left,right:r});return k({_tag:"IConcat",left:e.left,right:s})}else{const s=k({_tag:"IConcat",left:e.left,right:e.right.left});return k({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=V(e,t.left);return k({_tag:"IConcat",left:r,right:t.right})}else{const r=V(e,t.left.left);if(r.depth===t.depth-3){const s=k({_tag:"IConcat",left:r,right:t.left.right});return k({_tag:"IConcat",left:s,right:t.right})}else{const s=k({_tag:"IConcat",left:t.left.right,right:t.right});return k({_tag:"IConcat",left:r,right:s})}}}),rs=e=>e.length===0,_n=e=>e.length>0,bn=e=>ne(e,0),ss=Symbol.for("effect/Context/Tag"),ht=Symbol.for("effect/Context/Reference"),Sn={...ge,_op:"Tag",[Symbol.for("effect/STM")]:pe,[ss]:{_Service:e=>e,_Identifier:e=>e},toString(){return N(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[O](){return this.toJSON()},of(e){return e},context(e){return wn(this,e)}},os={...Sn,[ht]:ht},is=e=>()=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;function r(){}return Object.setPrototypeOf(r,Sn),r.key=e,Object.defineProperty(r,"stack",{get(){return n.stack}}),r},cs=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,os),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},kn=Symbol.for("effect/Context"),as={[kn]:{_Services:e=>e},[S](e){if(ls(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!v(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[y](){return C(this,ct(this.unsafeMap.size))},pipe(){return A(this,arguments)},toString(){return N(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(E)}},[O](){return this.toJSON()}},dt=e=>{const t=Object.create(as);return t.unsafeMap=e,t},us=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},ls=e=>w(e,kn),wn=(e,t)=>dt(new Map([[e.key,t]])),fs=l(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),dt(r)}),pt=ee("effect/Context/defaultValueCache",()=>new Map),vn=e=>{if(pt.has(e.key))return pt.get(e.key);const t=e.defaultValue();return pt.set(e.key,t),t},hs=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):vn(t),ds=l(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(ht in t)return vn(t);throw us(t)}return e.unsafeMap.get(t.key)}),ps=l(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return dt(n)}),gs=wn,ms=fs,ys=ds,_s=ps,En=is,re=cs,W=5,gt=Math.pow(2,W),bs=gt-1,Ss=gt/2,ks=gt/4;function ws(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function se(e,t){return t>>>e&bs}function oe(e){return 1<<e}function On(e,t){return ws(e&t-1)}const vs=(e,t)=>({value:e,previous:t});function ie(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function In(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function Es(e,t,n,r){const s=r.length;if(e){let a=s;for(;a>=t;)r[a--]=r[a];return r[t]=n,r}let o=0,i=0;const c=new Array(s+1);for(;o<t;)c[i++]=r[o++];for(c[t]=n;o<s;)c[++i]=r[o++];return c}class D{_tag="EmptyNode";modify(t,n,r,s,o,i){const c=r(M());return j(c)?new D:(++i.value,new q(t,s,o,c))}}function x(e){return wr(e,"EmptyNode")}function Os(e){return x(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Pe(e,t){return x(e)?!1:t===e.edit}class q{edit;hash;key;value;_tag="LeafNode";constructor(t,n,r,s){this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(v(o,this.key)){const a=r(this.value);return a===this.value?this:j(a)?(--i.value,new D):Pe(this,t)?(this.value=a,this):new q(t,s,o,a)}const c=r(M());return j(c)?this:(++i.value,Cn(t,n,this.hash,this,s,new q(t,s,o,c)))}}class mt{edit;hash;children;_tag="CollisionNode";constructor(t,n,r){this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const a=Pe(this,t),u=this.updateCollisionList(a,t,this.hash,this.children,r,o,i);return u===this.children?this:u.length>1?new mt(t,this.hash,u):u[0]}const c=r(M());return j(c)?this:(++i.value,Cn(t,n,this.hash,this,s,new q(t,s,o,c)))}updateCollisionList(t,n,r,s,o,i,c){const a=s.length;for(let h=0;h<a;++h){const d=s[h];if("key"in d&&v(i,d.key)){const _=d.value,m=o(_);return m===_?s:j(m)?(--c.value,In(t,h,s)):ie(t,h,new q(n,r,i,m),s)}}const u=o(M());return j(u)?s:(++c.value,ie(t,a,new q(n,r,i,u),s))}}class ce{edit;mask;children;_tag="IndexedNode";constructor(t,n,r){this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const c=this.mask,a=this.children,u=se(n,s),h=oe(u),d=On(c,h),_=c&h,m=Pe(this,t);if(!_){const Z=new D().modify(t,n+W,r,s,o,i);return Z?a.length>=Ss?Cs(t,u,Z,c,a):new ce(t,c|h,Es(m,d,Z,a)):this}const Ce=a[d],K=Ce.modify(t,n+W,r,s,o,i);if(Ce===K)return this;let X=c,Q;if(x(K)){if(X&=~h,!X)return new D;if(a.length<=2&&Os(a[d^1]))return a[d^1];Q=In(m,d,a)}else Q=ie(m,d,K,a);return m?(this.mask=X,this.children=Q,this):new ce(t,X,Q)}}class yt{edit;size;children;_tag="ArrayNode";constructor(t,n,r){this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let c=this.size;const a=this.children,u=se(n,s),h=a[u],d=(h||new D).modify(t,n+W,r,s,o,i);if(h===d)return this;const _=Pe(this,t);let m;if(x(h)&&!x(d))++c,m=ie(_,u,d,a);else if(!x(h)&&x(d)){if(--c,c<=ks)return Is(t,c,u,a);m=ie(_,u,new D,a)}else m=ie(_,u,d,a);return _?(this.size=c,this.children=m,this):new yt(t,c,m)}}function Is(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const u=r[c];u&&!x(u)&&(s[o++]=u,i|=1<<c)}return new ce(e,i,s)}function Cs(e,t,n,r,s){const o=[];let i=r,c=0;for(let a=0;i;++a)i&1&&(o[a]=s[c++]),i>>>=1;return o[t]=n,new yt(e,c+1,o)}function Ns(e,t,n,r,s,o){if(n===s)return new mt(e,n,[o,r]);const i=se(t,n),c=se(t,s);if(i===c)return a=>new ce(e,oe(i)|oe(c),[a]);{const a=i<c?[r,o]:[o,r];return new ce(e,oe(i)|oe(c),a)}}function Cn(e,t,n,r,s,o){let i,c=t;for(;;){const a=Ns(e,c,n,r,s,o);if(typeof a=="function")i=vs(a,i),c=c+W;else{let u=a;for(;i!=null;)u=i.value(u),i=i.previous;return u}}}const Nn="effect/HashMap",_t=Symbol.for(Nn),Ms={[_t]:_t,[Symbol.iterator](){return new Re(this,(e,t)=>[e,t])},[y](){let e=p(Nn);for(const t of this)e^=b(p(t[0]),T(p(t[1])));return C(this,e)},[S](e){if(As(e)){if(e._size!==this._size)return!1;for(const t of this){const n=b(e,js(t[0],p(t[0])));if(j(n))return!1;if(!v(t[1],n.value))return!1}return!0}return!1},toString(){return N(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(E)}},[O](){return this.toJSON()},pipe(){return A(this,arguments)}},bt=(e,t,n,r)=>{const s=Object.create(Ms);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Re{map;f;v;constructor(t,n){this.map=t,this.f=n,this.v=Mn(this.map._root,this.f,void 0)}next(){if(j(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=Fe(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Re(this.map,this.f)}}const Fe=e=>e?$n(e[0],e[1],e[2],e[3],e[4]):M(),Mn=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return ye(e.value)?me({value:t(e.key,e.value.value),cont:n}):Fe(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return $n(r.length,r,0,t,n)}default:return Fe(n)}},$n=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!x(o))return Mn(o,r,[e,t,n,r,s])}return Fe(s)},$s=bt(!1,0,new D,0),Ts=()=>$s,As=e=>w(e,_t),js=l(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return v(t,r.key)?r.value:M();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,c=o.length;i<c;++i){const a=o[i];if("key"in a&&v(t,a.key))return a.value}}return M()}case"IndexedNode":{const o=se(s,n),i=oe(o);if(r.mask&i){r=r.children[On(r.mask,i)],s+=W;break}return M()}case"ArrayNode":{if(r=r.children[se(s,n)],r){s+=W;break}return M()}default:return M()}}),Tn=l(3,(e,t,n)=>Fs(e,t,()=>me(n))),xs=l(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:bt(e._editable,e._edit,t,n)),Ps=e=>new Re(e,t=>t),St=e=>e._size,Rs=e=>bt(!0,e._edit+1,e._root,e._size),Fs=l(3,(e,t,n)=>Ls(e,t,p(t),n)),Ls=l(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return b(e,xs(o,s.value))}),Bs=l(2,(e,t)=>Js(e,void 0,(n,r,s)=>t(r,s))),Js=l(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return ye(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,c=o.length;i<c;){const a=o[i++];a&&!x(a)&&(a._tag==="LeafNode"?ye(a.value)&&(t=n(t,a.value.value,a.key)):s.push(a.children))}return t}),An="effect/HashSet",kt=Symbol.for(An),Us={[kt]:kt,[Symbol.iterator](){return Ps(this._keyMap)},[y](){return C(this,T(p(this._keyMap))(p(An)))},[S](e){return Hs(e)?St(this._keyMap)===St(e._keyMap)&&v(this._keyMap,e._keyMap):!1},toString(){return N(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(E)}},[O](){return this.toJSON()},pipe(){return A(this,arguments)}},wt=e=>{const t=Object.create(Us);return t._keyMap=e,t},Hs=e=>w(e,kt),Vs=wt(Ts()),jn=()=>Vs,Ds=e=>St(e._keyMap),Ws=e=>wt(Rs(e._keyMap)),qs=e=>(e._keyMap._editable=!1,e),zs=l(2,(e,t)=>{const n=Ws(e);return t(n),qs(n)}),vt=l(2,(e,t)=>e._keyMap._editable?(Tn(t,!0)(e._keyMap),e):wt(Tn(t,!0)(e._keyMap))),Gs=l(2,(e,t)=>zs(jn(),n=>{Ys(e,r=>vt(n,r));for(const r of t)vt(n,r)})),Ys=l(2,(e,t)=>Bs(e._keyMap,(n,r)=>t(r))),Le=jn,Ks=Ds,Et=vt,Ot=Gs,Xs=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=tn,e}(),xn="Die",It="Empty",Ct="Fail",Pn="Interrupt",Se="Parallel",ke="Sequential",Rn="effect/Cause",Fn=Symbol.for(Rn),Qs={_E:e=>e},Nt={[Fn]:Qs,[y](){return b(p(Rn),T(p(ro(this))),C(this))},[S](e){return eo(e)&&no(this,e)},pipe(){return A(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:E(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:E(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:E(this.left),right:E(this.right)}}},toString(){return Hn(this)},[O](){return this.toJSON()}},Mt=e=>{const t=Object.create(Nt);return t._tag=Ct,t.error=e,t},Zs=(e,t)=>{const n=Object.create(Nt);return n._tag=Se,n.left=e,n.right=t,n},Be=(e,t)=>{const n=Object.create(Nt);return n._tag=ke,n.left=e,n.right=t,n},eo=e=>w(e,Fn),to=e=>Un(void 0,oo)(e),no=(e,t)=>{let n=_e(e),r=_e(t);for(;_n(n)&&_n(r);){const[s,o]=b(bn(n),Jn([Le(),te()],([a,u],h)=>{const[d,_]=$t(h);return me([b(a,Ot(d)),b(u,V(_))])})),[i,c]=b(bn(r),Jn([Le(),te()],([a,u],h)=>{const[d,_]=$t(h);return me([b(a,Ot(d)),b(u,V(_))])}));if(!v(s,i))return!1;n=o,r=c}return!0},ro=e=>so(_e(e),te()),so=(e,t)=>{for(;;){const[n,r]=b(e,Xr([Le(),te()],([o,i],c)=>{const[a,u]=$t(c);return[b(o,Ot(a)),b(i,V(u))]})),s=Ks(n)>0?b(t,yn(n)):t;if(rs(r))return ft(s);e=r,t=s}throw new Error(rt("Cause.flattenCauseLoop"))},$t=e=>{let t=e;const n=[];let r=Le(),s=te();for(;t!==void 0;)switch(t._tag){case It:{if(n.length===0)return[r,s];t=n.pop();break}case Ct:{if(r=Et(r,ut(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case xn:{if(r=Et(r,ut(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Pn:{if(r=Et(r,ut(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case ke:{switch(t.left._tag){case It:{t=t.right;break}case ke:{t=Be(t.left.left,Be(t.left.right,t.right));break}case Se:{t=Zs(Be(t.left.left,t.right),Be(t.left.right,t.right));break}default:{s=yn(s,t.right),t=t.left;break}}break}case Se:{n.push(t.right),t=t.left;break}}throw new Error(rt("Cause.evaluateCauseLoop"))},oo={emptyCase:Wt,failCase:qt,dieCase:qt,interruptCase:Wt,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},Ln="SequentialCase",Bn="ParallelCase",Jn=l(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=ye(i)?i.value:r,s._tag){case ke:{o.push(s.right),s=s.left;break}case Se:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),Un=l(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case It:{s.push(xe(n.emptyCase(t)));break}case Ct:{s.push(xe(n.failCase(t,i.error)));break}case xn:{s.push(xe(n.dieCase(t,i.defect)));break}case Pn:{s.push(xe(n.interruptCase(t,i.fiberId)));break}case ke:{r.push(i.right),r.push(i.left),s.push(fn({_tag:Ln}));break}case Se:{r.push(i.right),r.push(i.left),s.push(fn({_tag:Bn}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case Ln:{const c=o.pop(),a=o.pop(),u=n.sequentialCase(t,c,a);o.push(u);break}case Bn:{const c=o.pop(),a=o.pop(),u=n.parallelCase(t,c,a);o.push(u);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),Hn=(e,t)=>to(e)?"All fibers interrupted without errors.":lo(e).map(function(n){return t?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${Vn(n.cause,"  ")}
}`}).join(`
`),Vn=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${Vn(e.cause,`${t}  `)}
${t}}`),r};class Je extends globalThis.Error{span=void 0;constructor(t){const n=typeof t=="object"&&t!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(io(t),n&&"cause"in t&&typeof t.cause<"u"?{cause:new Je(t.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=t instanceof Error?t.name:"Error",n&&(we in t&&(this.span=t[we]),Object.keys(t).forEach(s=>{s in this||(this[s]=t[s])})),this.stack=uo(`${this.name}: ${this.message}`,t instanceof Error&&t.stack?t.stack:"",this.span)}}const io=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(w(e,"toString")&&nt(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return Zt(e)},co=/\((.*)\)/g,ao=ee("effect/Tracer/spanToTrace",()=>new WeakMap),uo=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const c=ao.get(o);if(typeof c=="function"){const a=c();if(typeof a=="string"){const u=a.matchAll(co);let h=!1;for(const[,d]of u)h=!0,r.push(`    at ${o.name} (${d})`);h||r.push(`    at ${o.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=Kr(o.parent),i++}}return r.join(`
`)},we=Symbol.for("effect/SpanAnnotation"),lo=e=>Un(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new Je(n)],failCase:(t,n)=>[new Je(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]});class Ue{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Ue(this.self)}}const Tt=Symbol.for("effect/Effect");class fo{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Tt]=pe;constructor(t){this._op=t}[S](t){return this===t}[y](){return C(this,it(this))}pipe(){return A(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:E(this.effect_instruction_i0),effect_instruction_i1:E(this.effect_instruction_i1),effect_instruction_i2:E(this.effect_instruction_i2)}}toString(){return N(this.toJSON())}[O](){return this.toJSON()}[Symbol.iterator](){return new Ue(new $e(this))}}class ho{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Tt]=pe;constructor(t){this._op=t,this._tag=t}[S](t){return bo(t)&&t._op==="Failure"&&v(this.effect_instruction_i0,t.effect_instruction_i0)}[y](){return b(F(this._tag),T(p(this.effect_instruction_i0)),C(this))}get cause(){return this.effect_instruction_i0}pipe(){return A(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return N(this.toJSON())}[O](){return this.toJSON()}[Symbol.iterator](){return new Ue(new $e(this))}}const po=e=>w(e,Tt),go=e=>{const t=new fo(Ar);return t.effect_instruction_i0=e,t},Dn=Symbol.for("effect/OriginalAnnotation"),mo=(e,t)=>ye(t)?new Proxy(e,{has(n,r){return r===we||r===Dn||r in n},get(n,r){return r===we?t.value:r===Dn?e:n[r]}}):e,yo=e=>Kt(e)&&!(we in e)?go(t=>Wn(Mt(mo(e,So(t))))):Wn(Mt(e)),Wn=e=>{const t=new ho(Tr);return t.effect_instruction_i0=e,t},_o=function(){class e extends globalThis.Error{commit(){return yo(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[O](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?Hn(Mt(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,Br),e}(),bo=e=>po(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),So=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?me(t):M()},At=Xs,ko=e=>{class t extends At{_tag=e}return t},wo=function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends _o{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError}(),jt=e=>{const t={BaseEffectError:class extends wo{_tag=e}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},vo=ge,qn=Symbol.for("effect/Micro"),He=Symbol.for("effect/Micro/MicroExit"),ve=e=>typeof e=="object"&&e!==null&&qn in e,zn=Symbol.for("effect/Micro/MicroCause"),Eo={_E:R};class xt extends globalThis.Error{_tag;traces;[zn];constructor(t,n,r){const s=`MicroCause.${t}`;let o,i,c;if(n instanceof globalThis.Error){o=`(${s}) ${n.name}`,i=n.message;const a=i.split(`
`).length;c=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,a+3).join(`
`)}`:`${o}: ${i}`}else o=s,i=Nr(n,0),c=`${o}: ${i}`;r.length>0&&(c+=`
    ${r.join(`
    `)}`),super(i),this._tag=t,this.traces=r,this[zn]=Eo,this.name=o,this.stack=c}pipe(){return A(this,arguments)}toString(){return this.stack}[O](){return this.stack}}class Oo extends xt{error;constructor(t,n=[]){super("Fail",t,n),this.error=t}}const Io=(e,t=[])=>new Oo(e,t);class Co extends xt{defect;constructor(t,n=[]){super("Die",t,n),this.defect=t}}const No=(e,t=[])=>new Co(e,t);class Mo extends xt{constructor(t=[]){super("Interrupt","interrupted",t)}}const $o=(e=[])=>new Mo(e),To=e=>e._tag==="Fail",Gn=e=>e._tag==="Interrupt",Yn=Symbol.for("effect/Micro/MicroFiber"),Ao={_A:R,_E:R};class Kn{context;interruptible;[Yn];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(t,n=!0){this.context=t,this.interruptible=n,this[Yn]=Ao}getRef(t){return hs(this.context,t)}addObserver(t){return this._exit?(t(this._exit),_r):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Ft))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===ae)return;const r=Xn.interruptChildren&&Xn.interruptChildren(this);if(r!==void 0)return this.evaluate($(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(Xe).shouldYield(this)){n=!0;const s=r;r=$(er,()=>s)}if(r=r[Pt](this),r===ae){const s=this._yielded;return He in s?(this._yielded=void 0,s):ae}}}catch(s){return w(r,Pt)?Ke(s):Ke(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[Ve]&&n[Ve](this);if(r)return{[t]:r};if(n[t])return n}}_yielded=void 0;yieldWith(t){return this._yielded=t,ae}children(){return this._children??=new Set}}const Xn=ee("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),jo=e=>ze(t=>De(e.addObserver(n=>t(g(n))))),xo=e=>G(()=>(e.unsafeInterrupt(),Uo(jo(e)))),Po=e=>G(()=>{for(const r of e)r.unsafeInterrupt();const t=e[Symbol.iterator](),n=G(()=>{let r=t.next();for(;!r.done;){if(r.value.unsafePoll()){r=t.next();continue}const s=r.value;return ze(o=>{s.addObserver(i=>{o(n)})})}return fe});return n}),Qn=Symbol.for("effect/Micro/identifier"),f=Symbol.for("effect/Micro/args"),Pt=Symbol.for("effect/Micro/evaluate"),B=Symbol.for("effect/Micro/successCont"),z=Symbol.for("effect/Micro/failureCont"),Ve=Symbol.for("effect/Micro/ensureCont"),ae=Symbol.for("effect/Micro/Yield"),Ro={_A:R,_E:R,_R:R},Fo={...vo,_op:"Micro",[qn]:Ro,pipe(){return A(this,arguments)},[Symbol.iterator](){return new Xt(new $e(this))},toJSON(){return{_id:"Micro",op:this[Qn],...f in this?{args:this[f]}:void 0}},toString(){return N(this)},[O](){return N(this)}};function Lo(e){return Ke("Micro.evaluate: Not implemented")}const Ee=e=>({...Fo,[Qn]:e.op,[Pt]:e.eval??Lo,[B]:e.contA,[z]:e.contE,[Ve]:e.ensure}),J=e=>{const t=Ee(e);return function(){const n=Object.create(t);return n[f]=e.single===!1?arguments:arguments[0],n}},Zn=e=>{const t={...Ee(e),[He]:He,_tag:e.op,get[e.prop](){return this[f]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[f]}},[S](n){return Wo(n)&&n._tag===e.op&&v(this[f],n[f])},[y](){return C(this,T(F(e.op))(p(this[f])))}};return function(n){const r=Object.create(t);return r[f]=n,r[B]=void 0,r[z]=void 0,r[Ve]=void 0,r}},g=Zn({op:"Success",prop:"value",eval(e){const t=e.getCont(B);return t?t[B](this[f],e):e.yieldWith(this)}}),ue=Zn({op:"Failure",prop:"cause",eval(e){let t=e.getCont(z);for(;Gn(this[f])&&t&&e.interruptible;)t=e.getCont(z);return t?t[z](this[f],e):e.yieldWith(this)}}),U=e=>ue(Io(e)),De=J({op:"Sync",eval(e){const t=this[f](),n=e.getCont(B);return n?n[B](t,e):e.yieldWith(Ge(t))}}),G=J({op:"Suspend",eval(e){return this[f]()}}),er=J({op:"Yield",eval(e){let t=!1;return e.getRef(Xe).scheduleTask(()=>{t||e.evaluate(fe)},this[f]??0),e.yieldWith(()=>{t=!0})}})(0),We=g(void 0),tr=e=>G(()=>{try{return g(e.try())}catch(t){return U(e.catch(t))}}),qe=e=>nr(function(t,n){try{e.try(n).then(r=>t(g(r)),r=>t(U(e.catch(r))))}catch(r){t(U(e.catch(r)))}},e.try.length!==0),le=J({op:"WithMicroFiber",eval(e){return this[f](e)}}),nr=J({op:"Async",single:!1,eval(e){const t=this[f][0];let n=!1,r=!1;const s=this[f][1]?new AbortController:void 0,o=t(i=>{n||(n=!0,r?e.evaluate(i):r=i)},s?.signal);return r!==!1?r:(r=!0,e._yielded=()=>{n=!0},s===void 0&&o===void 0||e._stack.push(Bo(()=>(n=!0,s?.abort(),o??fe))),ae)}}),Bo=J({op:"AsyncFinalizer",ensure(e){e.interruptible&&(e.interruptible=!1,e._stack.push(Jt(!0)))},contE(e,t){return Gn(e)?$(this[f](),()=>ue(e)):ue(e)}}),ze=e=>nr(e,e.length>=2),Y=(...e)=>G(()=>Jo(e.length===1?e[0]():e[1].call(e[0]))),Jo=J({op:"Iterator",contA(e,t){const n=this[f].next(e);return n.done?g(n.value):(t._stack.push(this),vr(n.value))},eval(e){return this[B](void 0,e)}}),rr=l(2,(e,t)=>Do(e,n=>t)),H=l(2,(e,t)=>$(e,n=>{const r=ve(t)?t:typeof t=="function"?t(n):t;return ve(r)?r:g(r)})),Rt=l(2,(e,t)=>$(e,n=>{const r=ve(t)?t:typeof t=="function"?t(n):t;return ve(r)?rr(r,n):g(n)})),Uo=e=>$(e,t=>fe),Ho=e=>ei(e,{onFailure:Ye,onSuccess:Ge}),$=l(2,(e,t)=>{const n=Object.create(Vo);return n[f]=e,n[B]=t,n}),Vo=Ee({op:"OnSuccess",eval(e){return e._stack.push(this),this[f]}}),Do=l(2,(e,t)=>$(e,n=>g(t(n)))),Wo=e=>w(e,He),Ge=g,Ye=ue,Ft=Ye($o()),Ke=e=>Ye(No(e)),fe=Ge(void 0),qo="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class sr{tasks=[];running=!1;scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,qo(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(zo)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const P=e=>le(t=>g(ys(t.context,e))),or=l(2,(e,t)=>le(n=>{const r=n.context;return n.context=t(r),ni(e,()=>(n.context=r,We))})),ir=l(2,(e,t)=>or(e,_s(t))),Lt=l(3,(e,t,n)=>or(e,ms(t,n)));class zo extends re()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class Xe extends re()("effect/Micro/currentScheduler",{defaultValue:()=>new sr}){}const Go=l(2,(e,t)=>G(()=>{const n=t.schedule?Date.now():0;let r=0;const s=$(Ho(e),o=>{if(t.while!==void 0&&!t.while(o))return o;if(t.times!==void 0&&r>=t.times)return o;r++;let i=er;if(t.schedule!==void 0){const c=Date.now()-n,a=t.schedule(r,c);if(j(a))return o;i=ar(a.value)}return $(i,()=>s)});return s})),Yo=l(e=>ve(e[0]),(e,t)=>Go(e,{...t,while:n=>n._tag==="Success"&&(t?.while===void 0||t.while(n.value))})),Ko=l(2,(e,t)=>{const n=Object.create(Xo);return n[f]=e,n[z]=t,n}),Xo=Ee({op:"OnFailure",eval(e){return e._stack.push(this),this[f]}}),Qo=l(3,(e,t,n)=>Ko(e,r=>t(r)?n(r):ue(r))),Bt=l(2,(e,t)=>Qo(e,To,n=>t(n.error))),cr=l(2,(e,t)=>{const n=Object.create(Zo);return n[f]=e,n[B]=t.onSuccess,n[z]=t.onFailure,n}),Zo=Ee({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[f]}}),ei=l(2,(e,t)=>cr(e,{onFailure:n=>De(()=>t.onFailure(n)),onSuccess:n=>De(()=>t.onSuccess(n))})),ar=e=>ze(t=>{const n=setTimeout(()=>{t(We)},e);return De(()=>{clearTimeout(n)})}),ti=l(2,(e,t)=>H(ar(t),e)),ni=l(2,(e,t)=>si(n=>cr(n(e),{onFailure:r=>$(t(Ye(r)),()=>ue(r)),onSuccess:r=>$(t(Ge(r)),()=>g(r))}))),Jt=J({op:"SetInterruptible",ensure(e){if(e.interruptible=this[f],e._interrupted&&e.interruptible)return()=>Ft}}),ri=e=>le(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(Jt(!1)),t._interrupted?Ft:e)),si=e=>le(t=>t.interruptible?(t.interruptible=!1,t._stack.push(Jt(!0)),e(ri)):e(R)),oi=J({op:"While",contA(e,t){return this[f].step(e),this[f].while()?(t._stack.push(this),this[f].body()):fe},eval(e){return this[f].while()?(e._stack.push(this),this[f].body()):fe}}),ii=(e,t,n)=>le(r=>{const s=n?.concurrency,o=Math.max(1,s),i=hn(e);let c=i.length;if(c===0)return n?.discard?We:g([]);const a=n?.discard?void 0:new Array(c);let u=0;return o===1?rr(oi({while:()=>u<i.length,body:()=>t(i[u],u),step:a?h=>a[u++]=h:h=>u++}),a):ze(h=>{const d=new Set;let _,m=0,Ce=0,K=!1,X=!1;function Q(){for(K=!0;m<o&&u<c;){const Z=u,Fi=i[Z];u++,m++;try{const Ne=ur(r,t(Fi,Z),!0,!0);d.add(Ne),Ne.addObserver(Me=>{d.delete(Ne),!X&&(Me._tag==="Failure"?_===void 0&&(_=Me,c=u,d.forEach(Li=>Li.unsafeInterrupt())):a!==void 0&&(a[Z]=Me.value),Ce++,m--,Ce===c?h(_??g(a)):!K&&m<o&&Q())})}catch(Ne){_=Ke(Ne),c=u,d.forEach(Me=>Me.unsafeInterrupt())}}K=!1}return Q(),G(()=>(X=!0,u=c,Po(d)))})}),ur=(e,t,n=!1,r=!1)=>{const s=new Kn(e.context,e.interruptible);return r||(e.children().add(s),s.addObserver(()=>e.children().delete(s))),n?s.evaluate(t):e.getRef(Xe).scheduleTask(()=>s.evaluate(t),0),s},ci=e=>le(t=>g(ur(t,e,!1,!0))),ai=(e,t)=>{const n=new Kn(Xe.context(t?.scheduler??new sr));if(n.evaluate(e),t?.signal)if(t.signal.aborted)n.unsafeInterrupt();else{const r=()=>n.unsafeInterrupt();t.signal.addEventListener("abort",r,{once:!0}),n.addObserver(()=>t.signal.removeEventListener("abort",r))}return n},ui=(e,t)=>new Promise((n,r)=>{ai(e,t).addObserver(n)}),lr=(e,t)=>ui(e,t).then(n=>{if(n._tag==="Failure")throw n.cause;return n.value}),li=e=>{let t=e[0];for(let n=1;n<e.length;n++)t+=e[n]==="_"?e[++n].toUpperCase():e[n];return t};var fi=class Dt extends ko("BotResponse"){static make(t){return new Dt({response:t})}static ignore=new Dt({})},Qe=class extends jt("TgBotClientError"){},hi=e=>typeof e=="object"&&e!=null&&"file_content"in e&&e.file_content instanceof Uint8Array&&"file_name"in e&&typeof e.file_name=="string",di=e=>typeof e=="object"&&e!=null&&"ok"in e&&typeof e.ok=="boolean",pi="https://api.telegram.org",gi={"ðŸ’©":"5046589136895476101"},mi=class extends re()("TgBotApiBaseUrl",{defaultValue:()=>pi}){},fr=class extends En("TgBotApiToken")(){},yi=e=>{let t=Object.entries(e);if(t.length==0)return;let n=new FormData;for(let[r,s]of t)s&&(typeof s!="object"?n.append(r,`${s}`):hi(s)?n.append(r,new Blob([s.file_content]),s.file_name):n.append(r,JSON.stringify(s)));return n},Ut=(e,t)=>Y(function*(){let n=yield*P(fr),r=yield*P(mi),s=yield*qe({try:()=>fetch(`${r}/bot${n}/${li(e)}`,{body:yi(t)??null,method:"POST"}),catch:i=>new Qe({cause:{_tag:"ClientInternalError",cause:i}})}),o=yield*qe({try:()=>s.json(),catch:()=>new Qe({cause:{_tag:"NotJsonResponse",response:s}})});return di(o)?s.ok?o.result:yield*U(new Qe({cause:{_tag:"NotOkResponse",...o.error_code?{errorCode:o.error_code}:void 0,...o.description?{details:o.description}:void 0}})):yield*U(new Qe({cause:{_tag:"UnexpectedResponse",response:o}}))}),Ht=class extends En("BotUpdateHandlers")(){},hr=class mr extends At{static make(t){let n=t.batch_size??10,r=t.poll_timeout??10,s=t.max_empty_responses,o=t.log_level??"info",i=t.on_error;(n<10||n>100)&&(console.warn("Wrong batch_size, must be in [10..100], using 10 instead"),n=10),(r<2||r>120)&&(console.warn("Wrong poll_timeout, must be in [2..120], using 20 instead"),r=20),s&&s<2&&(console.warn("Wrong max_empty_responses, must be in [2..infinity], using infinity"),s=void 0),o||(o="info"),i||(i="stop");let c=new mr({batch_size:n,poll_timeout:r,max_empty_responses:s,log_level:o,on_error:i});return console.log("bot poll settings",c),c}},he=class extends re()("BotSettings",{defaultValue(){return hr.make({})}}){},_i=e=>{for(let[t,n]of Object.entries(e))if(t!="update_id")return{type:t,...n}},Vt=class extends At{},bi=e=>Y(function*(){let t=yield*P(he),n=yield*P(Ht);return n.type=="single"?yield*ki(e,n,t):yield*Si(e,n)}),Si=(e,t)=>tr({try:()=>t.on_batch(e),catch:R}).pipe(H(n=>n instanceof Promise?qe({try:()=>n,catch:R}):g(n)),H(n=>new Vt({hasErrors:!n,updates:e})),Bt(n=>(console.warn("handle batch error",{errorMessage:n instanceof Error?n.message:void 0,updates:e.map(r=>Object.keys(r).at(1)),error:n}),g(new Vt({hasErrors:!0,updates:e}))))),Ze=class extends jt("HandleUpdateError"){},ki=(e,t,n)=>ii(e,r=>wi(r,t).pipe(Bt(s=>(console.log("update handle error",{updateId:r.update_id,updateKey:Object.keys(r).at(1),name:s._tag,...s.cause instanceof Error?{error:s.cause.message}:void 0}),g(s)))),{concurrency:10}).pipe(H(r=>(n.log_level=="debug"&&console.debug("handle batch result",r),new Vt({hasErrors:!r.every(s=>s==null),updates:e})))),wi=(e,t)=>Y(function*(){let n=_i(e);if(!n)return yield*U(new Ze({name:"UnknownUpdate",update:e}));let r=t[`on_${n.type}`];if(!r)return yield*U(new Ze({name:"HandlerNotDefined",update:e}));n.type=="message"&&"text"in n&&console.info("Got a new text message",{chatId:n.chat.id,chatType:n.chat.type,message:`${n.text.slice(0,5)}...`});let s,o=yield*tr({try:()=>r(n),catch:c=>new Ze({name:"BotHandlerError",update:e,cause:c})}).pipe(H(c=>c instanceof Promise?qe({try:()=>c,catch:a=>new Ze({name:"BotHandlerError",update:e,cause:a})}):g(c)),Bt(c=>(s=c,console.log("error",{updateId:e.update_id,updateKey:Object.keys(e).at(1),name:c._tag,...c.cause instanceof Error?{error:c.cause.message}:void 0}),g(fi.make({type:"message",text:`Some internal error has happend(${c.name}) while handling this message`,message_effect_id:gi["ðŸ’©"],...e.message?.message_id?{reply_parameters:{message_id:e.message?.message_id}}:void 0}))))),i=yield*P(he);if(!o&&i.log_level=="debug"){console.log(`Bot response is undefined for update with ID #${e.update_id}.`);return}if("chat"in n&&o.response){let c=yield*Ut(`send_${o.response.type}`,{...o.response,chat_id:n.chat.id});i.log_level=="debug"&&console.debug("bot response",c)}return s}),vi=class extends re()("BotFetchUpdatesService",{defaultValue:()=>{let e={lastUpdateId:void 0,emptyResponses:0},t=Ei(e).pipe(Rt(r=>{let s=r.map(o=>o.update_id).sort().at(-1);console.log("updating last update id",s),e.lastUpdateId=s?s+1:void 0,console.log(e)})),n=Oi(e);return{state:e,fetchUpdates:t,commit:n}}}){},dr=class extends jt("FetchUpdatesError"){},Ei=e=>Y(function*(){let t=yield*P(he);if(t.max_empty_responses&&e.emptyResponses==t.max_empty_responses)return yield*U(new dr({name:"TooManyEmptyResponses"}));let n=e.lastUpdateId;t.log_level=="debug"&&console.debug("getting updates",e);let r=yield*Ut("get_updates",{timeout:t.poll_timeout,...n?{offset:n}:void 0}).pipe(H(s=>s.sort(o=>o.update_id)));return r.length?(console.debug(`got a batch of updates (${r.length})`),e.emptyResponses=0,r):(e.emptyResponses+=1,[])}),Oi=e=>Y(function*(){return console.log("commit",{pollState:e}),e.lastUpdateId?yield*Ut("get_updates",{offset:e.lastUpdateId,limit:0}).pipe(H(H(P(he),t=>{t.log_level=="debug"&&console.debug("committed offset",e)}))):yield*U(new dr({name:"NoUpdatesToCommit"}))}),Ii=class extends re()("BotRunService",{defaultValue:()=>{console.log("Initiating BotRunService");let e={fiber:void 0};return{runBotInBackground:Ci(e),getFiber:()=>e.fiber}}}){},Ci=e=>Y(function*(){console.log("running telegram chat bot");let t=yield*P(vi),n=yield*P(he),r=o=>n.on_error=="continue"?!0:!o,s=ti(1e3)(t.fetchUpdates.pipe(H(bi),Rt(o=>o.updates.length>0&&r(o.hasErrors)?t.commit:We))).pipe(Yo({while:o=>r(o.hasErrors)}),ci,Rt(o=>o.addObserver(i=>{console.log("bot's fiber has been closed",i)})));e.fiber&&(console.log("killing previous bot's fiber"),yield*xo(e.fiber)),e.fiber=yield*s,console.log("Fetching bot updates via long polling...")}),Ni=e=>Y(function*(){let t=yield*P(Ii),n=gs(fr,e.bot_token);return yield*t.runBotInBackground.pipe(Lt(Ht,e.mode),Lt(he,hr.make(e.poll??{})),ir(n)),{reload:r=>t.runBotInBackground.pipe(Lt(Ht,r),ir(n),lr),fiber:t.getFiber}}),Mi=e=>Ni(e).pipe(lr);const $i=e=>typeof e=="object"&&e!=null&&"command"in e&&"token"in e&&"code"in e,Ti="0.6.2",et="@effect-ak/tg-bot-client",pr="mjs",Oe="https://cdn.jsdelivr.net/npm",Ie=`${et}@${Ti}/dist`,Ai=[{entryName:"index",packageName:et,dts_url:`${Oe}/${Ie}/index.d.ts`,js_url:`${Oe}/${Ie}/index.${pr}`},{entryName:"bot",packageName:et,dts_url:`${Oe}/${Ie}/bot.d.ts`,js_url:`${Oe}/${Ie}/bot-bundle.${pr}`},{entryName:"config-BFdBOrJI",packageName:et,dts_url:`${Oe}/${Ie}/config-BFdBOrJI.d.ts`}];async function ji(e){const t=xi(e);console.log("prepared code",t);const n=new Blob([t],{type:"application/javascript"}),r=URL.createObjectURL(n);try{const s=await import(r);return s.default?s.default:void 0}catch(s){console.log("Can't load handlers",s);return}finally{URL.revokeObjectURL(r)}}function xi(e){let t=e;for(const{js_url:n,packageName:r,entryName:s}of Object.values(Ai))!r||!n||!s||(t=t.replaceAll(r+"/"+s,n));return t}const Pi=Ri();self.onmessage=e=>Pi(e.data);function Ri(){let e=0,t;console.log("creating web worker");const n=s=>self.postMessage({type:"from-worker",data:s,message_id:e++}),r=async s=>{const o=await ji(s.code);if(!o){n({error:"handlers doesn't return default",command:s});return}if(console.log("worker got run-bot command"),t){await t.reload({type:"single",...o}),n({newBotState:"reloaded"});return}t=await Mi({bot_token:s.token,poll:{on_error:"continue"},mode:{type:"single",...o}}),t.fiber()?.addObserver(i=>{n({success:"Bot's fiber has been shutdown",exit:i,newBotState:"stopped"})}),n({success:"Bot's fiber has been created",newBotState:"active"})};return async s=>{if(!$i(s)){n({error:"not a run bot command",command:s});return}await r(s)}}})();
